import{j as e,_ as u,g as F,a9 as S,aa as L,ab as E}from"./chunk-CDfVSsCp.js";import{a as l}from"./chunk-pjYta8vt.js";import{A as R,B as p,C as g,f,g as B,h as P,i as V,j as K,T as O,l as j}from"./index-CjGPc2b_.js";import{B as z,D as H,e as W,f as X,g as Y}from"./chunk-2Vqr1Avx.js";import q from"./TaskCreationForm-B8jsWt0K.js";import{R as U,L as $,X as G,Y as I,T as J,a as w}from"./chunk-TEwzFl3b.js";import{f as y}from"./chunk-DGzW4aIb.js";import"./chunk-KzYfAQy1.js";import"./chunk-BRoLf8OO.js";import"./chunk-D56rD7Tk.js";import"./chunk-BdHZTqfh.js";import"./chunk-DqGcurv-.js";function me(){const{tasks:m,refreshAll:N}=l.useContext(R),[Q,v]=l.useState([]),[k,C]=l.useState([]),[D,n]=l.useState(!1);l.useEffect(()=>{const a=Array.isArray(m)?m:[];v(a);const t=a.filter(s=>s.type==="metric");C(t)},[m]);const T=async()=>{try{await N()}catch(a){j.error("Failed to refresh tasks (metrics)",{error:String(a)})}},b=async a=>{if(!a){n(!1);return}try{await O.create({...a,type:"metric"}),await T(),n(!1)}catch(t){j.error("Failed to create metric",{error:String(t)})}},h=k.reduce((a,t)=>{const s=t.metadata?.metric?.kpi_name;return s&&(a[s]||(a[s]=[]),a[s].push(t)),a},{}),_=a=>{if(!a||a.length<2)return{trend:"neutral",percentage:0};const t=[...a].sort((x,A)=>new Date(x.created_date)-new Date(A.created_date)),s=t[t.length-1],d=t[t.length-2],r=parseFloat(s.metadata?.metric?.current_value)||0,i=parseFloat(d.metadata?.metric?.current_value)||0;if(r===i)return{trend:"neutral",percentage:0};const c=r-i,o=i!==0?Math.abs(Math.round(c/i*100)):0;return{trend:c>0?"up":"down",percentage:o}},M=a=>a.filter(t=>t.metadata?.metric?.current_value).map(t=>({date:y(new Date(t.created_date),"MMM dd"),value:parseFloat(t.metadata?.metric?.current_value)||0,target:parseFloat(t.metadata?.metric?.target_value)||void 0})).sort((t,s)=>new Date(t.date)-new Date(s.date));return e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Metrics Dashboard"}),e.jsxs(p,{onClick:()=>n(!0),children:[e.jsx(u,{className:"h-4 w-4 mr-2"}),"Track New Metric"]})]}),Object.keys(h).length===0?e.jsx(g,{className:"bg-gray-50 border-dashed",children:e.jsxs(f,{className:"flex flex-col items-center justify-center h-64",children:[e.jsx(F,{className:"h-12 w-12 text-gray-400 mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-600 mb-2",children:"No metrics being tracked"}),e.jsx("p",{className:"text-gray-500 text-center mb-4",children:"Start tracking your key product metrics to monitor performance"}),e.jsxs(p,{onClick:()=>n(!0),children:[e.jsx(u,{className:"h-4 w-4 mr-2"}),"Add First Metric"]})]})}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:Object.entries(h).map(([a,t])=>{const s=_(t),d=M(t),r=t.sort((o,x)=>new Date(x.created_date)-new Date(o.created_date))[0],i=r.metadata?.metric?.current_value,c=r.metadata?.metric?.target_value;return e.jsxs(g,{className:"overflow-hidden",children:[e.jsx(B,{className:"pb-2",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx(P,{children:a}),e.jsx(V,{children:r.metadata?.metric?.measurement_frequency||"Tracked periodically"})]}),e.jsxs(z,{variant:"outline",children:[t.length," updates"]})]})}),e.jsxs(f,{className:"pb-0",children:[e.jsxs("div",{className:"flex items-baseline justify-between",children:[e.jsx("div",{className:"text-2xl font-bold",children:i}),s.percentage>0&&e.jsxs("div",{className:`flex items-center ${s.trend==="up"?"text-green-600":"text-red-600"}`,children:[s.trend==="up"?e.jsx(S,{className:"h-4 w-4 mr-1"}):e.jsx(L,{className:"h-4 w-4 mr-1"}),s.percentage,"%"]})]}),c&&e.jsxs("div",{className:"flex items-center mt-1",children:[e.jsx(E,{className:"h-3 w-3 mr-1 text-gray-400"}),e.jsxs("span",{className:"text-sm text-gray-500",children:["Target: ",c]})]}),e.jsx("div",{className:"h-36 mt-4",children:e.jsx(U,{width:"100%",height:"100%",children:e.jsxs($,{data:d,children:[e.jsx(G,{dataKey:"date",tick:{fontSize:12},tickLine:!1,axisLine:!1}),e.jsx(I,{tick:{fontSize:12},tickLine:!1,axisLine:!1,width:30}),e.jsx(J,{}),e.jsx(w,{type:"monotone",dataKey:"value",stroke:"#6366F1",strokeWidth:2,dot:{r:3},activeDot:{r:5}}),d.some(o=>o.target!==void 0)&&e.jsx(w,{type:"monotone",dataKey:"target",stroke:"#E5E7EB",strokeWidth:1,strokeDasharray:"4 4",dot:!1})]})})})]}),e.jsx(K,{className:"pt-4",children:e.jsxs("div",{className:"text-xs text-gray-500",children:["Last updated: ",y(new Date(r.created_date),"PPp")]})})]},a)})}),e.jsx(H,{open:D,onOpenChange:n,children:e.jsxs(W,{className:"sm:max-w-lg max-h-[90vh] overflow-y-auto",children:[e.jsx(X,{children:e.jsx(Y,{children:"Track New Metric"})}),e.jsx(q,{onCreateTask:b,initialTaskData:{status:"todo",priority:"medium",type:"metric",metadata:{metric:{}}}})]})})]})})}export{me as default};
