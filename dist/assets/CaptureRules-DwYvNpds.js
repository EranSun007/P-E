import{j as e,v as le,T as A,az as U,bR as ne,L as W,aU as ie,q as z,w as ce,N as de,p as M,bP as oe,bS as ue,bT as me,b0 as xe}from"./chunk-WPKCbDK8.js";import{a as l}from"./chunk-BKwDNIOR.js";import{a as B,c as H,L as u,I as D,B as m,a3 as k,C as G,h as he,i as pe,j as O}from"./index-CnhOL4vI.js";import{B as q}from"./chunk-DIYexMSd.js";import{S as X}from"./chunk-Cwx6QR2c.js";import{T as fe,a as je,b as J,c as T,d as be,e as R}from"./chunk-qi7vZLzc.js";import{D as Z,a as K,b as ee,c as te,e as ae,d as se}from"./chunk-D8_EjMoV.js";import{E as ge}from"./chunk-PTkjzjTs.js";import{S as V,a as Y,b as $,c as Q,d as P}from"./chunk-BOs1hDSJ.js";import{C as ye}from"./chunk-233bsYkc.js";import{b as Ne}from"./chunk-DGs6foQ1.js";import"./chunk-BwuEqr1N.js";const ve={jenkins:{name:"Jenkins Build Status",url_pattern:"*jenkins*",description:"Extract build status from Jenkins job pages",selectors:[{field_name:"job_name",selector:"#main-panel h1",type:"text",required:!0},{field_name:"build_status",selector:"#buildHistory .build-row:first-child .build-status-icon__wrapper",type:"attribute",attribute:"title",required:!0},{field_name:"build_number",selector:"#buildHistory .build-row:first-child .build-link",type:"text",required:!1},{field_name:"build_url",selector:"#buildHistory .build-row:first-child .build-link",type:"href",required:!1}]},grafana:{name:"Grafana Dashboard",url_pattern:"*grafana*",description:"Extract dashboard info from Grafana",selectors:[{field_name:"dashboard_title",selector:'[data-testid="data-testid dashboard-scene-title"], .navbar-page-btn',type:"text",required:!0},{field_name:"dashboard_url",selector:'link[rel="canonical"]',type:"href",required:!1}]},concourse:{name:"Concourse Pipeline",url_pattern:"*concourse*",description:"Extract pipeline status from Concourse CI",selectors:[{field_name:"pipeline_name",selector:".pipeline-name, [data-pipeline-name]",type:"text",required:!0},{field_name:"job_name",selector:".job-name, .build-header__job-name",type:"text",required:!1},{field_name:"build_status",selector:'.build-header, [class*="status"]',type:"attribute",attribute:"class",required:!1},{field_name:"build_number",selector:".build-header__build-name, .build-number",type:"text",required:!1}]},dynatrace:{name:"Dynatrace Problem",url_pattern:"*dynatrace*",description:"Extract problem details from Dynatrace",selectors:[{field_name:"problem_title",selector:'[data-testid="problem-title"], .problem-title',type:"text",required:!0},{field_name:"severity",selector:'[data-testid="problem-severity"], .severity',type:"text",required:!1},{field_name:"affected_entities",selector:'[data-testid="affected-entities"], .affected-entity-count',type:"text",required:!1},{field_name:"status",selector:'[data-testid="problem-status"], .problem-status',type:"text",required:!1}]}},_e=[{value:"jenkins",label:"Jenkins Build Status"},{value:"grafana",label:"Grafana Dashboard"},{value:"concourse",label:"Concourse Pipeline"},{value:"dynatrace",label:"Dynatrace Problem"}],Ce=[{value:"text",label:"Text Content"},{value:"html",label:"HTML"},{value:"attribute",label:"Attribute"},{value:"href",label:"Link (href)"},{value:"src",label:"Source (src)"}];function we({open:f,onOpenChange:v,rule:c,onSave:_}){const[n,x]=l.useState({name:"",url_pattern:"",enabled:!0}),[r,j]=l.useState([]),[s,h]=l.useState({field_name:"",selector:"",type:"text",attribute:"",required:!1}),[p,C]=l.useState(!1),[b,d]=l.useState(null);l.useEffect(()=>{f&&(c?(x({name:c.name||"",url_pattern:c.url_pattern||"",enabled:c.enabled??!0}),j(Array.isArray(c.selectors)?c.selectors:[])):(x({name:"",url_pattern:"",enabled:!0}),j([])),h({field_name:"",selector:"",type:"text",attribute:"",required:!1}),d(null))},[c,f]);const F=t=>{if(!t||t==="none")return;const i=ve[t];i&&(x({name:i.name,url_pattern:i.url_pattern,enabled:!0}),j([...i.selectors]))},w=()=>{if(!s.field_name.trim()){d("Field name is required");return}if(!s.selector.trim()){d("CSS selector is required");return}if(s.type==="attribute"&&!s.attribute.trim()){d('Attribute name is required for type "attribute"');return}const t={field_name:s.field_name.trim(),selector:s.selector.trim(),type:s.type,required:s.required};s.type==="attribute"&&(t.attribute=s.attribute.trim()),j([...r,t]),h({field_name:"",selector:"",type:"text",attribute:"",required:!1}),d(null)},E=t=>{j(r.filter((i,y)=>y!==t))},S=(t,i)=>{x(y=>({...y,[t]:i}))},g=(t,i)=>{h(y=>({...y,[t]:i}))},L=async()=>{if(d(null),!n.name.trim()){d("Rule name is required");return}if(!n.url_pattern.trim()){d("URL pattern is required");return}if(r.length===0){d("At least one selector is required");return}C(!0);try{const t={...n,name:n.name.trim(),url_pattern:n.url_pattern.trim(),selectors:r};await _(t),v(!1)}catch(t){d(t.message||"Failed to save rule")}finally{C(!1)}};return e.jsx(Z,{open:f,onOpenChange:v,children:e.jsxs(K,{className:"max-w-2xl max-h-[90vh] overflow-y-auto",children:[e.jsxs(ee,{children:[e.jsxs(te,{children:[c?"Edit":"Create"," Capture Rule"]}),e.jsx(ae,{children:"Define a URL pattern and CSS selectors to extract data from matching pages."})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[b&&e.jsxs(B,{variant:"destructive",children:[e.jsx(le,{className:"h-4 w-4"}),e.jsx(H,{children:b})]}),!c&&e.jsxs("div",{className:"space-y-2 mb-4 p-3 bg-blue-50 rounded-lg border border-blue-100",children:[e.jsx(u,{className:"text-sm font-medium text-blue-800",children:"Start from Template (Optional)"}),e.jsxs(V,{onValueChange:F,children:[e.jsx(Y,{className:"bg-white",children:e.jsx($,{placeholder:"Select a preset template..."})}),e.jsxs(Q,{children:[e.jsx(P,{value:"none",children:"No template"}),_e.map(t=>e.jsx(P,{value:t.value,children:t.label},t.value))]})]}),e.jsx("p",{className:"text-xs text-blue-600",children:"Templates provide starting selectors. Customize them for your specific site."})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"name",children:"Rule Name"}),e.jsx(D,{id:"name",value:n.name,onChange:t=>S("name",t.target.value),placeholder:"e.g., Grafana Build Status"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"url_pattern",children:"URL Pattern (glob)"}),e.jsx(D,{id:"url_pattern",value:n.url_pattern,onChange:t=>S("url_pattern",t.target.value),placeholder:"e.g., *grafana.sap/* or *jenkins.io/job/*"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Use * as wildcard. Example: *grafana.sap/* matches any page on grafana.sap domain."})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(u,{htmlFor:"enabled",children:"Enabled"}),e.jsx(X,{id:"enabled",checked:n.enabled,onCheckedChange:t=>S("enabled",t)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(u,{children:["Selectors (",r.length,")"]}),r.length===0?e.jsx("p",{className:"text-sm text-muted-foreground",children:"No selectors added yet."}):e.jsx("div",{className:"space-y-2",children:r.map((t,i)=>e.jsxs("div",{className:"flex items-start gap-2 p-3 border rounded-md bg-muted/50",children:[e.jsxs("div",{className:"flex-1 space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium text-sm",children:t.field_name}),e.jsx(q,{variant:"outline",children:t.type}),t.required&&e.jsx(q,{variant:"secondary",className:"text-xs",children:"Required"})]}),e.jsx("p",{className:"text-xs text-muted-foreground font-mono",children:t.selector}),t.type==="attribute"&&t.attribute&&e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Attribute: ",e.jsx("span",{className:"font-mono",children:t.attribute})]})]}),e.jsx(m,{type:"button",variant:"ghost",size:"sm",onClick:()=>E(i),children:e.jsx(A,{className:"h-4 w-4"})})]},i))})]}),e.jsxs("div",{className:"space-y-3 p-4 border rounded-md bg-background",children:[e.jsx(u,{className:"text-base",children:"Add Selector"}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"new_field_name",className:"text-xs",children:"Field Name"}),e.jsx(D,{id:"new_field_name",value:s.field_name,onChange:t=>g("field_name",t.target.value),placeholder:"e.g., build_status"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"new_type",className:"text-xs",children:"Type"}),e.jsxs(V,{value:s.type,onValueChange:t=>g("type",t),children:[e.jsx(Y,{id:"new_type",children:e.jsx($,{})}),e.jsx(Q,{children:Ce.map(t=>e.jsx(P,{value:t.value,children:t.label},t.value))})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"new_selector",className:"text-xs",children:"CSS Selector"}),e.jsx(D,{id:"new_selector",value:s.selector,onChange:t=>g("selector",t.target.value),placeholder:"e.g., .build-row .status",className:"font-mono text-xs"}),e.jsx("p",{className:"text-xs text-gray-500",children:'CSS selector (e.g., ".class", "#id", "[data-attr]")'})]}),s.type==="attribute"&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{htmlFor:"new_attribute",className:"text-xs",children:"Attribute Name"}),e.jsx(D,{id:"new_attribute",value:s.attribute,onChange:t=>g("attribute",t.target.value),placeholder:"e.g., data-status",className:"font-mono text-xs"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ye,{id:"new_required",checked:s.required,onCheckedChange:t=>g("required",t)}),e.jsx(u,{htmlFor:"new_required",className:"text-xs cursor-pointer",children:"Required (validation will fail if not found)"})]}),e.jsxs(m,{type:"button",onClick:w,size:"sm",className:"w-full",children:[e.jsx(U,{className:"h-4 w-4 mr-2"}),"Add Selector"]})]}),e.jsxs(B,{className:"bg-amber-50 border-amber-200",children:[e.jsx(ne,{className:"h-4 w-4 text-amber-600"}),e.jsxs(H,{className:"text-amber-800 text-sm",children:[e.jsx("strong",{children:"To test your selectors:"}),e.jsxs("ol",{className:"list-decimal ml-4 mt-1 space-y-1",children:[e.jsx("li",{children:"Save this rule first"}),e.jsx("li",{children:"Navigate to a page matching the URL pattern"}),e.jsx("li",{children:"Click the P&E extension icon"}),e.jsx("li",{children:'Click "Capture This Page" to test extraction'}),e.jsx("li",{children:"Check Capture Inbox for results"})]})]})]})]}),e.jsxs(se,{children:[e.jsx(m,{type:"button",variant:"outline",onClick:()=>v(!1),disabled:p,children:"Cancel"}),e.jsxs(m,{onClick:L,disabled:p,children:[p&&e.jsx(W,{className:"h-4 w-4 mr-2 animate-spin"}),e.jsx(ie,{className:"h-4 w-4 mr-2"}),c?"Update":"Create"," Rule"]})]})]})})}function Be(){const[f,v]=l.useState(!0),[c,_]=l.useState(null),[n,x]=l.useState([]),[r,j]=l.useState(""),[s,h]=l.useState(!1),[p,C]=l.useState(null),[b,d]=l.useState(null),[F,w]=l.useState(!1);l.useEffect(()=>{E()},[]);const E=async()=>{v(!0),_(null);try{const a=await k.list();x(a||[])}catch(a){console.error("Failed to load capture rules:",a),_(a.message||"Failed to load capture rules")}finally{v(!1)}},S=()=>{C(null),h(!0)},g=a=>{C(a),h(!0)},L=async a=>{try{if(p){const o=await k.update(p.id,a);x(n.map(N=>N.id===p.id?o:N))}else{const o=await k.create(a);x([...n,o])}h(!1),C(null)}catch(o){throw console.error("Failed to save rule:",o),o}},t=async a=>{try{const o=await k.update(a.id,{enabled:!a.enabled});x(n.map(N=>N.id===a.id?o:N))}catch(o){console.error("Failed to update rule:",o),_("Failed to update rule status")}},i=a=>{d(a),w(!0)},y=async()=>{if(b)try{await k.delete(b.id),x(n.filter(a=>a.id!==b.id)),w(!1),d(null)}catch(a){console.error("Failed to delete rule:",a),_("Failed to delete rule")}},I=n.filter(a=>{if(!r)return!0;const o=r.toLowerCase(),N=a.name?.toLowerCase().includes(o),re=a.url_pattern?.toLowerCase().includes(o);return N||re});return e.jsxs("div",{className:"p-8 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[e.jsx(z,{className:"h-8 w-8"}),"Capture Rules"]}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Define URL patterns and CSS selectors to extract data from web pages"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(m,{variant:"outline",onClick:E,disabled:f,children:[e.jsx(ce,{className:`h-4 w-4 mr-2 ${f?"animate-spin":""}`}),"Refresh"]}),e.jsxs(m,{onClick:S,children:[e.jsx(U,{className:"h-4 w-4 mr-2"}),"Add Rule"]})]})]}),c&&e.jsxs(B,{variant:"destructive",children:[e.jsx(de,{className:"h-4 w-4"}),e.jsx(H,{children:c})]}),e.jsxs(G,{children:[e.jsx(he,{children:e.jsxs(pe,{className:"text-lg flex items-center gap-2",children:[e.jsx(M,{className:"h-5 w-5"}),"Search Rules"]})}),e.jsx(O,{children:e.jsx(D,{placeholder:"Search by name or URL pattern...",value:r,onChange:a=>j(a.target.value),className:"max-w-md"})})]}),e.jsx(G,{children:e.jsx(O,{className:"p-0",children:f?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(W,{className:"h-8 w-8 animate-spin text-muted-foreground"})}):I.length===0?e.jsx(ge,{icon:r?M:z,title:r?"No rules found":"No capture rules yet",description:r?"Try adjusting your search terms":"Create your first capture rule to start extracting data from web pages",action:!r&&e.jsxs(m,{onClick:S,children:[e.jsx(U,{className:"h-4 w-4 mr-2"}),"Create First Rule"]})}):e.jsxs(fe,{children:[e.jsx(je,{children:e.jsxs(J,{children:[e.jsx(T,{children:"Name"}),e.jsx(T,{children:"URL Pattern"}),e.jsx(T,{className:"text-center",children:"Selectors"}),e.jsx(T,{className:"text-center",children:"Status"}),e.jsx(T,{children:"Created"}),e.jsx(T,{className:"text-right",children:"Actions"})]})}),e.jsx(be,{children:I.map(a=>e.jsxs(J,{children:[e.jsx(R,{className:"font-medium",children:a.name}),e.jsx(R,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("code",{className:"text-xs bg-muted px-2 py-1 rounded",children:a.url_pattern})]})}),e.jsx(R,{className:"text-center",children:e.jsxs(q,{variant:"outline",children:[a.selectors?.length||0," selector",a.selectors?.length!==1?"s":""]})}),e.jsx(R,{className:"text-center",children:e.jsx("div",{className:"flex items-center justify-center gap-2",children:a.enabled?e.jsxs(e.Fragment,{children:[e.jsx(ue,{className:"h-4 w-4 text-green-600"}),e.jsx(q,{variant:"default",className:"bg-green-600",children:"Enabled"})]}):e.jsxs(e.Fragment,{children:[e.jsx(me,{className:"h-4 w-4 text-gray-400"}),e.jsx(q,{variant:"secondary",children:"Disabled"})]})})}),e.jsx(R,{className:"text-sm text-muted-foreground",children:a.created_date?Ne(new Date(a.created_date),"MMM d, yyyy"):"â€”"}),e.jsx(R,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-2",children:[e.jsx(X,{checked:a.enabled,onCheckedChange:()=>t(a),title:a.enabled?"Disable rule":"Enable rule"}),e.jsx(m,{variant:"ghost",size:"sm",onClick:()=>g(a),children:e.jsx(xe,{className:"h-4 w-4"})}),e.jsx(m,{variant:"ghost",size:"sm",onClick:()=>i(a),children:e.jsx(A,{className:"h-4 w-4 text-destructive"})})]})})]},a.id))})]})})}),e.jsx(we,{open:s,onOpenChange:h,rule:p,onSave:L}),e.jsx(Z,{open:F,onOpenChange:w,children:e.jsxs(K,{className:"sm:max-w-md",children:[e.jsxs(ee,{children:[e.jsx(te,{children:"Confirm Deletion"}),e.jsxs(ae,{children:['Are you sure you want to delete "',b?.name,'"? This action cannot be undone.']})]}),e.jsxs(se,{className:"mt-4",children:[e.jsx(m,{variant:"outline",onClick:()=>w(!1),children:"Cancel"}),e.jsxs(m,{variant:"destructive",onClick:y,children:[e.jsx(A,{className:"h-4 w-4 mr-2"}),"Delete"]})]})]})})]})}export{Be as default};
