import{j as e,k as P,r as _,ap as I,aC as G,m as W,n as X,aD as Y,ar as U,G as J,aE as Q,aF as Z,aG as ee}from"./chunk-BlD_ekKQ.js";import{a as r,d as V}from"./chunk-BKwDNIOR.js";import{k as se,l as E,C as j,h as v,j as g,i as C,B as D,m as F,A as ae,u as te,n as re,T as ne}from"./index-BPpXP9wP.js";import{b as B}from"./chunk-NOAukTlf.js";import{B as k,D as ce,a as le,b as ie,c as de}from"./chunk-CmitwiBI.js";import oe from"./TaskCreationForm-Prd0TgOH.js";import{S as xe,a as me,b as he,c as ue,d as L}from"./chunk-DBni0BOz.js";import{C as je,a as ge,b as pe}from"./chunk-A9iCQE3I.js";import{R as q,P as fe,a as Ne,C as ye,T as z,L as ve,X as we,Y as be,b as K}from"./chunk-Ct3-qmTO.js";import{b as $}from"./chunk-P_BNsj9B.js";import"./chunk-KzYfAQy1.js";import"./chunk-D12Apl6f.js";import"./chunk-BdHZTqfh.js";import"./chunk-B-ktFKGP.js";const A={onTrack:"#22c55e",overdue:"#ef4444",excluded:"#9ca3af"};function Ce(){const[o,T]=r.useState(null),[R,w]=r.useState(!0),[x,b]=r.useState(null),[p,m]=r.useState("30"),[f,S]=r.useState(!1);r.useEffect(()=>{l()},[p]);const l=async()=>{try{w(!0),b(null);const s=await se.metrics.getOneOnOneCompliance(parseInt(p,10));T(s)}catch(s){E.error("Failed to load 1:1 compliance",{error:String(s)}),b("Failed to load compliance data")}finally{w(!1)}};if(R)return e.jsxs(j,{className:"animate-pulse",children:[e.jsxs(v,{className:"pb-2",children:[e.jsx("div",{className:"h-6 bg-gray-200 rounded w-48"}),e.jsx("div",{className:"h-4 bg-gray-100 rounded w-32 mt-2"})]}),e.jsx(g,{children:e.jsx("div",{className:"h-32 bg-gray-100 rounded"})})]});if(x)return e.jsxs(j,{className:"border-red-200 bg-red-50",children:[e.jsx(v,{className:"pb-2",children:e.jsxs(C,{className:"flex items-center gap-2 text-red-700",children:[e.jsx(P,{className:"h-5 w-5"}),"1:1 Compliance"]})}),e.jsxs(g,{children:[e.jsx("p",{className:"text-red-600",children:x}),e.jsx(D,{variant:"outline",size:"sm",className:"mt-2",onClick:l,children:"Retry"})]})]});if(!o||o.summary.total===0)return e.jsxs(j,{className:"bg-gray-50 border-dashed",children:[e.jsxs(v,{className:"pb-2",children:[e.jsxs(C,{className:"flex items-center gap-2",children:[e.jsx(_,{className:"h-5 w-5"}),"1:1 Compliance"]}),e.jsx(F,{children:"Track meeting frequency by role"})]}),e.jsxs(g,{className:"flex flex-col items-center justify-center py-8",children:[e.jsx(_,{className:"h-10 w-10 text-gray-400 mb-3"}),e.jsx("p",{className:"text-gray-500 text-center",children:"No team members to track"})]})]});const{summary:n,members:M}=o,h=[{name:"On Track",value:n.onTrack,color:A.onTrack},{name:"Overdue",value:n.overdue,color:A.overdue},{name:"Excluded",value:n.excluded,color:A.excluded}].filter(s=>s.value>0),i=s=>s>=80?"text-green-600":s>=50?"text-yellow-600":"text-red-600",a=s=>{switch(s){case"on_track":return e.jsx(k,{className:"bg-green-100 text-green-700 border-green-200",children:"On Track"});case"overdue":return e.jsx(k,{className:"bg-red-100 text-red-700 border-red-200",children:"Overdue"});case"excluded":return e.jsx(k,{className:"bg-gray-100 text-gray-600 border-gray-200",children:"On Leave"});default:return null}};return e.jsxs(j,{children:[e.jsx(v,{className:"pb-2",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsxs(C,{className:"flex items-center gap-2",children:[e.jsx(_,{className:"h-5 w-5"}),"1:1 Compliance"]}),e.jsx(F,{children:"Meeting frequency by role cadence"})]}),e.jsxs(xe,{value:p,onValueChange:m,children:[e.jsx(me,{className:"w-[100px]",children:e.jsx(he,{})}),e.jsxs(ue,{children:[e.jsx(L,{value:"30",children:"30 days"}),e.jsx(L,{value:"60",children:"60 days"}),e.jsx(L,{value:"90",children:"90 days"})]})]})]})}),e.jsxs(g,{className:"pb-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:`text-3xl font-bold ${i(n.compliancePercent)}`,children:[n.compliancePercent,"%"]}),e.jsx("div",{className:"text-xs text-gray-500",children:"Compliance"})]}),e.jsx("div",{className:"h-24 w-24",children:e.jsx(q,{width:"100%",height:"100%",children:e.jsxs(fe,{children:[e.jsx(Ne,{data:h,dataKey:"value",nameKey:"name",cx:"50%",cy:"50%",innerRadius:25,outerRadius:40,paddingAngle:2,children:h.map((s,t)=>e.jsx(ye,{fill:s.color},`cell-${t}`))}),e.jsx(z,{formatter:(s,t)=>[`${s} members`,t]})]})})})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-2 text-center mb-4",children:[e.jsxs("div",{className:"p-2 bg-green-50 rounded",children:[e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx(I,{className:"h-4 w-4 text-green-600"}),e.jsx("span",{className:"font-semibold text-green-700",children:n.onTrack})]}),e.jsx("div",{className:"text-xs text-green-600",children:"On Track"})]}),e.jsxs("div",{className:"p-2 bg-red-50 rounded",children:[e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx(P,{className:"h-4 w-4 text-red-600"}),e.jsx("span",{className:"font-semibold text-red-700",children:n.overdue})]}),e.jsx("div",{className:"text-xs text-red-600",children:"Overdue"})]}),e.jsxs("div",{className:"p-2 bg-gray-50 rounded",children:[e.jsxs("div",{className:"flex items-center justify-center gap-1",children:[e.jsx(G,{className:"h-4 w-4 text-gray-500"}),e.jsx("span",{className:"font-semibold text-gray-600",children:n.excluded})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"On Leave"})]})]}),e.jsxs(je,{open:f,onOpenChange:S,children:[e.jsx(ge,{asChild:!0,children:e.jsxs(D,{variant:"ghost",className:"w-full flex items-center justify-between p-2",children:[e.jsxs("span",{className:"text-sm text-gray-600",children:[f?"Hide":"Show"," member details"]}),f?e.jsx(W,{className:"h-4 w-4"}):e.jsx(X,{className:"h-4 w-4"})]})}),e.jsx(pe,{className:"space-y-2 pt-2",children:M.map(s=>e.jsxs("div",{className:`p-3 rounded-lg border ${s.status==="overdue"?"bg-red-50 border-red-100":s.status==="excluded"?"bg-gray-50 border-gray-100":"bg-green-50 border-green-100"}`,children:[e.jsxs("div",{className:"flex justify-between items-start mb-1",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:s.name}),e.jsx("div",{className:"text-xs text-gray-500",children:s.role})]}),a(s.status)]}),s.status!=="excluded"&&e.jsxs("div",{className:"flex items-center gap-2 mt-2 text-xs text-gray-600",children:[e.jsx(Y,{className:"h-3 w-3"}),s.lastMeetingDate?e.jsxs("span",{children:["Last: ",s.lastMeetingDate,s.daysSinceLastMeeting!==null&&e.jsxs("span",{className:"ml-1",children:["(",s.daysSinceLastMeeting," days ago)"]})]}):e.jsx("span",{className:"text-red-600",children:"No 1:1 recorded"}),e.jsx("span",{className:"text-gray-400",children:"|"}),e.jsxs("span",{children:["Cadence: ",s.cadenceDays," days"]})]}),s.daysUntilDue!==null&&s.status!=="excluded"&&e.jsx("div",{className:"text-xs mt-1",children:s.daysUntilDue>0?e.jsxs("span",{className:"text-green-600",children:["Due in ",s.daysUntilDue," days"]}):e.jsxs("span",{className:"text-red-600",children:["Overdue by ",Math.abs(s.daysUntilDue)," days"]})})]},s.id))})]})]})]})}function Ve(){const{tasks:o,refreshAll:T}=r.useContext(ae),[R,w]=r.useState([]),[x,b]=r.useState([]),[p,m]=r.useState(!1);r.useEffect(()=>{const a=Array.isArray(o)?o:[];w(a);const s=a.filter(t=>t.type==="metric");b(s)},[o]);const f=async()=>{try{await T()}catch(a){E.error("Failed to refresh tasks (metrics)",{error:String(a)})}},S=async a=>{if(!a){m(!1);return}try{await ne.create({...a,type:"metric"}),await f(),m(!1)}catch(s){E.error("Failed to create metric",{error:String(s)})}},l=V.useMemo(()=>x.reduce((a,s)=>{const t=s.metadata?.metric?.kpi_name;return t&&(a[t]||(a[t]=[]),a[t].push(s)),a},{}),[x]),n=a=>{if(!a||a.length<2)return{trend:"neutral",percentage:0};const s=[...a].sort((O,H)=>new Date(O.created_date)-new Date(H.created_date)),t=s[s.length-1],u=s[s.length-2],c=parseFloat(t.metadata?.metric?.current_value)||0,d=parseFloat(u.metadata?.metric?.current_value)||0;if(c===d)return{trend:"neutral",percentage:0};const N=c-d,y=d!==0?Math.abs(Math.round(N/d*100)):0;return{trend:N>0?"up":"down",percentage:y}},M=a=>a.filter(s=>s.metadata?.metric?.current_value).map(s=>({date:$(new Date(s.created_date),"MMM dd"),value:parseFloat(s.metadata?.metric?.current_value)||0,target:parseFloat(s.metadata?.metric?.target_value)||void 0})).sort((s,t)=>new Date(s.date)-new Date(t.date)),{updatePageContext:h}=te(),i=V.useMemo(()=>{const a=Object.keys(l);return{kpiCount:a.length,totalUpdates:x.length,kpis:a.map(s=>{const t=l[s],u=t.sort((c,d)=>new Date(d.created_date)-new Date(c.created_date))[0];return{name:s,currentValue:u?.metadata?.metric?.current_value,targetValue:u?.metadata?.metric?.target_value,updates:t.length}})}},[l,x]);return r.useEffect(()=>{const a=B(i);h({page:"/metrics",summary:a,selection:null,data:i})},[i,h]),r.useEffect(()=>{const a=()=>{const s=B(i);h({page:"/metrics",summary:s,selection:null,data:i})};return window.addEventListener("ai-context-refresh",a),()=>window.removeEventListener("ai-context-refresh",a)},[i,h]),e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Metrics Dashboard"}),e.jsxs(D,{onClick:()=>m(!0),children:[e.jsx(U,{className:"h-4 w-4 mr-2"}),"Track New Metric"]})]}),e.jsx("div",{className:"mb-6",children:e.jsx(Ce,{})}),Object.keys(l).length===0?e.jsx(j,{className:"bg-gray-50 border-dashed",children:e.jsxs(g,{className:"flex flex-col items-center justify-center h-64",children:[e.jsx(J,{className:"h-12 w-12 text-gray-400 mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-600 mb-2",children:"No metrics being tracked"}),e.jsx("p",{className:"text-gray-500 text-center mb-4",children:"Start tracking your key product metrics to monitor performance"}),e.jsxs(D,{onClick:()=>m(!0),children:[e.jsx(U,{className:"h-4 w-4 mr-2"}),"Add First Metric"]})]})}):e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6",children:Object.entries(l).map(([a,s])=>{const t=n(s),u=M(s),c=s.sort((y,O)=>new Date(O.created_date)-new Date(y.created_date))[0],d=c.metadata?.metric?.current_value,N=c.metadata?.metric?.target_value;return e.jsxs(j,{className:"overflow-hidden",children:[e.jsx(v,{className:"pb-2",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx(C,{children:a}),e.jsx(F,{children:c.metadata?.metric?.measurement_frequency||"Tracked periodically"})]}),e.jsxs(k,{variant:"outline",children:[s.length," updates"]})]})}),e.jsxs(g,{className:"pb-0",children:[e.jsxs("div",{className:"flex items-baseline justify-between",children:[e.jsx("div",{className:"text-2xl font-bold",children:d}),t.percentage>0&&e.jsxs("div",{className:`flex items-center ${t.trend==="up"?"text-green-600":"text-red-600"}`,children:[t.trend==="up"?e.jsx(Q,{className:"h-4 w-4 mr-1"}):e.jsx(Z,{className:"h-4 w-4 mr-1"}),t.percentage,"%"]})]}),N&&e.jsxs("div",{className:"flex items-center mt-1",children:[e.jsx(ee,{className:"h-3 w-3 mr-1 text-gray-400"}),e.jsxs("span",{className:"text-sm text-gray-500",children:["Target: ",N]})]}),e.jsx("div",{className:"h-36 mt-4",children:e.jsx(q,{width:"100%",height:"100%",children:e.jsxs(ve,{data:u,children:[e.jsx(we,{dataKey:"date",tick:{fontSize:12},tickLine:!1,axisLine:!1}),e.jsx(be,{tick:{fontSize:12},tickLine:!1,axisLine:!1,width:30}),e.jsx(z,{}),e.jsx(K,{type:"monotone",dataKey:"value",stroke:"#6366F1",strokeWidth:2,dot:{r:3},activeDot:{r:5}}),u.some(y=>y.target!==void 0)&&e.jsx(K,{type:"monotone",dataKey:"target",stroke:"#E5E7EB",strokeWidth:1,strokeDasharray:"4 4",dot:!1})]})})})]}),e.jsx(re,{className:"pt-4",children:e.jsxs("div",{className:"text-xs text-gray-500",children:["Last updated: ",$(new Date(c.created_date),"PPp")]})})]},a)})}),e.jsx(ce,{open:p,onOpenChange:m,children:e.jsxs(le,{className:"sm:max-w-lg max-h-[90vh] overflow-y-auto",children:[e.jsx(ie,{children:e.jsx(de,{children:"Track New Metric"})}),e.jsx(oe,{onCreateTask:S,initialTaskData:{status:"todo",priority:"medium",type:"metric",metadata:{metric:{}}}})]})})]})})}export{Ve as default};
