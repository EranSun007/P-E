import{j as e,U,aW as te,bA as ne,L as V,a0 as $,bd as ve,W as we,aQ as Se,aK as K,aw as Ce,r as _e,w as De,N as ke,bB as Me,D as Le,p as Te,av as Q,X as Pe}from"./chunk-WPKCbDK8.js";import{a as c}from"./chunk-BKwDNIOR.js";import{C as M,h as Fe,i as Ae,j as L,M as le,$ as J,a as re,c as ie,B as C,a0 as W,I as Je}from"./index-B5nMAt-E.js";import{T as Ee,a as Ie,b as X,c as G}from"./chunk-CqsX0BiM.js";import{B as h}from"./chunk-zVvAqB5a.js";import{D as ce,a as oe,b as de,c as me,e as Oe,d as Be}from"./chunk-g5LiUroS.js";import{S as xe,a as he,b as ge,c as ue,d as H}from"./chunk-CRMqQcWA.js";import{T as Ue,a as Ve,b as Y,c as P,d as He,e as F}from"./chunk-BxZBiOpp.js";import{D as Z,a as ee,b as se,c as ae}from"./chunk-CBOE_DJY.js";import"./chunk-DGs6foQ1.js";import"./chunk-BwuEqr1N.js";function Re({issues:a,mappings:N={},teamMembers:p=[]}){const j=c.useMemo(()=>{const n={};return a.forEach(o=>{const l=o.jira_assignee_id||"unassigned",i=o.assignee_name||"Unassigned";if(!n[l]){const _=N[l],r=_?p.find(f=>f.id===_.team_member_id):null;n[l]={assigneeId:l,assigneeName:i,teamMember:r,issues:[],totalPoints:0,byStatus:{todo:0,inProgress:0,done:0}}}n[l].issues.push(o),n[l].totalPoints+=parseFloat(o.story_points)||0;const m=(o.status||"").toLowerCase();m.includes("done")||m.includes("closed")?n[l].byStatus.done++:m.includes("progress")||m.includes("review")?n[l].byStatus.inProgress++:n[l].byStatus.todo++}),Object.values(n).sort((o,l)=>l.totalPoints-o.totalPoints)},[a,N,p]);return a.length===0?e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx(U,{className:"h-12 w-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"No issues to display workload"})]}):e.jsx("div",{className:"grid gap-4 md:grid-cols-2 lg:grid-cols-3",children:j.map(n=>e.jsxs(M,{children:[e.jsxs(Fe,{className:"pb-2",children:[e.jsxs(Ae,{className:"flex items-center justify-between text-base",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{className:"h-4 w-4 text-gray-400"}),e.jsx("span",{children:n.teamMember?.name||n.assigneeName})]}),e.jsxs(h,{variant:"secondary",className:"text-lg",children:[n.totalPoints," pts"]})]}),n.teamMember&&n.teamMember.name!==n.assigneeName&&e.jsxs("p",{className:"text-xs text-gray-400",children:["Jira: ",n.assigneeName]})]}),e.jsxs(L,{children:[e.jsxs("div",{className:"flex gap-2 mb-3 text-xs",children:[e.jsxs(h,{variant:"outline",className:"bg-gray-100",children:[n.byStatus.todo," To Do"]}),e.jsxs(h,{variant:"outline",className:"bg-blue-100 text-blue-800",children:[n.byStatus.inProgress," In Progress"]}),e.jsxs(h,{variant:"outline",className:"bg-green-100 text-green-800",children:[n.byStatus.done," Done"]})]}),e.jsxs("div",{className:"space-y-1 max-h-48 overflow-y-auto",children:[n.issues.slice(0,5).map(o=>e.jsxs("div",{className:"flex items-center justify-between text-sm py-1 border-b last:border-0",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("a",{href:o.url,target:"_blank",rel:"noopener noreferrer",className:"text-blue-600 hover:underline inline-flex items-center gap-1",children:[o.issue_key,e.jsx(te,{className:"h-3 w-3"})]}),e.jsx("p",{className:"text-gray-500 truncate text-xs",children:o.summary})]}),e.jsx(h,{variant:"outline",className:"ml-2 text-xs",children:o.story_points||0})]},o.id)),n.issues.length>5&&e.jsxs("p",{className:"text-xs text-gray-400 pt-1",children:["+",n.issues.length-5," more issues"]})]})]})]},n.assigneeId))})}function We({open:a,onOpenChange:N,jiraAssignees:p=[],onMappingsUpdated:j}){const[n,o]=c.useState([]),[l,i]=c.useState({}),[m,_]=c.useState(!0),[r,f]=c.useState(!1),[E,D]=c.useState(null);c.useEffect(()=>{a&&R()},[a]);const R=async()=>{_(!0),D(null);try{const[d,g]=await Promise.all([le.list(),J.list()]);o(d);const w={};g.forEach(u=>{w[u.jira_assignee_id]=u}),i(w)}catch(d){console.error("Failed to load mapping data:",d),D("Failed to load data")}finally{_(!1)}},I=async(d,g,w)=>{f(!0),D(null);try{const u=l[d];if(w==="none"){if(u){await J.delete(u.id);const b={...l};delete b[d],i(b)}}else if(u){const b=await J.update(u.id,{team_member_id:w});i(T=>({...T,[d]:b}))}else{const b=await J.create({jira_assignee_id:d,jira_assignee_name:g,team_member_id:w});i(T=>({...T,[d]:b}))}}catch(u){console.error("Failed to save mapping:",u),D("Failed to save mapping")}finally{f(!1)}},O=()=>{j&&j(l),N(!1)};return e.jsx(ce,{open:a,onOpenChange:O,children:e.jsxs(oe,{className:"sm:max-w-lg",children:[e.jsxs(de,{children:[e.jsxs(me,{className:"flex items-center gap-2",children:[e.jsx(ne,{className:"h-5 w-5"}),"Link Jira Assignees to Team Members"]}),e.jsx(Oe,{children:"Map Jira users to your P&E Manager team members for better workload tracking."})]}),E&&e.jsx(re,{variant:"destructive",children:e.jsx(ie,{children:E})}),m?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx(V,{className:"h-6 w-6 animate-spin text-gray-400"})}):e.jsx("div",{className:"space-y-4 py-4 max-h-96 overflow-y-auto",children:p.length===0?e.jsx("p",{className:"text-center text-gray-500 py-4",children:"No Jira assignees found. Sync some issues first."}):p.map(d=>e.jsxs("div",{className:"flex items-center justify-between gap-4 py-2 border-b last:border-0",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx(U,{className:"h-4 w-4 text-gray-400 flex-shrink-0"}),e.jsx("span",{className:"text-sm font-medium truncate",children:d.name})]}),e.jsxs(xe,{value:l[d.id]?.team_member_id||"none",onValueChange:g=>I(d.id,d.name,g),disabled:r,children:[e.jsx(he,{className:"w-[180px]",children:e.jsx(ge,{placeholder:"Not linked"})}),e.jsxs(ue,{children:[e.jsx(H,{value:"none",children:"Not linked"}),n.map(g=>e.jsx(H,{value:g.id,children:g.name},g.id))]})]})]},d.id))}),e.jsx(Be,{children:e.jsx(C,{onClick:O,disabled:r,children:r?e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"h-4 w-4 mr-2 animate-spin"}),"Saving..."]}):"Done"})})]})})}function $e({issue:a,open:N,onOpenChange:p}){if(!a)return null;const j=l=>l?new Date(l).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"-",n=l=>{const i=l?.toLowerCase()||"";return i==="done"||i==="closed"||i==="resolved"?"bg-green-100 text-green-800 border-green-200":i.includes("progress")?"bg-blue-100 text-blue-800 border-blue-200":i==="blocked"||i==="impediment"?"bg-red-100 text-red-800 border-red-200":"bg-gray-100 text-gray-800 border-gray-200"},o=l=>{const i=l?.toLowerCase()||"";return i.includes("highest")||i.includes("critical")?"bg-red-100 text-red-800":i.includes("high")?"bg-orange-100 text-orange-800":i.includes("medium")?"bg-yellow-100 text-yellow-800":"bg-gray-100 text-gray-800"};return e.jsx(ce,{open:N,onOpenChange:p,children:e.jsxs(oe,{className:"max-w-2xl max-h-[85vh] overflow-y-auto",children:[e.jsx(de,{children:e.jsxs(me,{className:"flex items-center gap-3",children:[e.jsx($,{className:"h-5 w-5 text-blue-600"}),e.jsx("span",{className:"text-blue-600 font-mono",children:a.issue_key})]})}),e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{children:e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:a.summary||"Untitled"})}),e.jsxs("div",{className:"flex flex-wrap gap-3",children:[a.status&&e.jsx(h,{variant:"outline",className:n(a.status),children:a.status}),a.issue_type&&e.jsx(h,{variant:"outline",className:"bg-purple-50 text-purple-700 border-purple-200",children:a.issue_type}),a.priority&&e.jsx(h,{variant:"outline",className:o(a.priority),children:a.priority})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-500",children:[e.jsx(U,{className:"h-4 w-4"}),"Assignee"]}),e.jsx("div",{className:"font-medium",children:a.assignee_name||"-"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-500",children:[e.jsx(ve,{className:"h-4 w-4"}),"Story Points"]}),e.jsx("div",{className:"font-medium",children:a.story_points!=null?a.story_points:"-"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-500",children:[e.jsx(we,{className:"h-4 w-4"}),"Sprint"]}),e.jsx("div",{className:"font-medium",children:a.sprint_name||a.sprint||"-"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-500",children:[e.jsx(Se,{className:"h-4 w-4"}),"Epic"]}),e.jsx("div",{className:"font-medium font-mono text-sm",children:a.epic_key||"-"})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-500",children:[e.jsx(K,{className:"h-4 w-4"}),"Last Synced"]}),e.jsx("div",{className:"font-medium text-sm",children:j(a.synced_at)})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-500",children:[e.jsx(K,{className:"h-4 w-4"}),"Captured"]}),e.jsx("div",{className:"font-medium text-sm",children:j(a.created_date)})]})]}),a.labels&&a.labels.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-500",children:[e.jsx(Ce,{className:"h-4 w-4"}),"Labels"]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:(Array.isArray(a.labels)?a.labels:[a.labels]).map((l,i)=>e.jsx(h,{variant:"secondary",className:"text-xs",children:l},i))})]}),a.description&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-500",children:[e.jsx(_e,{className:"h-4 w-4"}),"Description"]}),e.jsx("div",{className:"bg-gray-50 rounded-md p-3 text-sm text-gray-700 whitespace-pre-wrap max-h-40 overflow-y-auto",children:a.description})]}),e.jsx("div",{className:"pt-4 border-t",children:e.jsxs(C,{variant:"outline",className:"w-full",onClick:()=>window.open(a.jira_url||a.url,"_blank"),children:[e.jsx(te,{className:"h-4 w-4 mr-2"}),"Open in Jira"]})})]})]})})}function ts(){const[a,N]=c.useState(!0),[p,j]=c.useState(null),[n,o]=c.useState([]),[l,i]=c.useState(null),[m,_]=c.useState({statuses:[],assignees:[],sprints:[]}),[r,f]=c.useState({status:[],assignee:[],sprint:null,search:""}),[E,D]=c.useState(!1),[R,I]=c.useState({}),[O,d]=c.useState([]),[g,w]=c.useState(null),[u,b]=c.useState(!1);c.useEffect(()=>{T()},[]);const T=async()=>{N(!0),j(null);try{const[s,t,y,v,x]=await Promise.all([W.list(),W.getFilterOptions(),W.getSyncStatus(),J.list().catch(()=>[]),le.list().catch(()=>[])]);o(s||[]),_(t||{statuses:[],assignees:[],sprints:[]}),i(y);const k={};(v||[]).forEach(A=>{k[A.jira_assignee_id]=A}),I(k),d(x||[])}catch(s){console.error("Failed to load Jira issues:",s),j(s.message||"Failed to load Jira issues")}finally{N(!1)}},S=c.useMemo(()=>n.filter(s=>{if(r.search){const t=r.search.toLowerCase(),y=s.issue_key?.toLowerCase().includes(t),v=s.summary?.toLowerCase().includes(t);if(!y&&!v)return!1}return!(r.status.length>0&&!r.status.includes(s.status)||r.assignee.length>0&&!r.assignee.includes(s.assignee_name)||r.sprint&&s.sprint!==r.sprint)}),[n,r]),B=c.useMemo(()=>{const s=S.length,t=S.filter(x=>x.status?.toLowerCase().includes("progress")||x.status?.toLowerCase()==="in progress").length,y=S.filter(x=>x.status?.toLowerCase()==="done"||x.status?.toLowerCase()==="closed").length,v=S.reduce((x,k)=>x+(parseFloat(k.story_points)||0),0);return{total:s,inProgress:t,done:y,totalPoints:v}},[S]),pe=s=>{if(!s)return"Never";const t=new Date(s),v=new Date-t,x=Math.floor(v/6e4),k=Math.floor(v/36e5),A=Math.floor(v/864e5);return x<60?`${x}m ago`:k<24?`${k}h ago`:A<30?`${A}d ago`:t.toLocaleDateString("en-US",{month:"short",day:"numeric"})},je=s=>{const t=s?.toLowerCase()||"";return t==="done"||t==="closed"?"bg-green-100 text-green-800":t.includes("progress")?"bg-blue-100 text-blue-800":"bg-gray-100 text-gray-800"},q=r.status.length>0||r.assignee.length>0||r.sprint!==null||r.search!=="",z=()=>{f({status:[],assignee:[],sprint:null,search:""})},fe=s=>{f(t=>({...t,status:t.status.includes(s)?t.status.filter(y=>y!==s):[...t.status,s]}))},ye=s=>{f(t=>({...t,assignee:t.assignee.includes(s)?t.assignee.filter(y=>y!==s):[...t.assignee,s]}))},Ne=c.useMemo(()=>{const s=new Map;return n.forEach(t=>{t.jira_assignee_id&&t.assignee_name&&s.set(t.jira_assignee_id,{id:t.jira_assignee_id,name:t.assignee_name})}),Array.from(s.values())},[n]),be=s=>{I(s)};return e.jsx("div",{className:"p-6",children:e.jsxs("div",{className:"max-w-7xl mx-auto space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"text-3xl font-bold flex items-center gap-2",children:[e.jsx($,{className:"h-8 w-8"}),"Jira Issues"]}),e.jsx("p",{className:"text-gray-500 mt-1",children:"View synced Jira issues from your team"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[l&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-gray-500",children:[e.jsx(K,{className:"h-4 w-4"}),e.jsxs("span",{children:["Last synced: ",pe(l.last_synced_at)]})]}),e.jsxs(C,{variant:"outline",onClick:()=>D(!0),children:[e.jsx(ne,{className:"h-4 w-4 mr-2"}),"Link Assignees"]}),e.jsxs(C,{variant:"outline",onClick:T,disabled:a,children:[a?e.jsx(V,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(De,{className:"h-4 w-4 mr-2"}),"Refresh"]})]})]}),p&&e.jsxs(re,{variant:"destructive",children:[e.jsx(ke,{className:"h-4 w-4"}),e.jsx(ie,{children:p})]}),a?e.jsxs("div",{className:"flex items-center justify-center py-12",children:[e.jsx(V,{className:"h-8 w-8 animate-spin text-gray-400"}),e.jsx("span",{className:"ml-2 text-gray-500",children:"Loading Jira issues..."})]}):e.jsxs(Ee,{defaultValue:"issues",className:"space-y-4",children:[e.jsxs(Ie,{children:[e.jsxs(X,{value:"issues",className:"gap-2",children:[e.jsx(Me,{className:"h-4 w-4"}),"Issues"]}),e.jsxs(X,{value:"workload",className:"gap-2",children:[e.jsx(Le,{className:"h-4 w-4"}),"Workload"]})]}),e.jsxs(G,{value:"issues",className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsx(M,{children:e.jsxs(L,{className:"pt-6",children:[e.jsx("div",{className:"text-2xl font-bold",children:B.total}),e.jsx("p",{className:"text-sm text-gray-500",children:"Total Issues"})]})}),e.jsx(M,{children:e.jsxs(L,{className:"pt-6",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:B.inProgress}),e.jsx("p",{className:"text-sm text-gray-500",children:"In Progress"})]})}),e.jsx(M,{children:e.jsxs(L,{className:"pt-6",children:[e.jsx("div",{className:"text-2xl font-bold text-green-600",children:B.done}),e.jsx("p",{className:"text-sm text-gray-500",children:"Done"})]})}),e.jsx(M,{children:e.jsxs(L,{className:"pt-6",children:[e.jsx("div",{className:"text-2xl font-bold text-purple-600",children:B.totalPoints}),e.jsx("p",{className:"text-sm text-gray-500",children:"Total Points"})]})})]}),e.jsx(M,{children:e.jsx(L,{className:"py-4",children:e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("div",{className:"relative flex-1 min-w-[200px] max-w-sm",children:[e.jsx(Te,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(Je,{placeholder:"Search by key or summary...",value:r.search,onChange:s=>f(t=>({...t,search:s.target.value})),className:"pl-9"})]}),e.jsxs(Z,{children:[e.jsx(ee,{asChild:!0,children:e.jsxs(C,{variant:"outline",className:"gap-2",children:[e.jsx(Q,{className:"h-4 w-4"}),"Status",r.status.length>0&&e.jsx(h,{variant:"secondary",className:"ml-1",children:r.status.length})]})}),e.jsxs(se,{align:"start",children:[m.statuses.map(s=>e.jsx(ae,{checked:r.status.includes(s),onCheckedChange:()=>fe(s),children:s},s)),m.statuses.length===0&&e.jsx("div",{className:"px-2 py-1 text-sm text-gray-500",children:"No statuses"})]})]}),e.jsxs(Z,{children:[e.jsx(ee,{asChild:!0,children:e.jsxs(C,{variant:"outline",className:"gap-2",children:[e.jsx(Q,{className:"h-4 w-4"}),"Assignee",r.assignee.length>0&&e.jsx(h,{variant:"secondary",className:"ml-1",children:r.assignee.length})]})}),e.jsxs(se,{align:"start",children:[m.assignees.map(s=>e.jsx(ae,{checked:r.assignee.includes(s),onCheckedChange:()=>ye(s),children:s},s)),m.assignees.length===0&&e.jsx("div",{className:"px-2 py-1 text-sm text-gray-500",children:"No assignees"})]})]}),e.jsxs(xe,{value:r.sprint||"all",onValueChange:s=>f(t=>({...t,sprint:s==="all"?null:s})),children:[e.jsx(he,{className:"w-[180px]",children:e.jsx(ge,{placeholder:"All Sprints"})}),e.jsxs(ue,{children:[e.jsx(H,{value:"all",children:"All Sprints"}),m.sprints.map(s=>e.jsx(H,{value:s,children:s},s))]})]}),q&&e.jsxs(C,{variant:"ghost",size:"sm",onClick:z,children:[e.jsx(Pe,{className:"h-4 w-4 mr-1"}),"Clear filters"]})]})})}),e.jsx(M,{children:e.jsx(L,{className:"p-0",children:S.length===0?e.jsxs("div",{className:"text-center py-12 text-gray-500",children:[e.jsx($,{className:"h-12 w-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"No Jira issues found"}),q&&e.jsx(C,{variant:"link",onClick:z,children:"Clear filters to see all issues"})]}):e.jsxs(Ue,{children:[e.jsx(Ve,{children:e.jsxs(Y,{children:[e.jsx(P,{children:"Issue Key"}),e.jsx(P,{className:"min-w-[250px]",children:"Summary"}),e.jsx(P,{children:"Status"}),e.jsx(P,{children:"Assignee"}),e.jsx(P,{children:"Points"}),e.jsx(P,{children:"Sprint"})]})}),e.jsx(He,{children:S.map(s=>e.jsxs(Y,{className:"cursor-pointer hover:bg-gray-50",onClick:()=>{w(s),b(!0)},children:[e.jsx(F,{children:e.jsx("span",{className:"text-blue-600 font-medium flex items-center gap-1",children:s.issue_key})}),e.jsx(F,{className:"max-w-xs truncate",children:s.summary}),e.jsx(F,{children:e.jsx(h,{variant:"outline",className:je(s.status),children:s.status})}),e.jsx(F,{children:s.assignee_name||"-"}),e.jsx(F,{children:s.story_points||"-"}),e.jsx(F,{children:s.sprint||s.sprint_name||"-"})]},s.id))})]})})})]}),e.jsx(G,{value:"workload",children:e.jsx(Re,{issues:S,mappings:R,teamMembers:O})})]}),e.jsx(We,{open:E,onOpenChange:D,jiraAssignees:Ne,onMappingsUpdated:be}),e.jsx($e,{issue:g,open:u,onOpenChange:b})]})})}export{ts as default};
