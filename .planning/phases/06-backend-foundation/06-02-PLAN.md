---
phase: 06-backend-foundation
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - server/services/CaptureService.js
  - server/routes/captureRules.js
  - server/routes/captureInbox.js
  - server/routes/entityMappings.js
  - server/index.js
autonomous: true

must_haves:
  truths:
    - "GET /api/capture-rules returns user's capture rules"
    - "POST /api/capture-rules creates new rule with selectors JSONB"
    - "PUT /api/capture-rules/:id updates existing rule"
    - "DELETE /api/capture-rules/:id removes rule"
    - "POST /api/capture-inbox receives captured data from extension"
    - "GET /api/capture-inbox lists pending items for user"
    - "POST /api/capture-inbox/:id/accept marks item accepted and optionally creates mapping"
    - "POST /api/capture-inbox/:id/reject marks item rejected"
    - "GET /api/entity-mappings lists user's mappings"
    - "POST /api/entity-mappings creates or updates mapping (upsert)"
    - "GET /api/entity-mappings/lookup/:source finds mapping by source_identifier"
  artifacts:
    - path: "server/services/CaptureService.js"
      provides: "Data access layer for capture rules, inbox, mappings"
      exports: ["default"]
      min_lines: 150
    - path: "server/routes/captureRules.js"
      provides: "REST routes for /api/capture-rules"
      exports: ["default"]
    - path: "server/routes/captureInbox.js"
      provides: "REST routes for /api/capture-inbox"
      exports: ["default"]
    - path: "server/routes/entityMappings.js"
      provides: "REST routes for /api/entity-mappings"
      exports: ["default"]
    - path: "server/index.js"
      provides: "Route mounting"
      contains: "/api/capture-rules"
  key_links:
    - from: "server/routes/captureRules.js"
      to: "server/services/CaptureService.js"
      via: "import CaptureService"
      pattern: "import CaptureService from"
    - from: "server/routes/captureInbox.js"
      to: "server/services/CaptureService.js"
      via: "import CaptureService"
      pattern: "import CaptureService from"
    - from: "server/routes/entityMappings.js"
      to: "server/services/CaptureService.js"
      via: "import CaptureService"
      pattern: "import CaptureService from"
    - from: "server/index.js"
      to: "server/routes/captureRules.js"
      via: "app.use('/api/capture-rules')"
      pattern: "/api/capture-rules"
---

<objective>
Create CaptureService and REST API routes for capture rules, inbox, and entity mappings.

Purpose: Complete backend API that extension (Phase 7) and web UI (Phase 8) will consume
Output: Service class + 3 route files + route mounting in index.js
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-backend-foundation/06-RESEARCH.md
@.planning/phases/06-backend-foundation/06-01-SUMMARY.md

# Existing patterns to follow
@server/services/JiraService.js
@server/routes/jira.js
@server/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CaptureService with all methods</name>
  <files>server/services/CaptureService.js</files>
  <action>
Create server/services/CaptureService.js following the JiraService.js pattern exactly.

**Rule Management Methods:**
- listRules(userId, filters) - List rules with optional {enabled} filter, ORDER BY name ASC
- getRule(userId, ruleId) - Get single rule by ID
- createRule(userId, ruleData) - Create rule with {name, description, url_pattern, selectors, enabled, metadata}
- updateRule(userId, ruleId, updates) - Partial update, use COALESCE pattern
- deleteRule(userId, ruleId) - Delete and return boolean

**Inbox Management Methods:**
- listInboxItems(userId, filters) - List with optional {status, rule_id} filters, ORDER BY created_date DESC
- getInboxItem(userId, itemId) - Get single item
- createInboxItem(userId, itemData) - Create from {rule_id, rule_name, source_url, source_identifier, captured_data}
- acceptInboxItem(userId, itemId, mapping) - Set status='accepted', processed_at=NOW(), optionally set target_entity_type/id, optionally create entity_mapping if create_mapping=true
- rejectInboxItem(userId, itemId) - Set status='rejected', processed_at=NOW()
- bulkAccept(userId, itemIds, mapping) - Loop over itemIds calling acceptInboxItem
- bulkReject(userId, itemIds) - Loop over itemIds calling rejectInboxItem

**Mapping Management Methods:**
- listMappings(userId, filters) - List with optional {source_type, target_entity_type} filters
- getMapping(userId, mappingId) - Get single mapping
- getMappingBySource(userId, sourceIdentifier) - Find by source_identifier (for auto-apply)
- createOrUpdateMapping(userId, data) - Upsert using ON CONFLICT pattern
- deleteMapping(userId, mappingId) - Delete and return boolean

**Critical patterns:**
- Import { query } from '../db/connection.js'
- EVERY query MUST include user_id filter (multi-tenancy)
- Use parameterized queries ($1, $2, etc.) - NEVER concatenate strings
- Export as singleton: export default new CaptureService()
- Add JSDoc comments for each method
  </action>
  <verify>
File exists and contains:
- class CaptureService
- All 15 methods listed above
- Every SQL query has user_id filter
- export default new CaptureService()
  </verify>
  <done>
CaptureService.js exists with complete CRUD for rules, inbox workflow, and mappings
  </done>
</task>

<task type="auto">
  <name>Task 2: Create route files for all three APIs</name>
  <files>
    server/routes/captureRules.js
    server/routes/captureInbox.js
    server/routes/entityMappings.js
  </files>
  <action>
Create three route files following the exact pattern from server/routes/jira.js:

**server/routes/captureRules.js:**
```
GET    /                  - List rules (query: enabled)
GET    /:id               - Get single rule
POST   /                  - Create rule (body: name, url_pattern, selectors, description?, enabled?, metadata?)
PUT    /:id               - Update rule (body: partial rule data)
DELETE /:id               - Delete rule
```
- Validate: POST requires name and url_pattern
- Return 404 if rule not found on GET/:id, PUT/:id, DELETE/:id

**server/routes/captureInbox.js:**
```
GET    /                  - List items (query: status, rule_id)
GET    /:id               - Get single item
POST   /                  - Create item (body: rule_id?, rule_name?, source_url, source_identifier?, captured_data)
POST   /:id/accept        - Accept (body: target_entity_type?, target_entity_id?, create_mapping?)
POST   /:id/reject        - Reject
POST   /bulk-accept       - Bulk accept (body: item_ids, target_entity_type?, target_entity_id?, create_mapping?)
POST   /bulk-reject       - Bulk reject (body: item_ids)
```
- CRITICAL: Define /:id/accept and /:id/reject BEFORE /:id route to avoid conflicts
- Validate: POST / requires source_url and captured_data
- Return 404 if item not found

**server/routes/entityMappings.js:**
```
GET    /                  - List mappings (query: source_type, target_entity_type)
GET    /lookup/:source    - Find by source_identifier (URL-encoded)
GET    /:id               - Get single mapping
POST   /                  - Create/update mapping (body: source_identifier, target_entity_type, target_entity_id, source_type?, source_display_name?, auto_apply?)
DELETE /:id               - Delete mapping
```
- CRITICAL: Define /lookup/:source BEFORE /:id route
- Validate: POST requires source_identifier, target_entity_type, target_entity_id

**All routes:**
- Import { authMiddleware } from '../middleware/auth.js'
- Apply router.use(authMiddleware)
- Use req.user.id for all service calls
- Standard error handling: try/catch, console.error, 500 response
- Return 201 on create, 204 on delete
  </action>
  <verify>
All three files exist with:
- authMiddleware applied
- All specified routes defined
- Proper route order (specific routes before :id)
- Error handling in every route
  </verify>
  <done>
Three route files exist with complete REST API coverage
  </done>
</task>

<task type="auto">
  <name>Task 3: Mount routes in server/index.js</name>
  <files>server/index.js</files>
  <action>
Update server/index.js to import and mount the three new route files.

**Add imports** (after existing route imports, around line 32):
```javascript
import captureRulesRouter from './routes/captureRules.js';
import captureInboxRouter from './routes/captureInbox.js';
import entityMappingsRouter from './routes/entityMappings.js';
```

**Mount routes** (after existing app.use statements, around line 137):
```javascript
app.use('/api/capture-rules', captureRulesRouter);
app.use('/api/capture-inbox', captureInboxRouter);
app.use('/api/entity-mappings', entityMappingsRouter);
```

Maintain alphabetical or logical grouping with existing routes.
  </action>
  <verify>
Run: grep -n "capture" server/index.js
Should show:
- Import statements for all 3 routers
- app.use statements for all 3 routes
  </verify>
  <done>
All three routes mounted and accessible via /api/capture-rules, /api/capture-inbox, /api/entity-mappings
  </done>
</task>

</tasks>

<verification>
Phase requirements covered:
- API-01: GET /api/capture-rules (listRules)
- API-02: POST/PUT/DELETE /api/capture-rules (createRule, updateRule, deleteRule)
- API-03: POST /api/capture-inbox (createInboxItem)
- API-04: GET /api/capture-inbox (listInboxItems)
- API-05: POST /api/capture-inbox/:id/accept (acceptInboxItem)
- API-06: POST /api/capture-inbox/:id/reject (rejectInboxItem)
- API-07: GET/POST/DELETE /api/entity-mappings (listMappings, createOrUpdateMapping, deleteMapping)

API verification (requires running server):
```bash
# Start server
npm run dev:server

# Test capture rules
curl http://localhost:3001/api/capture-rules

# Test capture inbox
curl http://localhost:3001/api/capture-inbox

# Test entity mappings
curl http://localhost:3001/api/entity-mappings
```

All endpoints should return 200 with empty arrays (no data yet).
</verification>

<success_criteria>
1. server/services/CaptureService.js exists with all 15 methods
2. server/routes/captureRules.js exists with 5 routes
3. server/routes/captureInbox.js exists with 7 routes
4. server/routes/entityMappings.js exists with 5 routes
5. Routes mounted in server/index.js
6. Server starts without errors: npm run dev:server
7. GET requests to all three base endpoints return 200
</success_criteria>

<output>
After completion, create `.planning/phases/06-backend-foundation/06-02-SUMMARY.md`
</output>
