---
phase: 06-backend-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/db/018_capture_framework.sql
  - server/db/migrate.js
autonomous: true

must_haves:
  truths:
    - "capture_rules table exists with JSONB selectors column"
    - "capture_inbox table exists with status workflow"
    - "entity_mappings table exists with unique constraint on user_id+source_identifier"
    - "All tables have user_id column for multi-tenancy"
    - "Migration is registered and can be run via npm run migrate"
  artifacts:
    - path: "server/db/018_capture_framework.sql"
      provides: "Database schema for capture_rules, capture_inbox, entity_mappings"
      contains: "CREATE TABLE IF NOT EXISTS capture_rules"
    - path: "server/db/migrate.js"
      provides: "Migration registration"
      contains: "018_capture_framework"
  key_links:
    - from: "server/db/migrate.js"
      to: "server/db/018_capture_framework.sql"
      via: "MIGRATIONS array entry"
      pattern: "018_capture_framework"
---

<objective>
Create the database schema for the v1.1 Web Capture Framework: capture_rules, capture_inbox, and entity_mappings tables.

Purpose: Establish data storage foundation that Phase 7 extension and Phase 8 UI will consume
Output: Single migration file with all 3 tables, registered in migrate.js
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-backend-foundation/06-RESEARCH.md

# Existing patterns to follow
@server/db/017_jira_integration.sql
@server/db/migrate.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration file</name>
  <files>server/db/018_capture_framework.sql</files>
  <action>
Create migration file with three tables following the exact patterns from 017_jira_integration.sql:

**capture_rules table:**
- id UUID PRIMARY KEY DEFAULT uuid_generate_v4()
- user_id VARCHAR(255) NOT NULL
- name VARCHAR(255) NOT NULL
- description TEXT
- url_pattern VARCHAR(1024) NOT NULL (e.g., "*.jenkins.sap/*")
- enabled BOOLEAN DEFAULT true
- selectors JSONB NOT NULL DEFAULT '[]' (array of {field_name, selector, type, required})
- metadata JSONB DEFAULT '{}'
- created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
- updated_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
- Indexes: user_id, enabled

**capture_inbox table:**
- id UUID PRIMARY KEY DEFAULT uuid_generate_v4()
- user_id VARCHAR(255) NOT NULL
- rule_id UUID REFERENCES capture_rules(id) ON DELETE SET NULL
- rule_name VARCHAR(255) (denormalized for display after rule deletion)
- source_url VARCHAR(2048) NOT NULL
- source_identifier VARCHAR(512) (for matching entity mappings)
- status VARCHAR(50) DEFAULT 'pending' CHECK (status IN ('pending', 'accepted', 'rejected'))
- captured_data JSONB NOT NULL
- target_entity_type VARCHAR(100) (set on accept)
- target_entity_id UUID (set on accept)
- processed_at TIMESTAMP (set on accept/reject)
- created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
- Indexes: user_id, status, rule_id, created_date

**entity_mappings table:**
- id UUID PRIMARY KEY DEFAULT uuid_generate_v4()
- user_id VARCHAR(255) NOT NULL
- source_identifier VARCHAR(512) NOT NULL
- source_type VARCHAR(100) (e.g., "jenkins", "grafana")
- source_display_name VARCHAR(255)
- target_entity_type VARCHAR(100) NOT NULL ('project', 'team_member', 'task')
- target_entity_id UUID NOT NULL
- auto_apply BOOLEAN DEFAULT true
- created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
- updated_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
- UNIQUE(user_id, source_identifier)
- Indexes: user_id, source_identifier, (target_entity_type, target_entity_id)

**Add triggers** for updated_date using existing update_updated_date_column() function (same pattern as 017_jira_integration.sql).

Include comment header with migration name and purpose.
  </action>
  <verify>
File exists at server/db/018_capture_framework.sql and contains:
- CREATE TABLE IF NOT EXISTS capture_rules
- CREATE TABLE IF NOT EXISTS capture_inbox
- CREATE TABLE IF NOT EXISTS entity_mappings
- All required indexes
- Triggers for updated_date
  </verify>
  <done>
Migration file exists with complete schema for all 3 tables including indexes and triggers
  </done>
</task>

<task type="auto">
  <name>Task 2: Register migration in migrate.js</name>
  <files>server/db/migrate.js</files>
  <action>
Add new migration entry to the MIGRATIONS array in server/db/migrate.js:

```javascript
{
  version: '018_capture_framework',
  name: 'Create tables for capture rules, inbox, and entity mappings',
  file: '018_capture_framework.sql'
}
```

Add this entry after the existing '017_jira_integration' entry to maintain version order.
  </action>
  <verify>
Run: grep -n "018_capture_framework" server/db/migrate.js
Should show the migration entry in MIGRATIONS array
  </verify>
  <done>
Migration registered in migrate.js and ready to execute
  </done>
</task>

<task type="auto">
  <name>Task 3: Run migration and verify tables</name>
  <files>None (database operation)</files>
  <action>
Execute the migration and verify tables are created:

1. Run migration: npm run migrate
2. Verify tables exist by connecting to database and checking:
   - capture_rules table structure
   - capture_inbox table structure
   - entity_mappings table structure
   - Confirm UNIQUE constraint on entity_mappings(user_id, source_identifier)

Note: If local PostgreSQL is not running, this step validates the SQL syntax is correct. Full database verification can occur when backend starts.
  </action>
  <verify>
Migration output shows:
- "Running migration: Create tables for capture rules, inbox, and entity mappings..."
- No SQL errors
- Migration completed successfully or database already up to date
  </verify>
  <done>
Migration runs without errors; tables created (or syntax validated if DB unavailable)
  </done>
</task>

</tasks>

<verification>
Phase requirements covered:
- DB-01: capture_rules table with selectors JSONB
- DB-02: capture_inbox table with status workflow
- DB-03: entity_mappings table with unique constraint
- DB-04: Migration file following conventions

Database schema verification:
1. All tables have user_id for multi-tenancy
2. JSONB columns have proper defaults ([] for arrays, {} for objects)
3. Status constraint limits values to pending/accepted/rejected
4. Foreign key from capture_inbox.rule_id to capture_rules with ON DELETE SET NULL
5. Unique constraint on (user_id, source_identifier) in entity_mappings
6. Updated_date triggers in place for capture_rules and entity_mappings
</verification>

<success_criteria>
1. server/db/018_capture_framework.sql exists with valid SQL syntax
2. Migration registered in server/db/migrate.js
3. npm run migrate completes without errors
4. All 3 tables created with correct columns, indexes, and constraints
</success_criteria>

<output>
After completion, create `.planning/phases/06-backend-foundation/06-01-SUMMARY.md`
</output>
