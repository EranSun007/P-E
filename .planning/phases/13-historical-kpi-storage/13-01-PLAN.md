---
phase: 13-historical-kpi-storage
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/services/BugService.js
  - server/routes/bugs.js
autonomous: true

must_haves:
  truths:
    - "GET /api/bugs/kpis/history returns KPI data for last 12 weeks"
    - "Query accepts week count parameter (4, 8, or 12 weeks)"
    - "Query accepts component filter matching dashboard"
    - "Response includes week_ending dates for X-axis rendering"
    - "Query completes under 500ms for 12-week dataset"
  artifacts:
    - path: "server/services/BugService.js"
      provides: "getKPIHistory method"
      contains: "getKPIHistory"
    - path: "server/routes/bugs.js"
      provides: "GET /api/bugs/kpis/history endpoint"
      contains: "/kpis/history"
  key_links:
    - from: "server/routes/bugs.js"
      to: "BugService.getKPIHistory"
      via: "route handler calls service"
      pattern: "BugService\\.getKPIHistory"
    - from: "BugService.getKPIHistory"
      to: "weekly_kpis JOIN bug_uploads"
      via: "SQL query"
      pattern: "JOIN bug_uploads"
---

<objective>
Add historical KPI query endpoint that returns multi-week trend data for chart visualization.

Purpose: Enable Phase 14's trend charts by providing time-series KPI data with week_ending dates for X-axis.
Output: Working GET /api/bugs/kpis/history endpoint returning array of weekly KPI snapshots.
</objective>

<execution_context>
@/Users/i306072/.claude/get-shit-done/workflows/execute-plan.md
@/Users/i306072/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing implementation to extend
@server/services/BugService.js
@server/routes/bugs.js
@server/db/019_bug_dashboard.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getKPIHistory method to BugService</name>
  <files>server/services/BugService.js</files>
  <action>
Add a new method `getKPIHistory(userId, weeks, component)` to BugService that:

1. Accepts parameters:
   - `userId` (string) - For multi-tenancy filter
   - `weeks` (number) - Number of weeks to retrieve (default 12, validate 4/8/12)
   - `component` (string|null) - Optional component filter (NULL = all components)

2. Builds a SQL query that:
   - JOINs weekly_kpis with bug_uploads to get week_ending dates
   - Filters by user_id from bug_uploads table
   - Filters by component using `IS NOT DISTINCT FROM` (handles NULL for "all")
   - Orders by week_ending DESC
   - Limits to requested week count

3. SQL query pattern:
```sql
SELECT
  wk.kpi_data,
  wk.calculated_at,
  wk.component,
  bu.week_ending
FROM weekly_kpis wk
JOIN bug_uploads bu ON wk.upload_id = bu.id
WHERE bu.user_id = $1
  AND wk.component IS NOT DISTINCT FROM $2
ORDER BY bu.week_ending DESC
LIMIT $3
```

4. Returns array of objects with shape:
```javascript
[
  {
    week_ending: "2026-01-25",  // DATE from bug_uploads
    component: null,            // or component name
    kpi_data: { ... },         // All 9 KPIs
    calculated_at: "..."       // Timestamp
  },
  // ... more weeks
]
```

5. Validate weeks parameter - only allow 4, 8, or 12. Default to 12 if invalid.

Place this method in the "Query Methods for API Routes" section after getKPIs().
  </action>
  <verify>
Method exists in BugService.js with correct signature and SQL query structure.
Run: `grep -A 30 "getKPIHistory" server/services/BugService.js`
  </verify>
  <done>
BugService.getKPIHistory() method implemented with JOIN query, week count validation, and component filter support.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add GET /api/bugs/kpis/history route</name>
  <files>server/routes/bugs.js</files>
  <action>
Add a new route `GET /api/bugs/kpis/history` to bugs.js that:

1. Accepts query parameters:
   - `weeks` (optional) - Number of weeks: 4, 8, or 12 (default: 12)
   - `component` (optional) - Component filter (default: null for all)

2. Calls BugService.getKPIHistory() with validated parameters

3. Returns JSON array with week_ending dates for chart X-axis

4. Route implementation pattern:
```javascript
/**
 * GET /api/bugs/kpis/history
 * Get historical KPI data for trend charts
 * Query params: weeks (4|8|12, default 12), component (optional)
 */
router.get('/kpis/history', async (req, res) => {
  try {
    const { weeks, component } = req.query;
    const weekCount = parseInt(weeks, 10) || 12;

    const history = await BugService.getKPIHistory(
      req.user.id,
      weekCount,
      component || null
    );

    res.json(history);
  } catch (error) {
    console.error('GET /api/bugs/kpis/history error:', error);
    res.status(500).json({ error: 'Internal Server Error', message: error.message });
  }
});
```

5. Place this route in the "KPIs" section after the existing /kpis route.

6. Add JSDoc comment explaining the endpoint purpose and response format.
  </action>
  <verify>
1. Route exists: `grep -A 15 "kpis/history" server/routes/bugs.js`
2. Manual test with curl (requires running server):
   `curl "http://localhost:3001/api/bugs/kpis/history?weeks=4" -H "Content-Type: application/json"`
   Should return JSON array (empty if no data, or array of KPI objects)
  </verify>
  <done>
GET /api/bugs/kpis/history endpoint responds with historical KPI array including week_ending dates for each data point.
  </done>
</task>

</tasks>

<verification>
1. Code review: Both files modified with new method and route
2. Syntax check: `node --check server/services/BugService.js && node --check server/routes/bugs.js`
3. Server starts: `npm run dev:server` starts without errors
4. Endpoint responds: `curl "http://localhost:3001/api/bugs/kpis/history"` returns 200
5. Performance: Response time under 500ms (verify in browser network tab or curl timing)
</verification>

<success_criteria>
- GET /api/bugs/kpis/history returns array of KPI objects with week_ending dates
- weeks parameter filters to 4, 8, or 12 weeks
- component parameter filters by component or returns all (null)
- Response includes week_ending in format suitable for chart X-axis
- Server starts without errors
- No changes to existing endpoints (backward compatible)
</success_criteria>

<output>
After completion, create `.planning/phases/13-historical-kpi-storage/13-01-SUMMARY.md`
</output>
