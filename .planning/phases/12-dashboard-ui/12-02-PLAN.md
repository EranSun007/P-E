---
phase: 12-dashboard-ui
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/pages/BugDashboard.jsx
  - src/components/bugs/AgingBugsTable.jsx
  - src/components/bugs/MTTRBarChart.jsx
  - src/components/bugs/BugCategoryChart.jsx
autonomous: true

must_haves:
  truths:
    - "Aging bugs table shows open VH/High bugs sorted by age"
    - "Each bug key is a clickable link to JIRA"
    - "MTTR bar chart shows resolution time by priority"
    - "Bug category donut chart shows distribution by component"
  artifacts:
    - path: "src/components/bugs/AgingBugsTable.jsx"
      provides: "Table of open high-priority bugs with JIRA links"
      exports: ["AgingBugsTable"]
    - path: "src/components/bugs/MTTRBarChart.jsx"
      provides: "Horizontal bar chart of MTTR by priority"
      exports: ["MTTRBarChart"]
    - path: "src/components/bugs/BugCategoryChart.jsx"
      provides: "Donut chart of bug category distribution"
      exports: ["BugCategoryChart"]
    - path: "src/pages/BugDashboard.jsx"
      provides: "Dashboard with table and charts section"
      contains: "AgingBugsTable"
  key_links:
    - from: "src/pages/BugDashboard.jsx"
      to: "/api/bugs/list"
      via: "apiClient.bugs.listBugs()"
      pattern: "apiClient\\.bugs\\.listBugs"
    - from: "AgingBugsTable"
      to: "JIRA"
      via: "External link with bug_key"
      pattern: "jira.tools.sap/browse"
    - from: "MTTRBarChart"
      to: "Recharts"
      via: "BarChart component"
      pattern: "from 'recharts'"
---

<objective>
Add data visualization components to the Bug Dashboard: aging bugs table with JIRA links, MTTR bar chart, and bug category donut chart.

Purpose: Provide actionable insights through visual analysis of bug resolution times and category distribution, plus quick access to high-priority open bugs via direct JIRA links.

Output: Three new visualization components integrated into the dashboard: AgingBugsTable (DASH-06), MTTRBarChart (DASH-07), BugCategoryChart (DASH-08).
</objective>

<execution_context>
@/Users/i306072/.claude/get-shit-done/workflows/execute-plan.md
@/Users/i306072/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-dashboard-ui/12-RESEARCH.md
@.planning/phases/12-dashboard-ui/12-01-SUMMARY.md
@src/pages/BugDashboard.jsx
@src/api/apiClient.js
@src/components/ui/table.jsx
@server/services/BugService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AgingBugsTable component</name>
  <files>src/components/bugs/AgingBugsTable.jsx</files>
  <action>
Create a table component showing open VH/High priority bugs sorted by age with clickable JIRA links.

1. **Add imports:**
   - Table, TableBody, TableCell, TableHead, TableHeader, TableRow from '@/components/ui/table'
   - Card, CardContent, CardHeader, CardTitle from '@/components/ui/card'
   - Badge from '@/components/ui/badge'
   - ExternalLink from 'lucide-react'
   - formatDistanceToNow from 'date-fns'

2. **Define JIRA base URL:**
   ```javascript
   const JIRA_BASE_URL = import.meta.env.VITE_JIRA_BASE_URL || 'https://jira.tools.sap/browse/';
   ```

3. **Define open statuses:**
   ```javascript
   const OPEN_STATUSES = ['Open', 'Author Action', 'In Progress', 'Reopened'];
   ```

4. **AgingBugsTable component with props: bugs (array from API)**

   Filter and sort logic:
   ```javascript
   const agingBugs = bugs
     .filter(bug =>
       ['Very High', 'High'].includes(bug.priority) &&
       OPEN_STATUSES.includes(bug.status)
     )
     .slice(0, 20); // Limit to top 20
   ```

   Note: bugs array from API is already sorted by priority and created_date.

5. **Render table structure:**
   - Card wrapper with title "Aging High-Priority Bugs"
   - Show count: "(X open VH/High bugs)"
   - Table columns: Key, Summary, Priority, Age, Status, Assignee
   - Key column: clickable link to `${JIRA_BASE_URL}${bug.bug_key}` with ExternalLink icon
   - Summary: max-w-[300px] truncate for long text
   - Priority: Badge with variant="destructive" for VH, variant="secondary" for High
   - Age: formatDistanceToNow(new Date(bug.created_date), { addSuffix: false })
   - Assignee: Show bug.assignee or "Unassigned" if null

6. **Handle empty state:**
   - If agingBugs.length === 0, show message "No open VH/High bugs - great job!"

Export: AgingBugsTable
  </action>
  <verify>
`npm run build` succeeds. Import in BugDashboard with sample bugs array and verify table renders with clickable JIRA links.
  </verify>
  <done>
AgingBugsTable shows open VH/High bugs with priority badges, age calculation, and clickable JIRA links opening in new tab.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create MTTRBarChart component</name>
  <files>src/components/bugs/MTTRBarChart.jsx</files>
  <action>
Create a horizontal bar chart showing Mean Time To Resolution by priority using Recharts.

1. **Add imports:**
   - ResponsiveContainer, BarChart, Bar, XAxis, YAxis, Tooltip, Cell from 'recharts'
   - Card, CardContent, CardHeader, CardTitle from '@/components/ui/card'

2. **Define priority colors:**
   ```javascript
   const PRIORITY_COLORS = {
     'Very High': '#ef4444', // red-500
     'High': '#f97316',      // orange-500
     'Medium': '#eab308',    // yellow-500
     'Low': '#22c55e'        // green-500
   };
   ```

3. **MTTRBarChart component with props: mttrByPriority (object from KPIs)**

   Transform data for chart:
   ```javascript
   const data = Object.entries(mttrByPriority || {})
     .filter(([_, values]) => values.count > 0)
     .map(([priority, values]) => ({
       priority,
       mttr: values.median || 0,
       count: values.count
     }))
     .sort((a, b) => {
       const order = ['Very High', 'High', 'Medium', 'Low'];
       return order.indexOf(a.priority) - order.indexOf(b.priority);
     });
   ```

4. **Render chart:**
   - Card wrapper with title "MTTR by Priority"
   - Subtitle: "Mean Time to Resolution (hours)"
   - Container div with h-64 (256px height - required for ResponsiveContainer)
   - ResponsiveContainer width="100%" height="100%"
   - BarChart with layout="vertical" for horizontal bars
   - XAxis type="number" with label "Hours"
   - YAxis dataKey="priority" type="category" width={80}
   - Tooltip showing "X.Xh - N bugs resolved"
   - Bar with colored cells per priority

5. **Handle empty state:**
   - If data.length === 0, show "No resolved bugs to analyze"

Chart JSX structure:
```jsx
<ResponsiveContainer width="100%" height="100%">
  <BarChart data={data} layout="vertical" margin={{ left: 10, right: 30 }}>
    <XAxis type="number" unit="h" />
    <YAxis dataKey="priority" type="category" width={80} />
    <Tooltip
      formatter={(value, name, props) => [
        `${value.toFixed(1)}h - ${props.payload.count} bugs`,
        'MTTR'
      ]}
    />
    <Bar dataKey="mttr" radius={[0, 4, 4, 0]}>
      {data.map((entry, index) => (
        <Cell key={index} fill={PRIORITY_COLORS[entry.priority] || '#6b7280'} />
      ))}
    </Bar>
  </BarChart>
</ResponsiveContainer>
```

Export: MTTRBarChart
  </action>
  <verify>
`npm run build` succeeds. Component renders horizontal bars with correct priority colors. Tooltip shows hours and bug count.
  </verify>
  <done>
MTTRBarChart displays horizontal bar chart with priority-colored bars, hover tooltip showing resolution time and count.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create BugCategoryChart and integrate all components</name>
  <files>src/components/bugs/BugCategoryChart.jsx, src/pages/BugDashboard.jsx</files>
  <action>
**BugCategoryChart component (src/components/bugs/BugCategoryChart.jsx):**

Create a donut chart showing bug distribution by component/category.

1. **Add imports:**
   - ResponsiveContainer, PieChart, Pie, Cell, Tooltip, Legend from 'recharts'
   - Card, CardContent, CardHeader, CardTitle from '@/components/ui/card'

2. **Define component colors:**
   ```javascript
   const COMPONENT_COLORS = {
     deployment: '#3b82f6',           // blue-500
     'foss-vulnerabilities': '#8b5cf6', // violet-500
     'service-broker': '#06b6d4',     // cyan-500
     'cm-metering': '#f59e0b',        // amber-500
     'sdm-metering': '#10b981',       // emerald-500
     other: '#6b7280'                 // gray-500
   };
   ```

3. **BugCategoryChart component with props: categoryDistribution (object from KPIs)**

   Transform data:
   ```javascript
   const data = Object.entries(categoryDistribution || {})
     .filter(([_, value]) => value > 0)
     .map(([name, value]) => ({
       name,
       value,
       color: COMPONENT_COLORS[name] || COMPONENT_COLORS.other
     }));

   const total = data.reduce((sum, d) => sum + d.value, 0);
   ```

4. **Render donut chart:**
   - Card wrapper with title "Bug Distribution by Category"
   - Container div with h-72 (288px - slightly taller for legend)
   - ResponsiveContainer width="100%" height="100%"
   - PieChart with centered Pie
   - innerRadius={60} outerRadius={90} for donut effect
   - paddingAngle={2} for segment gaps
   - Custom label showing percentage
   - Tooltip showing count and percentage
   - Legend at bottom

Chart JSX structure:
```jsx
<ResponsiveContainer width="100%" height="100%">
  <PieChart>
    <Pie
      data={data}
      dataKey="value"
      nameKey="name"
      cx="50%"
      cy="45%"
      innerRadius={60}
      outerRadius={90}
      paddingAngle={2}
      label={({ name, percent }) => `${(percent * 100).toFixed(0)}%`}
      labelLine={false}
    >
      {data.map((entry, index) => (
        <Cell key={index} fill={entry.color} />
      ))}
    </Pie>
    <Tooltip
      formatter={(value, name) => [
        `${value} bugs (${((value / total) * 100).toFixed(1)}%)`,
        name
      ]}
    />
    <Legend />
  </PieChart>
</ResponsiveContainer>
```

5. **Handle empty state:**
   - If data.length === 0, show "No category data available"

**Update BugDashboard.jsx to integrate all components:**

1. **Add imports:**
   - AgingBugsTable from '@/components/bugs/AgingBugsTable'
   - MTTRBarChart from '@/components/bugs/MTTRBarChart'
   - BugCategoryChart from '@/components/bugs/BugCategoryChart'

2. **Add bugs state and fetch:**
   ```javascript
   const [bugs, setBugs] = useState([]);
   ```

   Update the KPIs useEffect to also fetch bugs:
   ```javascript
   useEffect(() => {
     if (!selectedUploadId) {
       setKPIs(null);
       setBugs([]);
       return;
     }
     async function loadData() {
       setLoading(true);
       try {
         const [kpiData, bugData] = await Promise.all([
           apiClient.bugs.getKPIs(
             selectedUploadId,
             selectedComponent === 'all' ? null : selectedComponent
           ),
           apiClient.bugs.listBugs(selectedUploadId, {
             component: selectedComponent === 'all' ? null : selectedComponent,
             limit: 100
           })
         ]);
         setKPIs(kpiData);
         setBugs(bugData);
         setError(null);
       } catch (err) {
         setError(err.message);
       } finally {
         setLoading(false);
       }
     }
     loadData();
   }, [selectedUploadId, selectedComponent]);
   ```

3. **Add charts section below KPIGrid:**
   ```jsx
   {/* Charts Row */}
   <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
     <MTTRBarChart mttrByPriority={kpis?.mttr_by_priority} />
     <BugCategoryChart categoryDistribution={kpis?.category_distribution} />
   </div>

   {/* Aging Bugs Table */}
   <div className="mt-6">
     <AgingBugsTable bugs={bugs} />
   </div>
   ```

4. **Ensure charts only render when kpis exists:**
   - Wrap charts section in conditional: {kpis && (...)}

Export: BugCategoryChart
  </action>
  <verify>
1. `npm run build` succeeds
2. Navigate to /bugs in browser
3. Verify MTTR bar chart shows colored horizontal bars
4. Verify category donut chart shows distribution with legend
5. Verify aging bugs table shows VH/High bugs with JIRA links
6. Click a JIRA link - opens in new tab
7. Change component filter - all visualizations update
  </verify>
  <done>
Dashboard shows complete visualization suite: KPI cards with filters, MTTR bar chart, category donut chart, and aging bugs table with clickable JIRA links.
  </done>
</task>

</tasks>

<verification>
1. **MTTR Bar Chart (DASH-07):**
   - Chart renders with colored horizontal bars per priority
   - Hover shows MTTR value and bug count
   - Bars sorted by priority (VH, High, Medium, Low)

2. **Bug Category Chart (DASH-08):**
   - Donut chart renders with colored segments
   - Legend shows component names
   - Hover shows count and percentage

3. **Aging Bugs Table (DASH-06):**
   - Table shows open VH/High bugs
   - Bug keys are clickable links to JIRA
   - Links open in new tab
   - Age shows human-readable duration

4. **Filter integration:**
   - Change component filter - all three visualizations update
   - Change week filter - all visualizations reload

5. **Build verification:**
   - `npm run build` completes without errors
   - No console errors in browser
</verification>

<success_criteria>
- [ ] AgingBugsTable renders open VH/High bugs
- [ ] Bug keys link to JIRA (opens new tab)
- [ ] MTTRBarChart shows horizontal bars by priority
- [ ] Bar colors match priority levels
- [ ] BugCategoryChart shows donut with category segments
- [ ] Legend displays all categories
- [ ] Component filter updates all visualizations
- [ ] Week filter updates all visualizations
- [ ] Empty states handled gracefully
- [ ] `npm run build` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/12-dashboard-ui/12-02-SUMMARY.md`
</output>
