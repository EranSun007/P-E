---
phase: 12-dashboard-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pages/BugDashboard.jsx
  - src/components/bugs/KPICard.jsx
  - src/components/bugs/KPIGrid.jsx
  - src/components/bugs/CriticalAlertBanner.jsx
autonomous: true

must_haves:
  truths:
    - "Dashboard shows all 9 KPIs in card layout"
    - "Each KPI card displays green/yellow/red status based on thresholds"
    - "User can filter KPIs by component (All, deployment, foss-vulnerabilities, etc.)"
    - "User can filter by week using upload dropdown"
    - "Critical alert banner appears when any KPI is in red zone"
  artifacts:
    - path: "src/components/bugs/KPICard.jsx"
      provides: "Single KPI display with status color coding"
      exports: ["KPICard"]
    - path: "src/components/bugs/KPIGrid.jsx"
      provides: "Grid layout of all 9 KPI cards"
      exports: ["KPIGrid"]
    - path: "src/components/bugs/CriticalAlertBanner.jsx"
      provides: "Alert banner for red zone KPIs"
      exports: ["CriticalAlertBanner"]
    - path: "src/pages/BugDashboard.jsx"
      provides: "Dashboard page with filters and KPI display"
      contains: "selectedUpload"
  key_links:
    - from: "src/pages/BugDashboard.jsx"
      to: "/api/bugs/uploads"
      via: "apiClient.bugs.listUploads()"
      pattern: "apiClient\\.bugs\\.listUploads"
    - from: "src/pages/BugDashboard.jsx"
      to: "/api/bugs/kpis"
      via: "apiClient.bugs.getKPIs(uploadId, component)"
      pattern: "apiClient\\.bugs\\.getKPIs"
    - from: "KPIGrid"
      to: "KPICard"
      via: "imports and renders"
      pattern: "import.*KPICard"
---

<objective>
Create the main Bug Dashboard UI with KPI cards, filter dropdowns, and critical alert banner.

Purpose: Enable users to view DevOps bug metrics at a glance with visual status indicators and flexible filtering by component and week.

Output: Fully functional dashboard page with 9 KPI cards showing status colors, component filter, week filter, and critical alert banner for red zone KPIs.
</objective>

<execution_context>
@/Users/i306072/.claude/get-shit-done/workflows/execute-plan.md
@/Users/i306072/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-dashboard-ui/12-RESEARCH.md
@src/pages/BugDashboard.jsx
@src/api/apiClient.js
@src/components/ui/select.jsx
@src/components/ui/alert.jsx
@src/components/ui/card.jsx
@server/services/BugService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create KPICard component with status colors</name>
  <files>src/components/bugs/KPICard.jsx</files>
  <action>
Create a reusable KPICard component that displays a single KPI with status-based styling.

Include:
1. **STATUS_COLORS constant** with green/yellow/red/neutral variants:
   - green: bg-green-50, border-green-200, text-green-700, icon text-green-500
   - yellow: bg-yellow-50, border-yellow-200, text-yellow-700, icon text-yellow-500
   - red: bg-red-50, border-red-200, text-red-700, icon text-red-500
   - neutral: bg-gray-50, border-gray-200, text-gray-700, icon text-gray-500

2. **KPI_THRESHOLDS constant** with threshold values per KPI:
   - bug_inflow_rate: green <= 6, yellow <= 8, red > 8 (lower is better)
   - median_ttfr_hours: green < 24, yellow < 48, red >= 48 (lower is better)
   - sla_vh_percent: green >= 80, yellow >= 60, red < 60 (higher is better)
   - sla_high_percent: green >= 80, yellow >= 60, red < 60 (higher is better)
   - backlog_health_score: green >= 70, yellow >= 50, red < 50 (higher is better)
   - Note: Other KPIs (MTTR, category, workload) use neutral status

3. **getKPIStatus function** that determines status from KPI name and value:
   - Handle "lower is better" vs "higher is better" logic
   - Return 'green', 'yellow', 'red', or 'neutral'

4. **KPICard component** with props: title, value, unit, status, description, icon
   - Uses Card from shadcn/ui with status-colored background and border
   - Shows icon in top-right with status color
   - Large value display with unit suffix
   - Optional description text below value

Export: KPICard, getKPIStatus, STATUS_COLORS, KPI_THRESHOLDS
  </action>
  <verify>
Run `npm run build` - no TypeScript/import errors. Visually inspect component renders in isolation by temporarily adding to BugDashboard.
  </verify>
  <done>
KPICard component exists with status color logic, thresholds for 5 core KPIs, and proper styling following existing Card patterns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create KPIGrid and CriticalAlertBanner components</name>
  <files>src/components/bugs/KPIGrid.jsx, src/components/bugs/CriticalAlertBanner.jsx</files>
  <action>
**KPIGrid component (src/components/bugs/KPIGrid.jsx):**

Create a grid layout that renders all 9 KPIs from the kpis object.

1. Import KPICard, getKPIStatus from './KPICard'
2. Import icons from lucide-react: Bug, Clock, CheckCircle, AlertTriangle, BarChart2, Activity, PieChart, Users

3. Define KPI_CONFIG array with 9 KPI definitions:
   ```javascript
   const KPI_CONFIG = [
     { key: 'bug_inflow_rate', title: 'Bug Inflow Rate', unit: '/week', icon: Bug },
     { key: 'median_ttfr_hours', title: 'Time to First Response', unit: 'h median', icon: Clock },
     { key: 'sla_vh_percent', title: 'SLA Compliance (VH)', unit: '%', icon: CheckCircle },
     { key: 'sla_high_percent', title: 'SLA Compliance (High)', unit: '%', icon: CheckCircle },
     { key: 'backlog_health_score', title: 'Backlog Health', unit: '', icon: Activity },
     { key: 'open_bugs_count', title: 'Open Bugs', unit: '', icon: AlertTriangle },
     { key: 'automated_percent', title: 'Automated Ratio', unit: '%', icon: BarChart2 },
     { key: 'avg_bugs_per_week', title: 'Avg Bugs/Week', unit: '', icon: PieChart },
     { key: 'total_bugs', title: 'Total Bugs', unit: '', icon: Users },
   ];
   ```

4. KPIGrid component with props: kpis (object from API)
   - Render responsive grid: grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4
   - Map KPI_CONFIG to KPICard components
   - Handle null/undefined values gracefully (show '-' or 'N/A')
   - Format numbers: .toFixed(1) for decimals, Math.round() for percentages

**CriticalAlertBanner component (src/components/bugs/CriticalAlertBanner.jsx):**

1. Import Alert, AlertTitle, AlertDescription from '@/components/ui/alert'
2. Import AlertTriangle from lucide-react
3. Import getKPIStatus, KPI_THRESHOLDS from './KPICard'

4. Define KPI_LABELS map for human-readable names:
   ```javascript
   const KPI_LABELS = {
     bug_inflow_rate: 'Bug Inflow Rate',
     median_ttfr_hours: 'Time to First Response',
     sla_vh_percent: 'SLA Compliance (VH)',
     sla_high_percent: 'SLA Compliance (High)',
     backlog_health_score: 'Backlog Health'
   };
   ```

5. CriticalAlertBanner component with props: kpis
   - Check only KPIs that have thresholds (keys in KPI_THRESHOLDS)
   - Collect all KPIs where getKPIStatus returns 'red'
   - If no red KPIs, return null (no banner)
   - Render Alert with variant="destructive", AlertTriangle icon
   - Show count and list of critical KPIs

Export: KPIGrid from KPIGrid.jsx, CriticalAlertBanner from CriticalAlertBanner.jsx
  </action>
  <verify>
`npm run build` succeeds. Import components in BugDashboard and verify they render without errors.
  </verify>
  <done>
KPIGrid renders 9 KPI cards in responsive grid. CriticalAlertBanner shows destructive alert when any KPI is in red zone, hidden otherwise.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate filters and KPI display in BugDashboard</name>
  <files>src/pages/BugDashboard.jsx</files>
  <action>
Update the existing BugDashboard.jsx to replace the placeholder with full KPI dashboard functionality.

1. **Add imports:**
   - Select, SelectContent, SelectItem, SelectTrigger, SelectValue from '@/components/ui/select'
   - format from 'date-fns'
   - apiClient from '@/api/apiClient'
   - KPIGrid from '@/components/bugs/KPIGrid'
   - CriticalAlertBanner from '@/components/bugs/CriticalAlertBanner'
   - LoadingSpinner from '@/components/ui/LoadingSpinner'
   - Loader2 icon from lucide-react

2. **Add state variables:**
   ```javascript
   const [uploads, setUploads] = useState([]);
   const [selectedUploadId, setSelectedUploadId] = useState(null);
   const [selectedComponent, setSelectedComponent] = useState('all');
   const [kpis, setKPIs] = useState(null);
   const [loading, setLoading] = useState(true);
   const [error, setError] = useState(null);
   ```

3. **Fetch uploads on mount:**
   ```javascript
   useEffect(() => {
     async function loadUploads() {
       try {
         const uploadList = await apiClient.bugs.listUploads();
         setUploads(uploadList);
         // Auto-select most recent upload
         if (uploadList.length > 0) {
           setSelectedUploadId(uploadList[0].id);
         }
       } catch (err) {
         setError(err.message);
       } finally {
         setLoading(false);
       }
     }
     loadUploads();
   }, []);
   ```

4. **Fetch KPIs when upload or component changes:**
   ```javascript
   useEffect(() => {
     if (!selectedUploadId) {
       setKPIs(null);
       return;
     }
     async function loadKPIs() {
       setLoading(true);
       try {
         const kpiData = await apiClient.bugs.getKPIs(
           selectedUploadId,
           selectedComponent === 'all' ? null : selectedComponent
         );
         setKPIs(kpiData);
         setError(null);
       } catch (err) {
         setError(err.message);
       } finally {
         setLoading(false);
       }
     }
     loadKPIs();
   }, [selectedUploadId, selectedComponent]);
   ```

5. **Extract components list from KPIs:**
   ```javascript
   const components = kpis?.category_distribution
     ? Object.keys(kpis.category_distribution)
     : [];
   ```

6. **Update handleUploadComplete to refresh uploads:**
   ```javascript
   const handleUploadComplete = (result) => {
     setLastUpload(result);
     // Refresh uploads list and select new upload
     apiClient.bugs.listUploads().then(uploadList => {
       setUploads(uploadList);
       setSelectedUploadId(uploadList[0]?.id);
     });
   };
   ```

7. **Replace placeholder Card with dashboard UI:**
   - Show loading spinner while loading
   - Show error message if error
   - Show empty state if no uploads
   - Show filter bar with week and component dropdowns
   - Show CriticalAlertBanner
   - Show KPIGrid

Filter bar structure:
```jsx
<div className="flex gap-4 mb-6">
  {/* Week Filter */}
  <Select value={selectedUploadId || ''} onValueChange={setSelectedUploadId}>
    <SelectTrigger className="w-[220px]">
      <SelectValue placeholder="Select week" />
    </SelectTrigger>
    <SelectContent>
      {uploads.map(upload => (
        <SelectItem key={upload.id} value={upload.id}>
          Week of {format(new Date(upload.week_ending), 'MMM d, yyyy')}
        </SelectItem>
      ))}
    </SelectContent>
  </Select>

  {/* Component Filter */}
  <Select value={selectedComponent} onValueChange={setSelectedComponent}>
    <SelectTrigger className="w-[180px]">
      <SelectValue placeholder="All components" />
    </SelectTrigger>
    <SelectContent>
      <SelectItem value="all">All Components</SelectItem>
      {components.map(comp => (
        <SelectItem key={comp} value={comp}>
          {comp}
        </SelectItem>
      ))}
    </SelectContent>
  </Select>
</div>
```

Empty state when no uploads:
```jsx
<Card>
  <CardContent className="py-12 text-center">
    <Bug className="h-12 w-12 mx-auto text-muted-foreground mb-4" />
    <p className="text-muted-foreground mb-4">No bug data uploaded yet.</p>
    <Button onClick={() => setUploadDialogOpen(true)}>
      <Upload className="h-4 w-4 mr-2" />
      Upload Your First CSV
    </Button>
  </CardContent>
</Card>
```
  </action>
  <verify>
1. `npm run build` succeeds
2. Navigate to /bugs in browser
3. Verify week dropdown populates with uploaded weeks
4. Verify KPI cards display with correct values
5. Verify component filter updates KPIs
6. Verify alert banner appears when KPIs are in red zone
  </verify>
  <done>
BugDashboard shows filters and 9 KPI cards. Week filter loads historical data. Component filter updates all KPIs. Alert banner shows for red zone KPIs.
  </done>
</task>

</tasks>

<verification>
1. **Visual inspection:**
   - Navigate to /bugs page
   - Verify KPI cards display in responsive grid (4 cols on desktop, 1 on mobile)
   - Verify green/yellow/red status colors appear correctly based on thresholds

2. **Filter functionality:**
   - Change week dropdown - KPIs reload with new data
   - Change component dropdown - KPIs filter to selected component

3. **Alert banner:**
   - Upload data with a KPI in red zone (e.g., bug_inflow_rate > 8)
   - Verify alert banner appears with list of critical KPIs
   - Upload data with all KPIs in green/yellow - verify alert hidden

4. **Build verification:**
   - `npm run build` completes without errors
   - `npm test` passes (if tests exist)
</verification>

<success_criteria>
- [ ] KPICard component renders single KPI with status colors
- [ ] KPIGrid component renders 9 KPIs in responsive grid
- [ ] CriticalAlertBanner shows when any KPI in red zone
- [ ] Week filter dropdown populates from uploads API
- [ ] Week filter changes trigger KPI reload
- [ ] Component filter dropdown populates from category_distribution
- [ ] Component filter changes trigger KPI reload
- [ ] Empty state shown when no uploads exist
- [ ] Loading state shown during API calls
- [ ] `npm run build` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/12-dashboard-ui/12-01-SUMMARY.md`
</output>
