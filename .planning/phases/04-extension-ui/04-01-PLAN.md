---
phase: 04-extension-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - extension/service-worker.js
  - extension/popup/popup.html
  - extension/popup/popup.js
autonomous: true

must_haves:
  truths:
    - "Extension icon badge shows '...' during sync"
    - "Extension icon badge shows '!' on error"
    - "Extension icon badge is empty on success/idle"
    - "Popup shows 'Sync Now' button"
    - "Clicking 'Sync Now' triggers MANUAL_SYNC and updates UI"
    - "Popup updates automatically when sync status changes in background"
  artifacts:
    - path: "extension/service-worker.js"
      provides: "updateBadge function called on sync status changes"
      contains: "chrome.action.setBadgeText"
    - path: "extension/popup/popup.html"
      provides: "Sync Now button and syncing state CSS"
      contains: "syncBtn"
    - path: "extension/popup/popup.js"
      provides: "Manual sync trigger and storage listener"
      contains: "storage.onChanged"
  key_links:
    - from: "extension/service-worker.js"
      to: "chrome.action.setBadgeText"
      via: "updateBadge called after Storage.updateSyncStatus"
      pattern: "updateBadge.*status"
    - from: "extension/popup/popup.js"
      to: "service-worker.js"
      via: "chrome.runtime.sendMessage MANUAL_SYNC"
      pattern: "MANUAL_SYNC"
    - from: "extension/popup/popup.js"
      to: "chrome.storage.onChanged"
      via: "listener for lastSync changes"
      pattern: "onChanged.*lastSync"
---

<objective>
Add badge status indicator and manual sync button to complete extension UI.

Purpose: Users can see sync status at a glance (icon badge) and trigger manual syncs from popup without navigating to Jira.
Output: Popup with Sync Now button, reactive status updates, extension icon shows sync state via badge.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-extension-ui/04-RESEARCH.md

# Key existing files to modify
@extension/service-worker.js
@extension/popup/popup.html
@extension/popup/popup.js

# Reference for storage patterns
@extension/lib/storage.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add badge update function to service worker</name>
  <files>extension/service-worker.js</files>
  <action>
Add updateBadge function that sets badge text and color based on sync status:

```javascript
/**
 * Update extension icon badge based on sync status
 * @param {string} status - One of: 'never', 'syncing', 'success', 'error'
 */
async function updateBadge(status) {
  switch (status) {
    case 'syncing':
      await chrome.action.setBadgeText({ text: '...' });
      await chrome.action.setBadgeBackgroundColor({ color: '#2196F3' }); // Blue
      break;
    case 'success':
    case 'never':
      await chrome.action.setBadgeText({ text: '' }); // Clear badge
      break;
    case 'error':
      await chrome.action.setBadgeText({ text: '!' });
      await chrome.action.setBadgeBackgroundColor({ color: '#F44336' }); // Red
      break;
  }
}
```

Then add updateBadge calls after EVERY Storage.updateSyncStatus() call:

1. In handleSyncIssues - after `Storage.updateSyncStatus('syncing')` add: `await updateBadge('syncing');`
2. In handleSyncIssues - after `Storage.updateSyncStatus('success', ...)` add: `await updateBadge('success');`
3. In handleSyncIssues - after `Storage.updateSyncStatus('error', ...)` add: `await updateBadge('error');`

There are 3 locations in handleSyncIssues where Storage.updateSyncStatus is called. Each needs a corresponding updateBadge call immediately after.

Also add badge initialization on startup - in the onStartup listener, read current status and set badge:

```javascript
chrome.runtime.onStartup.addListener(async () => {
  console.log('[PE-Jira] Service worker started');
  // Restore badge state from storage
  const lastSync = await Storage.getLastSync();
  await updateBadge(lastSync.status);
});
```
  </action>
  <verify>
Load extension in chrome://extensions, open service worker console.
Run Storage.updateSyncStatus('syncing') in console - badge should show "..." in blue.
Run Storage.updateSyncStatus('error', null, 'test') in console - badge should show "!" in red.
Run Storage.updateSyncStatus('success', 5) in console - badge should be empty.
  </verify>
  <done>Badge updates automatically when sync status changes. Badge shows "..." (blue) while syncing, "!" (red) on error, empty on success.</done>
</task>

<task type="auto">
  <name>Task 2: Add Sync Now button and syncing state to popup HTML</name>
  <files>extension/popup/popup.html</files>
  <action>
Modify popup.html to add:

1. Add `.status.syncing` CSS class (blue color to match badge):
```css
.status.syncing { background: #e3f2fd; color: #1565c0; }
```

2. Add "Sync Now" button after "Test Connection" button:
```html
<button id="syncBtn">Sync Now</button>
```

3. Button should have same styling as other buttons (already styled via `button { width: 100%; ... }`)

Full button order should be:
- Test Connection (existing)
- Sync Now (new)
- Settings (existing)
  </action>
  <verify>
Open popup (click extension icon). Three buttons should appear: "Test Connection", "Sync Now", "Settings".
  </verify>
  <done>Popup shows Sync Now button with same styling as other buttons.</done>
</task>

<task type="auto">
  <name>Task 3: Add manual sync handler and reactive updates to popup JS</name>
  <files>extension/popup/popup.js</files>
  <action>
Modify popup.js to add:

1. Get reference to new sync button at top with other elements:
```javascript
const syncBtn = document.getElementById('syncBtn');
```

2. Add syncing state handling in loadStatus function. After the `else if (lastSync.status === 'error')` block, add handling for 'syncing':
```javascript
} else if (lastSync.status === 'syncing') {
  statusEl.className = 'status syncing';
  statusEl.textContent = 'Syncing...';
  infoEl.textContent = 'Sync in progress';
  syncBtn.disabled = true;
}
```

3. Also enable syncBtn in other status branches - add `syncBtn.disabled = false;` in the success, error, and 'never' branches.

4. Add sync button click handler (after testBtn handler):
```javascript
syncBtn.addEventListener('click', async () => {
  syncBtn.disabled = true;
  statusEl.className = 'status syncing';
  statusEl.textContent = 'Syncing...';
  infoEl.textContent = '';

  try {
    const response = await chrome.runtime.sendMessage({ type: 'MANUAL_SYNC' });

    if (response.success) {
      if (response.message) {
        // No pending issues to sync
        statusEl.className = 'status success';
        statusEl.textContent = response.message;
      }
      // Status will update via storage listener
    } else {
      statusEl.className = 'status error';
      statusEl.textContent = 'Sync failed';
      infoEl.textContent = response.error;
    }
  } catch (error) {
    showError(error.message);
  } finally {
    syncBtn.disabled = false;
  }
});
```

5. Add storage change listener at the end of the file (before closing or after all other code):
```javascript
// Listen for sync status changes from background
chrome.storage.onChanged.addListener((changes, namespace) => {
  if (namespace === 'local' && changes.lastSync) {
    const newStatus = changes.lastSync.newValue;
    updateStatusFromSync(newStatus);
  }
});

function updateStatusFromSync(lastSync) {
  if (lastSync.status === 'syncing') {
    statusEl.className = 'status syncing';
    statusEl.textContent = 'Syncing...';
    infoEl.textContent = 'Sync in progress';
    syncBtn.disabled = true;
  } else if (lastSync.status === 'success') {
    statusEl.className = 'status success';
    statusEl.textContent = `Last sync: ${formatTime(lastSync.timestamp)}`;
    infoEl.textContent = `${lastSync.issueCount} issues synced`;
    syncBtn.disabled = false;
  } else if (lastSync.status === 'error') {
    statusEl.className = 'status error';
    statusEl.textContent = 'Sync failed';
    infoEl.textContent = lastSync.error || 'Unknown error';
    syncBtn.disabled = false;
  }
}
```

This ensures:
- Popup updates immediately when user clicks Sync Now
- Popup updates automatically if sync happens from content script while popup is open
- Button is disabled during sync to prevent double-clicks
  </action>
  <verify>
1. Click extension icon to open popup
2. Click "Sync Now" - should show "Syncing..." status
3. If no pending issues, shows "No pending issues to sync"
4. If there are pending issues and backend configured, should sync and update status

To test reactive updates:
1. Open popup
2. In another tab, browse to Jira board to trigger automatic sync
3. Popup should update without needing to close/reopen
  </verify>
  <done>Sync Now button triggers MANUAL_SYNC message. Popup shows syncing state. Storage listener provides reactive updates when sync status changes in background.</done>
</task>

</tasks>

<verification>
All Phase 4 success criteria verified:

1. **Popup displays current sync status (syncing, success, error, stale):**
   - Open popup, status shows based on lastSync in storage

2. **Popup shows last sync timestamp:**
   - Open popup after successful sync, shows "Last sync: [time]"

3. **User can trigger manual sync from popup:**
   - Click "Sync Now" button, MANUAL_SYNC message sent to service worker

4. **Options page allows configuring backend URL and auth token:**
   - Already complete from Phase 2 (no changes needed)

5. **Extension icon badge shows sync state at a glance:**
   - "..." (blue) during sync
   - "!" (red) on error
   - Empty on success/idle

```bash
# Verification commands (run in Chrome)
# 1. Load extension: chrome://extensions -> Load unpacked -> select extension/ folder
# 2. Open popup, verify 3 buttons visible
# 3. Open service worker console (chrome://extensions -> Details -> Service worker)
# 4. Test badge: Run "await updateBadge('syncing')" in console
# 5. Click Sync Now in popup, observe status change
```
</verification>

<success_criteria>
- [ ] Extension badge shows "..." (blue) when status is 'syncing'
- [ ] Extension badge shows "!" (red) when status is 'error'
- [ ] Extension badge is empty when status is 'success' or 'never'
- [ ] Popup has "Sync Now" button
- [ ] Clicking "Sync Now" sends MANUAL_SYNC message and updates UI
- [ ] Popup auto-updates when sync status changes via storage.onChanged
- [ ] Button is disabled during sync to prevent double-clicks
</success_criteria>

<output>
After completion, create `.planning/phases/04-extension-ui/04-01-SUMMARY.md`
</output>
