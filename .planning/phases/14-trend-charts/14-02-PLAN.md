---
phase: 14-trend-charts
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/bugs/KPISparkline.jsx
  - src/components/bugs/KPICard.jsx
  - src/components/bugs/KPIGrid.jsx
autonomous: true

must_haves:
  truths:
    - "KPI cards display sparklines showing mini trend visualization"
    - "KPI cards show trend direction indicators (up/down/flat arrows)"
    - "Sparklines show last 4 weeks of data"
    - "Trend arrows accurately reflect direction of change"
  artifacts:
    - path: "src/components/bugs/KPISparkline.jsx"
      provides: "Mini sparkline component using Recharts"
      exports: ["KPISparkline"]
    - path: "src/components/bugs/KPICard.jsx"
      provides: "Enhanced KPICard with sparkline and trend arrow props"
      contains: "TrendArrow"
    - path: "src/components/bugs/KPIGrid.jsx"
      provides: "KPIGrid fetching history data and passing to cards"
      contains: "getKPIHistory"
  key_links:
    - from: "src/components/bugs/KPIGrid.jsx"
      to: "/api/bugs/kpis/history"
      via: "apiClient.bugs.getKPIHistory"
      pattern: "apiClient\\.bugs\\.getKPIHistory"
    - from: "src/components/bugs/KPICard.jsx"
      to: "src/components/bugs/KPISparkline.jsx"
      via: "component import and render"
      pattern: "<KPISparkline"
---

<objective>
Add sparkline visualizations and trend direction arrows to KPI cards for at-a-glance trend awareness.

Purpose: Give users immediate visual feedback on whether each KPI is trending up, down, or flat without needing to interact with the full trend chart.

Output: KPI cards enhanced with sparklines and trend arrows, fetching last 4 weeks of history data.
</objective>

<execution_context>
@/Users/i306072/.claude/get-shit-done/workflows/execute-plan.md
@/Users/i306072/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-historical-kpi-storage/13-01-SUMMARY.md

# Existing KPI components
@src/components/bugs/KPICard.jsx
@src/components/bugs/KPIGrid.jsx

# API client (has getKPIHistory from 14-01)
@src/api/apiClient.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create KPISparkline component</name>
  <files>src/components/bugs/KPISparkline.jsx</files>
  <action>
Create KPISparkline.jsx - a minimal sparkline component using Recharts.

Component requirements:
1. Uses Recharts LineChart with no axes, no grid, no tooltip
2. Renders as inline visualization (width: 60px, height: 24px)
3. Line color inherits from parent (use prop)
4. Minimal configuration for performance

Props:
- data: Array of numbers (4 values for 4 weeks)
- color: Line color string (default: '#6b7280' gray-500)

Implementation:
```jsx
import { ResponsiveContainer, LineChart, Line } from 'recharts';

export function KPISparkline({ data = [], color = '#6b7280' }) {
  // Transform array to Recharts format
  const chartData = data.map((value, index) => ({ value, index }));

  if (chartData.length < 2) {
    return null; // Need at least 2 points for a line
  }

  return (
    <div className="w-[60px] h-[24px]">
      <ResponsiveContainer width="100%" height="100%">
        <LineChart data={chartData}>
          <Line
            type="monotone"
            dataKey="value"
            stroke={color}
            strokeWidth={1.5}
            dot={false}
            isAnimationActive={false}
          />
        </LineChart>
      </ResponsiveContainer>
    </div>
  );
}
```

Export the component.
  </action>
  <verify>
Review KPISparkline.jsx and confirm:
- Uses Recharts LineChart
- No axes, grid, or tooltip (minimal)
- Accepts data array and color props
- Has fixed width/height for consistent sizing
  </verify>
  <done>KPISparkline component renders mini line chart from data array</done>
</task>

<task type="auto">
  <name>Task 2: Enhance KPICard with sparkline and trend arrow</name>
  <files>src/components/bugs/KPICard.jsx</files>
  <action>
Enhance KPICard.jsx to accept and display sparkline data and trend direction.

1. Import KPISparkline and arrow icons:
```javascript
import { KPISparkline } from './KPISparkline';
import { TrendingUp, TrendingDown, Minus } from 'lucide-react';
```

2. Add new props to KPICard:
- historyData: Array of numbers (last 4 weeks of values)
- trend: 'up' | 'down' | 'flat' | null

3. Add TrendArrow helper function:
```javascript
function TrendArrow({ trend, status }) {
  if (!trend) return null;

  const colors = STATUS_COLORS[status] || STATUS_COLORS.neutral;
  const iconClass = `h-4 w-4 ${colors.icon}`;

  switch (trend) {
    case 'up':
      return <TrendingUp className={iconClass} />;
    case 'down':
      return <TrendingDown className={iconClass} />;
    case 'flat':
      return <Minus className={iconClass} />;
    default:
      return null;
  }
}
```

4. Modify KPICard layout to include sparkline and trend arrow:
- Add sparkline next to the value display
- Add trend arrow in the header area (next to or replacing icon position)

Layout adjustment:
```jsx
{/* Value Display with Sparkline */}
<div className="flex items-center gap-2">
  <div className="flex items-baseline gap-1">
    <span className={`text-3xl font-bold ${colors.text}`}>
      {displayValue}
    </span>
    {unit && displayValue !== '-' && (
      <span className={`text-sm ${colors.text} opacity-70`}>
        {unit}
      </span>
    )}
  </div>
  {historyData && historyData.length > 1 && (
    <KPISparkline data={historyData} color={colors.icon.replace('text-', '')} />
  )}
</div>

{/* Trend Arrow in header */}
<div className="absolute top-4 right-4 flex items-center gap-1">
  <TrendArrow trend={trend} status={status} />
  {Icon && <Icon className={`h-5 w-5 ${colors.icon}`} />}
</div>
```

5. Export calculateTrend helper for use by KPIGrid:
```javascript
/**
 * Calculate trend direction from history data
 * @param {number[]} data - Array of values (oldest to newest)
 * @param {string} kpiKey - KPI key to determine if lower is better
 * @returns {'up' | 'down' | 'flat' | null}
 */
export function calculateTrend(data, kpiKey) {
  if (!data || data.length < 2) return null;

  const recent = data[data.length - 1];
  const previous = data[data.length - 2];

  if (recent === null || previous === null) return null;

  const threshold = KPI_THRESHOLDS[kpiKey];
  const changePercent = Math.abs((recent - previous) / (previous || 1)) * 100;

  // Less than 5% change is considered flat
  if (changePercent < 5) return 'flat';

  // For "lower is better" KPIs, down is good (up), up is bad (down)
  // For "higher is better" KPIs, up is good, down is bad
  // Return actual direction, let visual indicator show good/bad via color
  return recent > previous ? 'up' : 'down';
}
```
  </action>
  <verify>
Review KPICard.jsx and confirm:
- Accepts historyData and trend props
- Renders KPISparkline when historyData provided
- Renders TrendArrow when trend provided
- calculateTrend function exported
- Existing KPICard functionality preserved
  </verify>
  <done>KPICard displays sparkline and trend arrow when data provided</done>
</task>

<task type="auto">
  <name>Task 3: Update KPIGrid to fetch history and calculate trends</name>
  <files>src/components/bugs/KPIGrid.jsx</files>
  <action>
Update KPIGrid.jsx to fetch 4-week KPI history and pass data to each KPICard.

1. Add imports:
```javascript
import { useState, useEffect } from 'react';
import { apiClient } from '@/api/apiClient';
import { calculateTrend } from './KPICard';
```

2. Add props for component filter:
```javascript
export function KPIGrid({ kpis, component = null }) {
```

3. Add state and effect for history data:
```javascript
const [historyData, setHistoryData] = useState({});

useEffect(() => {
  async function loadHistory() {
    try {
      const history = await apiClient.bugs.getKPIHistory(4, component);

      // Transform history into per-KPI arrays
      // history is sorted DESC (newest first), reverse for sparkline (oldest to newest)
      const kpiHistory = {};
      const reversedHistory = [...history].reverse();

      for (const config of KPI_CONFIG) {
        kpiHistory[config.key] = reversedHistory.map(h => h.kpi_data[config.key] ?? null);
      }

      setHistoryData(kpiHistory);
    } catch (error) {
      console.error('Failed to load KPI history:', error);
      setHistoryData({});
    }
  }

  loadHistory();
}, [component]);
```

4. Update KPICard rendering to include history and trend:
```javascript
return (
  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
    {KPI_CONFIG.map((config) => {
      const value = kpis[config.key];
      const formattedValue = formatValue(value, config.key);
      const status = getKPIStatus(config.key, value);
      const kpiHistoryData = historyData[config.key] || [];
      const trend = calculateTrend(kpiHistoryData, config.key);

      return (
        <KPICard
          key={config.key}
          title={config.title}
          value={formattedValue}
          unit={config.unit}
          status={status}
          description={config.description}
          icon={config.icon}
          historyData={kpiHistoryData}
          trend={trend}
        />
      );
    })}
  </div>
);
```

5. Update BugDashboard.jsx to pass component prop to KPIGrid:
The BugDashboard already has selectedComponent state. Update the KPIGrid usage:
```jsx
<KPIGrid
  kpis={kpis}
  component={selectedComponent === 'all' ? null : selectedComponent}
/>
```
  </action>
  <verify>
Review KPIGrid.jsx and confirm:
- Fetches 4-week history via apiClient.bugs.getKPIHistory
- Transforms history data into per-KPI arrays
- Passes historyData and trend to each KPICard
- Handles loading/error states gracefully
  </verify>
  <done>KPIGrid fetches history data and passes sparkline data and trends to cards</done>
</task>

</tasks>

<verification>
After all tasks:
1. `npm run dev` - Start development server
2. Navigate to Bug Dashboard
3. Upload CSV if no data exists (need 4+ weeks for sparklines)
4. Verify each KPI card shows:
   - Sparkline next to value (if 2+ data points)
   - Trend arrow in header
5. Test component filter - sparklines should update
6. Verify sparkline direction matches actual trend
</verification>

<success_criteria>
- [ ] KPISparkline component renders mini line chart
- [ ] KPICard accepts and renders historyData as sparkline
- [ ] KPICard accepts and renders trend arrow
- [ ] calculateTrend function correctly identifies up/down/flat
- [ ] KPIGrid fetches 4-week history on mount
- [ ] KPIGrid passes history data to each card
- [ ] Sparklines visible on KPI cards (when data exists)
- [ ] Trend arrows visible on KPI cards (when data exists)
</success_criteria>

<output>
After completion, create `.planning/phases/14-trend-charts/14-02-SUMMARY.md`
</output>
