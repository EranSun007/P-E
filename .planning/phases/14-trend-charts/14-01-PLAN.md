---
phase: 14-trend-charts
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/bugs/KPITrendChart.jsx
  - src/api/apiClient.js
  - src/pages/BugDashboard.jsx
autonomous: true

must_haves:
  truths:
    - "User can view line chart showing any KPI across multiple weeks"
    - "User can switch between KPIs using dropdown selector"
    - "User can select time range (4, 8, or 12 weeks)"
    - "Chart displays colored threshold bands (green/yellow/red zones)"
    - "Hovering over data point shows exact KPI value and date"
  artifacts:
    - path: "src/components/bugs/KPITrendChart.jsx"
      provides: "Recharts LineChart with KPI selector, time range selector, threshold zones, custom tooltip"
      exports: ["KPITrendChart"]
    - path: "src/api/apiClient.js"
      provides: "getKPIHistory method in bugs namespace"
      contains: "getKPIHistory"
  key_links:
    - from: "src/components/bugs/KPITrendChart.jsx"
      to: "/api/bugs/kpis/history"
      via: "apiClient.bugs.getKPIHistory"
      pattern: "apiClient\\.bugs\\.getKPIHistory"
    - from: "src/pages/BugDashboard.jsx"
      to: "src/components/bugs/KPITrendChart.jsx"
      via: "component import and render"
      pattern: "<KPITrendChart"
---

<objective>
Create KPITrendChart component with Recharts LineChart, KPI selector, time range selector, threshold bands, and custom tooltip.

Purpose: Enable users to visualize KPI trends over time to identify patterns and performance degradation before it becomes critical.

Output: Working trend chart component integrated into BugDashboard with full interactivity.
</objective>

<execution_context>
@/Users/i306072/.claude/get-shit-done/workflows/execute-plan.md
@/Users/i306072/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-historical-kpi-storage/13-01-SUMMARY.md

# Existing chart patterns
@src/components/bugs/MTTRBarChart.jsx
@src/components/bugs/BugCategoryChart.jsx
@src/components/bugs/KPICard.jsx

# API and dashboard
@src/api/apiClient.js
@src/pages/BugDashboard.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add getKPIHistory to apiClient</name>
  <files>src/api/apiClient.js</files>
  <action>
Add getKPIHistory method to the bugs namespace in apiClient.js.

Method signature:
```javascript
async getKPIHistory(weeks = 12, component = null) {
  let url = `${API_BASE_URL}/bugs/kpis/history?weeks=${weeks}`;
  if (component) url += `&component=${encodeURIComponent(component)}`;
  return fetchWithAuth(url);
}
```

Add this method inside the `bugs: { ... }` object, after the existing getKPIsByDateRange method.
  </action>
  <verify>
Review apiClient.js and confirm:
- getKPIHistory method exists in bugs namespace
- Accepts weeks and component parameters
- Constructs URL matching backend endpoint
  </verify>
  <done>apiClient.bugs.getKPIHistory(weeks, component) can be called from frontend</done>
</task>

<task type="auto">
  <name>Task 2: Create KPITrendChart component</name>
  <files>src/components/bugs/KPITrendChart.jsx</files>
  <action>
Create KPITrendChart.jsx following existing chart patterns (MTTRBarChart, BugCategoryChart).

Component structure:
1. **State:** selectedKPI, selectedWeeks, historyData, loading
2. **KPI selector dropdown** with options:
   - bug_inflow_rate (Bug Inflow Rate)
   - median_ttfr_hours (Time to First Response)
   - sla_vh_percent (SLA Compliance VH)
   - sla_high_percent (SLA Compliance High)
   - backlog_health_score (Backlog Health)
3. **Week range selector** with options: 4, 8, 12 weeks
4. **Recharts LineChart** with:
   - XAxis: week_ending dates (format: "MMM d")
   - YAxis: KPI value
   - ReferenceArea components for threshold bands (use KPI_THRESHOLDS from KPICard.jsx)
   - Line with dots for data points
5. **Custom Tooltip** showing:
   - Week ending date (full format: "MMM d, yyyy")
   - KPI name and exact value with unit

Data fetching:
- useEffect fetches data when selectedKPI, selectedWeeks, or component prop changes
- Call apiClient.bugs.getKPIHistory(weeks, component)
- Transform data: extract selectedKPI value from each kpi_data object
- Sort by week_ending ascending for chart X-axis

Threshold bands (ReferenceArea):
- Import KPI_THRESHOLDS from KPICard.jsx
- For each KPI, render:
  - Green band: y1=0 (or threshold.green for higher_is_better), y2=threshold.green
  - Yellow band: y1=threshold.green, y2=threshold.yellow
  - Red band: y1=threshold.yellow, y2={max value + buffer}
- Use fillOpacity="0.15" for subtle visual effect

Colors:
- Green: #22c55e (green-500)
- Yellow: #eab308 (yellow-500)
- Red: #ef4444 (red-500)
- Line: #3b82f6 (blue-500)

Props:
- component: optional component filter (passed from parent)

Card wrapper following existing pattern:
```jsx
<Card>
  <CardHeader>
    <div className="flex items-center justify-between">
      <CardTitle>KPI Trend</CardTitle>
      <div className="flex gap-2">
        {/* KPI selector */}
        {/* Week selector */}
      </div>
    </div>
  </CardHeader>
  <CardContent>
    {/* Chart */}
  </CardContent>
</Card>
```
  </action>
  <verify>
Review KPITrendChart.jsx and confirm:
- Component renders Recharts LineChart
- KPI dropdown allows switching between 5 KPIs
- Week dropdown offers 4/8/12 options
- ReferenceArea components create threshold bands
- Custom tooltip shows date and value
- Loading state handled
- Error state handled
  </verify>
  <done>KPITrendChart component exists with LineChart, selectors, threshold bands, and tooltip</done>
</task>

<task type="auto">
  <name>Task 3: Integrate KPITrendChart into BugDashboard</name>
  <files>src/pages/BugDashboard.jsx</files>
  <action>
Import and add KPITrendChart to BugDashboard.jsx.

1. Add import:
```javascript
import { KPITrendChart } from '@/components/bugs/KPITrendChart';
```

2. Add component after KPIGrid and before Charts Row:
```jsx
{/* KPI Grid */}
{kpis ? (
  <>
    <KPIGrid kpis={kpis} />

    {/* KPI Trend Chart */}
    <KPITrendChart
      component={selectedComponent === 'all' ? null : selectedComponent}
    />

    {/* Charts Row */}
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
```

Position KPITrendChart as a full-width card between KPIGrid and the Charts Row.
  </action>
  <verify>
Run development server and verify:
- KPITrendChart appears on BugDashboard
- Component filter in dashboard affects chart data
- Chart loads historical data on mount
  </verify>
  <done>BugDashboard displays KPITrendChart with component filter integration</done>
</task>

</tasks>

<verification>
After all tasks:
1. `npm run dev` - Start development server
2. Navigate to Bug Dashboard
3. Verify trend chart appears below KPI cards
4. Test KPI dropdown - switching KPIs updates chart
5. Test week dropdown - 4/8/12 weeks changes data range
6. Test component filter - selecting component filters trend data
7. Verify threshold bands visible as colored regions
8. Hover over data points - tooltip shows date and value
</verification>

<success_criteria>
- [ ] apiClient.bugs.getKPIHistory method exists and works
- [ ] KPITrendChart renders with LineChart
- [ ] KPI selector dropdown with 5 KPI options
- [ ] Week selector dropdown with 4/8/12 options
- [ ] Threshold bands (ReferenceArea) visible
- [ ] Custom tooltip shows date and KPI value
- [ ] Chart integrated into BugDashboard
- [ ] Component filter affects chart data
</success_criteria>

<output>
After completion, create `.planning/phases/14-trend-charts/14-01-SUMMARY.md`
</output>
