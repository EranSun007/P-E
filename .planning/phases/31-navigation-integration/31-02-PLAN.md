---
phase: 31-navigation-integration
plan: 02
type: execute
wave: 2
depends_on: ["31-01"]
files_modified:
  - src/components/navigation/HierarchicalNavigation.jsx
  - src/pages/Layout.jsx
autonomous: true

must_haves:
  truths:
    - "Sidebar displays folders as collapsible groups with nested menu items"
    - "User can click folder header to expand/collapse nested items"
    - "Items not assigned to any folder display at root level"
    - "Folders work correctly in both People and Product navigation modes"
    - "Expand/collapse animation is smooth (CSS transition)"
  artifacts:
    - path: "src/components/navigation/HierarchicalNavigation.jsx"
      provides: "Groups navigation items by folder and renders hierarchically"
      exports: ["HierarchicalNavigation"]
    - path: "src/pages/Layout.jsx"
      provides: "Integrated hierarchical navigation in sidebar"
      contains: "HierarchicalNavigation"
  key_links:
    - from: "src/components/navigation/HierarchicalNavigation.jsx"
      to: "src/contexts/NavigationContext.jsx"
      via: "useNavigation hook"
      pattern: "useNavigation"
    - from: "src/components/navigation/HierarchicalNavigation.jsx"
      to: "src/components/navigation/CollapsibleFolder.jsx"
      via: "CollapsibleFolder component"
      pattern: "CollapsibleFolder"
    - from: "src/pages/Layout.jsx"
      to: "src/components/navigation/HierarchicalNavigation.jsx"
      via: "HierarchicalNavigation import"
      pattern: "HierarchicalNavigation"
---

<objective>
Create HierarchicalNavigation component and integrate it into Layout.jsx to replace the flat navigation list with collapsible folder groups.

Purpose: Complete the navigation integration by connecting NavigationContext configuration to the sidebar rendering.
Output: Sidebar displays collapsible folder groups with nested items, root-level items outside folders, smooth animations.
</objective>

<execution_context>
@/Users/i306072/.claude/get-shit-done/workflows/execute-plan.md
@/Users/i306072/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-navigation-integration/31-RESEARCH.md
@.planning/phases/31-navigation-integration/31-01-SUMMARY.md

# Source files
@src/contexts/NavigationContext.jsx
@src/contexts/AppModeContext.jsx
@src/pages/Layout.jsx
@src/components/navigation/CollapsibleFolder.jsx
@src/hooks/useCollapsedFolders.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create HierarchicalNavigation Component</name>
  <files>src/components/navigation/HierarchicalNavigation.jsx</files>
  <action>
Create HierarchicalNavigation component at src/components/navigation/HierarchicalNavigation.jsx that groups navigation items by folder and renders them hierarchically.

Implementation:
1. Import required dependencies:
   - Link from 'react-router-dom'
   - cn from '@/lib/utils'
   - useNavigation from '@/contexts/NavigationContext'
   - useAppMode from '@/contexts/AppModeContext'
   - CollapsibleFolder from '@/components/navigation/CollapsibleFolder'

2. Component props:
   - navigation: Array of nav items from Layout.jsx (peopleNavigation or productNavigation)
   - onItemClick: Callback when item clicked (for closing mobile sidebar)

3. Core grouping logic:
   ```javascript
   // Get folders and items from NavigationContext
   const { folders, items } = useNavigation();
   const { isProductMode } = useAppMode();

   // Create ID map for navigation items (use item.name as ID since Layout.jsx items don't have explicit IDs)
   // Group navigation items by folder
   const itemsByFolder = navigation.reduce((acc, navItem) => {
     // Match by name since that's the identifier used in NavigationSettings
     const assignment = items.find(i => i.itemId === navItem.name);
     const folderId = assignment?.folderId || 'root';
     if (!acc[folderId]) acc[folderId] = [];
     acc[folderId].push(navItem);
     return acc;
   }, {});

   // Sort folders by order field
   const sortedFolders = [...folders].sort((a, b) => a.order - b.order);
   ```

4. Render structure:
   - Map over sortedFolders, render CollapsibleFolder for each with its items
   - After folders, render root-level items (itemsByFolder.root)
   - Use same Link styling as current Layout.jsx (lines 302-319)

5. Link styling (copy from Layout.jsx):
   ```jsx
   <Link
     to={item.href}
     onClick={onItemClick}
     className={cn(
       "flex items-center px-4 py-3 text-sm font-medium rounded-md transition-colors duration-200",
       isProductMode
         ? item.current
           ? "bg-purple-900/50 text-purple-300"
           : "text-gray-300 hover:bg-gray-800 hover:text-white"
         : item.current
           ? "bg-indigo-50 text-indigo-700"
           : "text-gray-700 hover:bg-gray-100"
     )}
   >
     <item.icon className="h-5 w-5 mr-3" />
     {item.name}
   </Link>
   ```

Export as named export: export function HierarchicalNavigation
  </action>
  <verify>
1. File exists at src/components/navigation/HierarchicalNavigation.jsx
2. Exports HierarchicalNavigation function
3. No syntax errors: `npm run lint -- src/components/navigation/HierarchicalNavigation.jsx`
  </verify>
  <done>
HierarchicalNavigation groups navigation items by folder, renders CollapsibleFolder for each folder, root items at bottom.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate HierarchicalNavigation into Layout.jsx</name>
  <files>src/pages/Layout.jsx</files>
  <action>
Modify Layout.jsx to use HierarchicalNavigation instead of flat navigation.map().

Changes to make:

1. Add import at top of file:
   ```javascript
   import { HierarchicalNavigation } from "@/components/navigation/HierarchicalNavigation";
   ```

2. Replace the navigation rendering block (lines 299-322):

   Current code:
   ```jsx
   <nav className="flex-1 p-4 overflow-y-auto">
     <div className="space-y-1">
       {navigation.map((item) => (
         <Link
           key={item.name}
           to={item.href}
           ...
         >
           ...
         </Link>
       ))}
     </div>
   </nav>
   ```

   New code:
   ```jsx
   <nav className="flex-1 p-4 overflow-y-auto">
     <div className="space-y-1">
       <HierarchicalNavigation
         navigation={navigation}
         onItemClick={() => setSidebarOpen(false)}
       />
     </div>
   </nav>
   ```

3. Keep everything else in Layout.jsx unchanged:
   - peopleNavigation and productNavigation arrays remain as-is (these are passed to HierarchicalNavigation)
   - Settings link and Logout button remain outside HierarchicalNavigation (they're in the footer section)
   - All other sidebar structure remains identical

The key change is replacing `navigation.map()` with `<HierarchicalNavigation />`.
  </action>
  <verify>
1. Layout.jsx imports HierarchicalNavigation
2. HierarchicalNavigation is rendered in the nav section
3. No syntax errors: `npm run lint -- src/pages/Layout.jsx`
4. Frontend starts without errors: `npm run dev:client` (check console)
5. Navigate to app, sidebar renders navigation items (may be flat if no folders configured)
  </verify>
  <done>
Layout.jsx uses HierarchicalNavigation, sidebar renders collapsible folder groups when folders are configured, falls back to flat list when no folders exist.
  </done>
</task>

</tasks>

<verification>
1. Both files updated with proper exports/imports
2. No lint errors in modified files
3. Frontend starts without console errors
4. Sidebar renders navigation (flat list if no folders, grouped if folders configured)
5. Clicking folder header expands/collapses items
6. Chevron rotates smoothly on expand/collapse
7. State persists across page reload (check localStorage for pe_manager_nav_collapsed_folders_*)
8. Works in both People mode and Product mode
</verification>

<success_criteria>
- HierarchicalNavigation groups items by NavigationContext folders
- Layout.jsx renders HierarchicalNavigation instead of flat navigation.map()
- Collapsible folders expand/collapse with smooth animation
- Root-level items (not in folders) display after folders
- Mode switching (People/Product) shows correct navigation with folders
- Collapse state persists in localStorage per mode
</success_criteria>

<output>
After completion, create `.planning/phases/31-navigation-integration/31-02-SUMMARY.md`
</output>
