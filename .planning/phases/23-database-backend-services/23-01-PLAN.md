---
phase: 23-database-backend-services
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/db/022_sync_items.sql
  - server/db/migrate.js
autonomous: true

must_haves:
  truths:
    - "Projects table has sync-specific columns (category, sync_status, team_department, is_sync_item, status_history)"
    - "Tasks table has subtask columns (project_id FK with CASCADE DELETE, is_subtask, completed, display_order)"
    - "Team_members table has display_order and updated_date columns"
    - "sync_settings table exists for user preferences"
    - "All new columns have appropriate indexes for query performance"
    - "Updated_date triggers fire on projects, team_members, and sync_settings"
  artifacts:
    - path: "server/db/022_sync_items.sql"
      provides: "Schema extension migration for sync items, subtasks, and settings"
      contains: "ALTER TABLE projects ADD COLUMN IF NOT EXISTS category"
    - path: "server/db/migrate.js"
      provides: "Migration runner with 022_sync_items entry"
      contains: "022_sync_items"
  key_links:
    - from: "server/db/migrate.js"
      to: "server/db/022_sync_items.sql"
      via: "MIGRATIONS array entry"
      pattern: "file: '022_sync_items.sql'"
    - from: "server/db/022_sync_items.sql"
      to: "projects table"
      via: "ALTER TABLE statements"
      pattern: "ALTER TABLE projects"
    - from: "server/db/022_sync_items.sql"
      to: "tasks table"
      via: "ALTER TABLE with FK"
      pattern: "REFERENCES projects\\(id\\) ON DELETE CASCADE"
---

<objective>
Create database schema migration extending projects, tasks, and team_members tables with sync item columns and creating sync_settings table.

Purpose: Phase 23 requires the schema foundation before services can be implemented. This migration adds all columns needed for sync items (goals, blockers, dependencies, emphasis), subtasks, and user settings.

Output: Migration file 022_sync_items.sql with all schema changes, added to migrate.js
</objective>

<execution_context>
@/Users/i306072/.claude/get-shit-done/workflows/execute-plan.md
@/Users/i306072/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/v1.6-ROADMAP.md
@.planning/v1.6-REQUIREMENTS.md
@.planning/phases/23-database-backend-services/23-RESEARCH.md

# Existing patterns to follow:
@server/db/migrate.js
@server/db/019_bug_dashboard.sql
@server/db/007_one_on_ones_extended.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create 022_sync_items.sql migration</name>
  <files>server/db/022_sync_items.sql</files>
  <action>
Create migration file `server/db/022_sync_items.sql` with the following schema changes:

**Projects table extensions (for sync items):**
```sql
-- Sync item specific columns
ALTER TABLE projects ADD COLUMN IF NOT EXISTS category VARCHAR(100);
ALTER TABLE projects ADD COLUMN IF NOT EXISTS sync_status VARCHAR(50) DEFAULT 'not-started';
ALTER TABLE projects ADD COLUMN IF NOT EXISTS team_department VARCHAR(255);
ALTER TABLE projects ADD COLUMN IF NOT EXISTS assigned_to_id UUID REFERENCES team_members(id) ON DELETE SET NULL;
ALTER TABLE projects ADD COLUMN IF NOT EXISTS sprint_id VARCHAR(50);
ALTER TABLE projects ADD COLUMN IF NOT EXISTS week_start_date DATE;
ALTER TABLE projects ADD COLUMN IF NOT EXISTS status_history JSONB DEFAULT '[]';
ALTER TABLE projects ADD COLUMN IF NOT EXISTS archived BOOLEAN DEFAULT false;
ALTER TABLE projects ADD COLUMN IF NOT EXISTS is_sync_item BOOLEAN DEFAULT false;
ALTER TABLE projects ADD COLUMN IF NOT EXISTS display_order INTEGER DEFAULT 0;
```

**Tasks table extensions (for subtasks):**
```sql
ALTER TABLE tasks ADD COLUMN IF NOT EXISTS project_id UUID REFERENCES projects(id) ON DELETE CASCADE;
ALTER TABLE tasks ADD COLUMN IF NOT EXISTS is_subtask BOOLEAN DEFAULT false;
ALTER TABLE tasks ADD COLUMN IF NOT EXISTS completed BOOLEAN DEFAULT false;
ALTER TABLE tasks ADD COLUMN IF NOT EXISTS display_order INTEGER DEFAULT 0;
```

**Team members table extensions:**
```sql
ALTER TABLE team_members ADD COLUMN IF NOT EXISTS display_order INTEGER DEFAULT 0;
-- Note: updated_date likely exists, add trigger if not present
```

**Sync settings table (new):**
```sql
CREATE TABLE IF NOT EXISTS sync_settings (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id VARCHAR(255) NOT NULL UNIQUE,
  sprint_weeks INTEGER DEFAULT 2,
  default_view VARCHAR(50) DEFAULT 'sprint',
  default_team VARCHAR(255),
  settings_data JSONB DEFAULT '{}',
  created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**Indexes for query performance:**
```sql
-- Projects indexes
CREATE INDEX IF NOT EXISTS idx_projects_category ON projects(category);
CREATE INDEX IF NOT EXISTS idx_projects_sync_status ON projects(sync_status);
CREATE INDEX IF NOT EXISTS idx_projects_team_department ON projects(team_department);
CREATE INDEX IF NOT EXISTS idx_projects_is_sync_item ON projects(is_sync_item);
CREATE INDEX IF NOT EXISTS idx_projects_archived ON projects(archived);
CREATE INDEX IF NOT EXISTS idx_projects_is_sync_archived ON projects(is_sync_item, archived);

-- Tasks indexes
CREATE INDEX IF NOT EXISTS idx_tasks_project_id ON tasks(project_id);
CREATE INDEX IF NOT EXISTS idx_tasks_is_subtask ON tasks(is_subtask);
CREATE INDEX IF NOT EXISTS idx_tasks_project_order ON tasks(project_id, display_order);

-- Sync settings index
CREATE INDEX IF NOT EXISTS idx_sync_settings_user_id ON sync_settings(user_id);
```

**Triggers for updated_date:**
```sql
-- Projects trigger (may already exist, use DROP IF EXISTS first)
DROP TRIGGER IF EXISTS update_projects_updated_date ON projects;
CREATE TRIGGER update_projects_updated_date BEFORE UPDATE ON projects
  FOR EACH ROW EXECUTE FUNCTION update_updated_date_column();

-- Team members trigger
DROP TRIGGER IF EXISTS update_team_members_updated_date ON team_members;
CREATE TRIGGER update_team_members_updated_date BEFORE UPDATE ON team_members
  FOR EACH ROW EXECUTE FUNCTION update_updated_date_column();

-- Sync settings trigger
DROP TRIGGER IF EXISTS update_sync_settings_updated_date ON sync_settings;
CREATE TRIGGER update_sync_settings_updated_date BEFORE UPDATE ON sync_settings
  FOR EACH ROW EXECUTE FUNCTION update_updated_date_column();
```

Include migration header comment following existing pattern:
```sql
-- Migration: 022_sync_items
-- Create sync item schema extensions for TeamSync Integration (v1.6)
```
  </action>
  <verify>File exists at server/db/022_sync_items.sql with all ALTER TABLE and CREATE TABLE statements</verify>
  <done>Migration file contains all schema changes for sync items, subtasks, settings table, indexes, and triggers</done>
</task>

<task type="auto">
  <name>Task 2: Register migration in migrate.js</name>
  <files>server/db/migrate.js</files>
  <action>
Add new migration entry to the MIGRATIONS array in `server/db/migrate.js`:

```javascript
{
  version: '022_sync_items',
  name: 'Add sync item schema for TeamSync Integration',
  file: '022_sync_items.sql'
}
```

Add this entry after the existing `021_email_notifications` entry, maintaining the sequential versioning pattern.
  </action>
  <verify>grep -n "022_sync_items" server/db/migrate.js shows the new entry in MIGRATIONS array</verify>
  <done>migrate.js MIGRATIONS array includes 022_sync_items entry with correct version, name, and file</done>
</task>

<task type="auto">
  <name>Task 3: Run migration and verify schema</name>
  <files>None (verification only)</files>
  <action>
Execute the migration to apply schema changes to the local database:

1. Run: `npm run migrate`
2. If migration fails, check error message and fix SQL syntax
3. After successful migration, verify the schema changes were applied

Verification queries to run via psql or the app:
- Check projects columns: `\d projects` should show new columns
- Check tasks columns: `\d tasks` should show project_id, is_subtask, completed, display_order
- Check sync_settings table exists: `\d sync_settings`
- Check indexes exist: `\di idx_projects_*` and `\di idx_tasks_*`
  </action>
  <verify>npm run migrate completes with "Migration 022_sync_items completed successfully" message</verify>
  <done>Migration runs successfully, all tables have expected columns and indexes</done>
</task>

</tasks>

<verification>
1. Migration file exists: `ls server/db/022_sync_items.sql`
2. Migration registered: `grep "022_sync_items" server/db/migrate.js`
3. Migration runs: `npm run migrate` shows success or "up to date"
4. Schema correct: Query database to verify columns exist on projects, tasks, team_members tables and sync_settings table exists
</verification>

<success_criteria>
- [ ] 022_sync_items.sql exists with all ALTER TABLE and CREATE TABLE statements
- [ ] migrate.js includes 022_sync_items in MIGRATIONS array
- [ ] `npm run migrate` executes successfully
- [ ] Projects table has: category, sync_status, team_department, assigned_to_id, sprint_id, week_start_date, status_history, archived, is_sync_item, display_order
- [ ] Tasks table has: project_id (FK with CASCADE), is_subtask, completed, display_order
- [ ] Team_members table has: display_order column
- [ ] sync_settings table exists with: user_id, sprint_weeks, default_view, default_team, settings_data
- [ ] All specified indexes exist
- [ ] Updated_date triggers exist on projects, team_members, sync_settings
</success_criteria>

<output>
After completion, create `.planning/phases/23-database-backend-services/23-01-SUMMARY.md`
</output>
