---
phase: 24-rest-api
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/routes/sync.js
  - server/index.js
autonomous: true

must_haves:
  truths:
    - "GET /api/sync returns sync items filtered by category, teamDepartment, archived"
    - "POST /api/sync creates a new sync item and returns 201"
    - "GET /api/sync/:id returns a single sync item"
    - "PUT /api/sync/:id updates a sync item"
    - "DELETE /api/sync/:id removes a sync item"
    - "GET /api/sync/archived returns archived items with date filtering"
    - "GET /api/sync/archived/count returns integer count for badge"
    - "PUT /api/sync/:id/restore moves item from archived to active"
  artifacts:
    - path: "server/routes/sync.js"
      provides: "REST endpoints for sync item CRUD, archive, restore"
      exports: ["default (router)"]
    - path: "server/index.js"
      provides: "Router mounting at /api/sync"
      contains: "app.use('/api/sync'"
  key_links:
    - from: "server/routes/sync.js"
      to: "server/services/SyncItemService.js"
      via: "import and method calls"
      pattern: "SyncItemService\\.(list|get|create|update|delete|getArchived|getArchivedCount|restore)"
    - from: "server/index.js"
      to: "server/routes/sync.js"
      via: "import and app.use"
      pattern: "app\\.use\\('/api/sync'"
---

<objective>
Create REST API routes for sync item CRUD operations, archive management, and restore functionality.

Purpose: Enable frontend to interact with sync items via HTTP endpoints, completing the data access layer for TeamSync Integration.
Output: `server/routes/sync.js` mounted at `/api/sync` with 8 endpoints covering requirements API-01 through API-08.
</objective>

<execution_context>
@/Users/i306072/.claude/get-shit-done/workflows/execute-plan.md
@/Users/i306072/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-rest-api/24-RESEARCH.md
@.planning/phases/23-database-backend-services/23-02-SUMMARY.md

# Service interface (already exists)
@server/services/SyncItemService.js

# Route patterns to follow
@server/routes/tasks.js
@server/routes/bugs.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sync.js route file with sync item CRUD</name>
  <files>server/routes/sync.js</files>
  <action>
Create `server/routes/sync.js` with Express router and sync item CRUD endpoints.

**CRITICAL: Route ordering matters!**
Register specific routes BEFORE generic `:id` routes:
1. `/archived` and `/archived/count` FIRST
2. `/settings` FIRST (will be added in 24-02)
3. `/:id` and `/:id/*` LAST

**Import pattern:**
```javascript
import express from 'express';
import SyncItemService from '../services/SyncItemService.js';
import { authMiddleware } from '../middleware/auth.js';

const router = express.Router();
router.use(authMiddleware);
```

**Endpoints to implement (in this order):**

1. `GET /` - List sync items with filtering
   - Query params: `category`, `teamDepartment`, `archived` (default false)
   - Map `teamDepartment` to `team_department` for service
   - Call `SyncItemService.list(req.user.id, filters)`
   - Return JSON array

2. `GET /archived` - Get archived items
   - Query params: `from_date`, `to_date` (optional)
   - Call `SyncItemService.getArchived(req.user.id, filters)`
   - Return JSON array

3. `GET /archived/count` - Get archived count
   - Call `SyncItemService.getArchivedCount(req.user.id)`
   - Return `{ count: number }`

4. `POST /` - Create sync item
   - Body: sync item data (name required)
   - Call `SyncItemService.create(req.user.id, req.body)`
   - Return 201 with created item

5. `GET /:id` - Get single sync item
   - Call `SyncItemService.get(req.user.id, req.params.id)`
   - Return 404 if error.message includes "not found"

6. `PUT /:id` - Update sync item
   - Call `SyncItemService.update(req.user.id, req.params.id, req.body)`
   - Return 404 if not found, 400 for other errors

7. `DELETE /:id` - Delete sync item
   - Call `SyncItemService.delete(req.user.id, req.params.id)`
   - Return 204 on success

8. `PUT /:id/restore` - Restore archived item
   - Call `SyncItemService.restore(req.user.id, req.params.id)`
   - Return restored item

**Error handling pattern (from tasks.js):**
```javascript
} catch (error) {
  console.error('GET /api/sync error:', error);
  const statusCode = error.message.includes('not found') ? 404 : 500;
  res.status(statusCode).json({ error: error.message });
}
```

Export default router.
  </action>
  <verify>File exists at server/routes/sync.js with all 8 endpoints</verify>
  <done>
    - GET / returns items with category/teamDepartment/archived filtering
    - GET /archived returns archived items with date filters
    - GET /archived/count returns { count: N }
    - POST / creates item with 201 response
    - GET /:id returns single item or 404
    - PUT /:id updates item
    - DELETE /:id removes item with 204
    - PUT /:id/restore moves item from archived to active
  </done>
</task>

<task type="auto">
  <name>Task 2: Mount sync router in server/index.js</name>
  <files>server/index.js</files>
  <action>
Add sync router to server/index.js:

1. Add import near other route imports (alphabetically near other imports):
```javascript
import syncRouter from './routes/sync.js';
```

2. Mount router with other API routes:
```javascript
app.use('/api/sync', syncRouter);
```

Place the mount after existing routes (e.g., after bugs router).
  </action>
  <verify>Server starts without errors: `npm run dev:server`</verify>
  <done>syncRouter imported and mounted at /api/sync</done>
</task>

<task type="auto">
  <name>Task 3: Verify sync item endpoints work</name>
  <files>none</files>
  <action>
Test all sync item endpoints with curl commands.

**Prerequisites:**
- PostgreSQL running (`docker start teamssync-postgres` if needed)
- Server running (`npm run dev:server` in background)

**Test sequence:**

1. Create sync item:
```bash
curl -X POST http://localhost:3001/api/sync \
  -H "Content-Type: application/json" \
  -d '{"name":"Test Sync Item","category":"goals","team_department":"Engineering"}'
```
Expected: 201 with item including `id`, `is_sync_item: true`

2. List sync items:
```bash
curl http://localhost:3001/api/sync
```
Expected: Array containing created item

3. Get single item (use ID from step 1):
```bash
curl http://localhost:3001/api/sync/{id}
```
Expected: Single item object

4. Update item:
```bash
curl -X PUT http://localhost:3001/api/sync/{id} \
  -H "Content-Type: application/json" \
  -d '{"sync_status":"in_progress"}'
```
Expected: Updated item with new status

5. Archive item (via update):
```bash
curl -X PUT http://localhost:3001/api/sync/{id} \
  -H "Content-Type: application/json" \
  -d '{"archived":true}'
```
Note: This won't work - archived is set via archive service method, not update.
Skip this test - archive endpoint not exposed via PUT.

6. Get archived items:
```bash
curl http://localhost:3001/api/sync/archived
```
Expected: Array (empty if no archived items)

7. Get archived count:
```bash
curl http://localhost:3001/api/sync/archived/count
```
Expected: `{"count":0}` or similar

8. Delete item:
```bash
curl -X DELETE http://localhost:3001/api/sync/{id}
```
Expected: 204 No Content

9. Verify delete:
```bash
curl http://localhost:3001/api/sync/{id}
```
Expected: 404 Not Found

Document any failures for fix.
  </action>
  <verify>All curl commands return expected responses</verify>
  <done>
    - POST /api/sync returns 201 with created item
    - GET /api/sync returns array
    - GET /api/sync/:id returns item or 404
    - PUT /api/sync/:id updates item
    - GET /api/sync/archived returns array
    - GET /api/sync/archived/count returns count object
    - DELETE /api/sync/:id returns 204
  </done>
</task>

</tasks>

<verification>
- Server starts without errors
- All 8 endpoints respond correctly
- Route ordering confirmed: /archived routes work (not captured by /:id)
- Authentication required (test without auth returns 401)
- Multi-tenancy enforced (dev-user-001 filter applied)
</verification>

<success_criteria>
Requirements covered:
- [x] API-01: GET /api/sync with filtering
- [x] API-02: POST /api/sync creates item
- [x] API-03: GET /api/sync/:id returns single
- [x] API-04: PUT /api/sync/:id updates
- [x] API-05: DELETE /api/sync/:id deletes
- [x] API-06: GET /api/sync/archived with date filters
- [x] API-07: GET /api/sync/archived/count for badge
- [x] API-08: PUT /api/sync/:id/restore
</success_criteria>

<output>
After completion, create `.planning/phases/24-rest-api/24-01-SUMMARY.md`
</output>
