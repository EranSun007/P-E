---
phase: 24-rest-api
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - server/routes/sync.js
autonomous: true

must_haves:
  truths:
    - "GET /api/sync/:itemId/subtasks returns subtasks for a sync item"
    - "POST /api/sync/:itemId/subtasks creates a subtask"
    - "PUT /api/sync/:itemId/subtasks/:subtaskId updates a subtask"
    - "DELETE /api/sync/:itemId/subtasks/:subtaskId deletes a subtask"
    - "PUT /api/sync/:itemId/subtasks/reorder updates subtask order"
    - "GET /api/sync/settings returns user preferences or defaults"
    - "PUT /api/sync/settings updates user preferences"
  artifacts:
    - path: "server/routes/sync.js"
      provides: "Subtask nested routes and settings routes"
      contains: "SubtaskService"
  key_links:
    - from: "server/routes/sync.js"
      to: "server/services/SubtaskService.js"
      via: "import and method calls"
      pattern: "SubtaskService\\.(list|create|update|delete|reorder)"
    - from: "server/routes/sync.js"
      to: "server/services/SyncSettingsService.js"
      via: "import and method calls"
      pattern: "SyncSettingsService\\.(get|update)"
---

<objective>
Add subtask nested routes and settings endpoints to the sync router.

Purpose: Complete the REST API layer by exposing subtask operations and user preferences, enabling full frontend integration for TeamSync.
Output: Extended `server/routes/sync.js` with 7 additional endpoints covering requirements API-09 through API-15.
</objective>

<execution_context>
@/Users/i306072/.claude/get-shit-done/workflows/execute-plan.md
@/Users/i306072/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-rest-api/24-RESEARCH.md
@.planning/phases/23-database-backend-services/23-02-SUMMARY.md

# Service interfaces (already exist)
@server/services/SubtaskService.js
@server/services/SyncSettingsService.js

# Route file to extend (created in 24-01)
@server/routes/sync.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add subtask and settings imports to sync.js</name>
  <files>server/routes/sync.js</files>
  <action>
Add imports for SubtaskService and SyncSettingsService at the top of sync.js:

```javascript
import SubtaskService from '../services/SubtaskService.js';
import SyncSettingsService from '../services/SyncSettingsService.js';
```

Place these after the existing SyncItemService import.
  </action>
  <verify>File has all three service imports</verify>
  <done>SubtaskService and SyncSettingsService imported</done>
</task>

<task type="auto">
  <name>Task 2: Add settings endpoints to sync.js</name>
  <files>server/routes/sync.js</files>
  <action>
Add settings endpoints BEFORE the generic /:id routes (route ordering critical).

**Insert these routes after /archived/count and before /:id:**

1. `GET /settings` - Get user settings
```javascript
/**
 * GET /api/sync/settings
 * Get user sync settings (returns defaults if none exist)
 */
router.get('/settings', async (req, res) => {
  try {
    const settings = await SyncSettingsService.get(req.user.id);
    res.json(settings);
  } catch (error) {
    console.error('GET /api/sync/settings error:', error);
    res.status(500).json({ error: error.message });
  }
});
```

2. `PUT /settings` - Update user settings
```javascript
/**
 * PUT /api/sync/settings
 * Update user sync settings (upsert)
 */
router.put('/settings', async (req, res) => {
  try {
    const settings = await SyncSettingsService.update(req.user.id, req.body);
    res.json(settings);
  } catch (error) {
    console.error('PUT /api/sync/settings error:', error);
    res.status(400).json({ error: error.message });
  }
});
```
  </action>
  <verify>Routes added in correct position (before /:id routes)</verify>
  <done>GET and PUT /settings endpoints added</done>
</task>

<task type="auto">
  <name>Task 3: Add subtask nested routes to sync.js</name>
  <files>server/routes/sync.js</files>
  <action>
Add subtask endpoints AFTER the generic /:id routes (they use /:itemId pattern which is more specific due to /subtasks suffix).

**CRITICAL: Route ordering for subtasks:**
- `/:itemId/subtasks/reorder` MUST come BEFORE `/:itemId/subtasks/:subtaskId`
- Otherwise `/reorder` matches as `:subtaskId`

**Add these routes at the end of the file (before export):**

1. `GET /:itemId/subtasks` - List subtasks
```javascript
/**
 * GET /api/sync/:itemId/subtasks
 * List all subtasks for a sync item
 */
router.get('/:itemId/subtasks', async (req, res) => {
  try {
    const subtasks = await SubtaskService.list(req.user.id, req.params.itemId);
    res.json(subtasks);
  } catch (error) {
    console.error(`GET /api/sync/${req.params.itemId}/subtasks error:`, error);
    const statusCode = error.message.includes('not found') ? 404 : 500;
    res.status(statusCode).json({ error: error.message });
  }
});
```

2. `POST /:itemId/subtasks` - Create subtask
```javascript
/**
 * POST /api/sync/:itemId/subtasks
 * Create a new subtask
 */
router.post('/:itemId/subtasks', async (req, res) => {
  try {
    const subtask = await SubtaskService.create(req.user.id, req.params.itemId, req.body);
    res.status(201).json(subtask);
  } catch (error) {
    console.error(`POST /api/sync/${req.params.itemId}/subtasks error:`, error);
    const statusCode = error.message.includes('not found') ? 404 : 400;
    res.status(statusCode).json({ error: error.message });
  }
});
```

3. `PUT /:itemId/subtasks/reorder` - Reorder subtasks (BEFORE /:subtaskId!)
```javascript
/**
 * PUT /api/sync/:itemId/subtasks/reorder
 * Reorder subtasks atomically
 */
router.put('/:itemId/subtasks/reorder', async (req, res) => {
  try {
    const { orderedSubtaskIds } = req.body;

    if (!Array.isArray(orderedSubtaskIds)) {
      return res.status(400).json({
        error: 'Bad Request',
        message: 'orderedSubtaskIds must be an array'
      });
    }

    const subtasks = await SubtaskService.reorder(
      req.user.id,
      req.params.itemId,
      orderedSubtaskIds
    );
    res.json(subtasks);
  } catch (error) {
    console.error(`PUT /api/sync/${req.params.itemId}/subtasks/reorder error:`, error);
    const statusCode = error.message.includes('not found') ? 404 : 400;
    res.status(statusCode).json({ error: error.message });
  }
});
```

4. `PUT /:itemId/subtasks/:subtaskId` - Update subtask
```javascript
/**
 * PUT /api/sync/:itemId/subtasks/:subtaskId
 * Update a subtask
 */
router.put('/:itemId/subtasks/:subtaskId', async (req, res) => {
  try {
    const subtask = await SubtaskService.update(
      req.user.id,
      req.params.itemId,
      req.params.subtaskId,
      req.body
    );
    res.json(subtask);
  } catch (error) {
    console.error(`PUT /api/sync/${req.params.itemId}/subtasks/${req.params.subtaskId} error:`, error);
    const statusCode = error.message.includes('not found') ? 404 : 400;
    res.status(statusCode).json({ error: error.message });
  }
});
```

5. `DELETE /:itemId/subtasks/:subtaskId` - Delete subtask
```javascript
/**
 * DELETE /api/sync/:itemId/subtasks/:subtaskId
 * Delete a subtask
 */
router.delete('/:itemId/subtasks/:subtaskId', async (req, res) => {
  try {
    await SubtaskService.delete(req.user.id, req.params.itemId, req.params.subtaskId);
    res.status(204).send();
  } catch (error) {
    console.error(`DELETE /api/sync/${req.params.itemId}/subtasks/${req.params.subtaskId} error:`, error);
    const statusCode = error.message.includes('not found') ? 404 : 400;
    res.status(statusCode).json({ error: error.message });
  }
});
```
  </action>
  <verify>All 5 subtask routes added with correct ordering</verify>
  <done>
    - GET /:itemId/subtasks lists subtasks
    - POST /:itemId/subtasks creates subtask
    - PUT /:itemId/subtasks/reorder updates order (before /:subtaskId)
    - PUT /:itemId/subtasks/:subtaskId updates subtask
    - DELETE /:itemId/subtasks/:subtaskId deletes subtask
  </done>
</task>

<task type="auto">
  <name>Task 4: Verify subtask and settings endpoints</name>
  <files>none</files>
  <action>
Test all subtask and settings endpoints with curl commands.

**Prerequisites:**
- Server running (`npm run dev:server`)
- Need a sync item ID - create one first if needed

**Test sequence:**

1. Get settings (should return defaults):
```bash
curl http://localhost:3001/api/sync/settings
```
Expected: `{"sprint_weeks":2,"default_view":"sprint","default_team":null,"settings_data":{}}`

2. Update settings:
```bash
curl -X PUT http://localhost:3001/api/sync/settings \
  -H "Content-Type: application/json" \
  -d '{"sprint_weeks":1,"default_view":"week"}'
```
Expected: Updated settings object with new values

3. Create sync item for subtask tests:
```bash
curl -X POST http://localhost:3001/api/sync \
  -H "Content-Type: application/json" \
  -d '{"name":"Subtask Test Item"}'
```
Save the `id` from response.

4. List subtasks (empty):
```bash
curl http://localhost:3001/api/sync/{itemId}/subtasks
```
Expected: Empty array `[]`

5. Create subtask:
```bash
curl -X POST http://localhost:3001/api/sync/{itemId}/subtasks \
  -H "Content-Type: application/json" \
  -d '{"title":"First subtask"}'
```
Expected: 201 with subtask including `id`, `is_subtask: true`

6. Create second subtask:
```bash
curl -X POST http://localhost:3001/api/sync/{itemId}/subtasks \
  -H "Content-Type: application/json" \
  -d '{"title":"Second subtask"}'
```
Expected: 201 with display_order=1

7. List subtasks (should have 2):
```bash
curl http://localhost:3001/api/sync/{itemId}/subtasks
```
Expected: Array with 2 subtasks in display_order

8. Update subtask (mark complete):
```bash
curl -X PUT http://localhost:3001/api/sync/{itemId}/subtasks/{subtaskId} \
  -H "Content-Type: application/json" \
  -d '{"completed":true}'
```
Expected: Subtask with `completed: true`, `status: "done"`

9. Reorder subtasks (swap order):
```bash
curl -X PUT http://localhost:3001/api/sync/{itemId}/subtasks/reorder \
  -H "Content-Type: application/json" \
  -d '{"orderedSubtaskIds":["{subtask2Id}","{subtask1Id}"]}'
```
Expected: Array with subtasks in new order

10. Delete subtask:
```bash
curl -X DELETE http://localhost:3001/api/sync/{itemId}/subtasks/{subtaskId}
```
Expected: 204 No Content

11. Clean up - delete sync item:
```bash
curl -X DELETE http://localhost:3001/api/sync/{itemId}
```
Expected: 204 No Content

Document any failures for fix.
  </action>
  <verify>All curl commands return expected responses</verify>
  <done>
    - GET /api/sync/settings returns settings or defaults
    - PUT /api/sync/settings updates settings
    - GET /api/sync/:itemId/subtasks returns array
    - POST /api/sync/:itemId/subtasks creates with 201
    - PUT /api/sync/:itemId/subtasks/:subtaskId updates
    - DELETE /api/sync/:itemId/subtasks/:subtaskId returns 204
    - PUT /api/sync/:itemId/subtasks/reorder changes order
  </done>
</task>

</tasks>

<verification>
- Server starts without errors after changes
- Settings endpoints return correct defaults/updates
- Subtask CRUD operations work correctly
- Reorder endpoint updates display_order atomically
- Route ordering verified: /settings not captured by /:id, /reorder not captured by /:subtaskId
- Authentication required on all endpoints
- Multi-tenancy enforced (user can only access own items/subtasks)
</verification>

<success_criteria>
Requirements covered:
- [x] API-09: GET /api/sync/:itemId/subtasks
- [x] API-10: POST /api/sync/:itemId/subtasks
- [x] API-11: PUT /api/sync/:itemId/subtasks/:subtaskId
- [x] API-12: DELETE /api/sync/:itemId/subtasks/:subtaskId
- [x] API-13: PUT /api/sync/:itemId/subtasks/reorder
- [x] API-14: GET /api/sync/settings
- [x] API-15: PUT /api/sync/settings
</success_criteria>

<output>
After completion, create `.planning/phases/24-rest-api/24-02-SUMMARY.md`
</output>
