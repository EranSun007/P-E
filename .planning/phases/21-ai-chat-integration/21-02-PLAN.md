---
phase: 21-ai-chat-integration
plan: 02
type: execute
wave: 2
depends_on: [21-01]
files_modified:
  - src/components/ai/SearchResultBlock.jsx
  - src/components/ai/ExpandableCodeBlock.jsx
  - src/components/ai/ChatMessage.jsx
autonomous: true

must_haves:
  truths:
    - "Search results appear inline in chat with expandable code snippets"
    - "Code blocks have syntax highlighting matching Phase 20 patterns"
    - "Results show similarity scores and file paths"
  artifacts:
    - path: "src/components/ai/SearchResultBlock.jsx"
      provides: "Inline search result display component"
      min_lines: 80
    - path: "src/components/ai/ExpandableCodeBlock.jsx"
      provides: "Collapsible code snippet with syntax highlighting"
      min_lines: 50
    - path: "src/components/ai/ChatMessage.jsx"
      provides: "Renders search_result message type"
      contains: "search_result"
  key_links:
    - from: "src/components/ai/ChatMessage.jsx"
      to: "SearchResultBlock"
      via: "conditional render on message.type"
      pattern: "type.*search_result"
    - from: "src/components/ai/SearchResultBlock.jsx"
      to: "ExpandableCodeBlock"
      via: "map over codeResults"
      pattern: "ExpandableCodeBlock"
    - from: "src/components/ai/ExpandableCodeBlock.jsx"
      to: "react-syntax-highlighter"
      via: "SyntaxHighlighter import"
      pattern: "SyntaxHighlighter"
---

<objective>
Create inline search results display with expandable code snippets in chat

Purpose: Display knowledge base search results inline in chat with collapsible code blocks that have syntax highlighting, matching the UI patterns established in Phase 20 (CHAT-03).

Output: SearchResultBlock component for inline results, ExpandableCodeBlock for collapsible code, ChatMessage updated to render search_result type
</objective>

<execution_context>
@/Users/i306072/.claude/get-shit-done/workflows/execute-plan.md
@/Users/i306072/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-ai-chat-integration/21-RESEARCH.md
@.planning/phases/20-knowledge-search-ui/20-01-SUMMARY.md

# Existing components for patterns
@src/components/ai/ChatMessage.jsx
@src/components/knowledge/CodeResultCard.jsx
@src/components/knowledge/LanguageDetector.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ExpandableCodeBlock component</name>
  <files>src/components/ai/ExpandableCodeBlock.jsx</files>
  <action>
Create new component src/components/ai/ExpandableCodeBlock.jsx:

1. Import dependencies:
   - Collapsible, CollapsibleContent, CollapsibleTrigger from '@/components/ui/collapsible'
   - Light as SyntaxHighlighter from 'react-syntax-highlighter/dist/esm/light'
   - docco from 'react-syntax-highlighter/dist/esm/styles/hljs'
   - Language modules: javascript, typescript, python, java, go, json, yaml, bash
   - ChevronDown, ChevronRight, Copy, Check from 'lucide-react'
   - useState from 'react'
   - cn from '@/lib/utils'
   - PropTypes for validation

2. Register languages with SyntaxHighlighter.registerLanguage (same as Phase 20):
   - javascript, typescript, python, java, go, json, yaml, bash

3. Create ExpandableCodeBlock component with props:
   - code (string, required)
   - language (string, default 'plaintext')
   - filePath (string, default '')
   - defaultOpen (boolean, default false)
   - isProductMode (boolean, default false)

4. Component structure:
```jsx
export function ExpandableCodeBlock({ code, language, filePath, defaultOpen = false, isProductMode = false }) {
  const [isOpen, setIsOpen] = useState(defaultOpen);
  const [copied, setCopied] = useState(false);

  const handleCopy = (e) => {
    e.stopPropagation();
    navigator.clipboard.writeText(code);
    setCopied(true);
    setTimeout(() => setCopied(false), 2000);
  };

  // Normalize language for syntax highlighter
  const normalizedLang = language?.toLowerCase() || 'plaintext';

  return (
    <Collapsible open={isOpen} onOpenChange={setIsOpen}>
      <div className={cn(
        "border rounded-lg overflow-hidden",
        isProductMode ? "border-gray-700" : "border-gray-200"
      )}>
        <CollapsibleTrigger className="w-full">
          <div className={cn(
            "flex items-center justify-between p-2",
            isProductMode
              ? "bg-gray-800 hover:bg-gray-750"
              : "bg-muted/30 hover:bg-muted/50"
          )}>
            <div className="flex items-center gap-2 min-w-0">
              {isOpen
                ? <ChevronDown className="h-4 w-4 shrink-0" />
                : <ChevronRight className="h-4 w-4 shrink-0" />
              }
              <code className={cn(
                "text-xs truncate",
                isProductMode ? "text-gray-300" : "text-gray-700"
              )}>{filePath || 'code'}</code>
              <span className={cn(
                "text-xs px-1.5 py-0.5 rounded shrink-0",
                isProductMode
                  ? "bg-gray-700 text-gray-400"
                  : "bg-gray-100 text-gray-500"
              )}>{normalizedLang}</span>
            </div>
            <button
              onClick={handleCopy}
              className={cn(
                "p-1 rounded shrink-0",
                isProductMode ? "hover:bg-gray-700" : "hover:bg-gray-200"
              )}
              title="Copy code"
            >
              {copied
                ? <Check className="h-3 w-3 text-green-500" />
                : <Copy className={cn("h-3 w-3", isProductMode ? "text-gray-400" : "text-gray-500")} />
              }
            </button>
          </div>
        </CollapsibleTrigger>
        <CollapsibleContent>
          <SyntaxHighlighter
            language={normalizedLang}
            style={docco}
            showLineNumbers={true}
            customStyle={{
              margin: 0,
              fontSize: '0.7rem',
              maxHeight: '200px',
              overflow: 'auto',
              background: isProductMode ? '#1f2937' : undefined
            }}
          >
            {code || ''}
          </SyntaxHighlighter>
        </CollapsibleContent>
      </div>
    </Collapsible>
  );
}
```

5. Add PropTypes validation

6. Export as default and named export
  </action>
  <verify>
- File exists and ESLint passes: `npm run lint -- --quiet src/components/ai/ExpandableCodeBlock.jsx`
- Component renders without errors when imported
  </verify>
  <done>ExpandableCodeBlock component with collapsible code, syntax highlighting, copy button, dark mode support</done>
</task>

<task type="auto">
  <name>Task 2: Create SearchResultBlock component</name>
  <files>src/components/ai/SearchResultBlock.jsx</files>
  <action>
Create new component src/components/ai/SearchResultBlock.jsx:

1. Import dependencies:
   - Search, FileCode, FileText from 'lucide-react'
   - cn from '@/lib/utils'
   - ExpandableCodeBlock from './ExpandableCodeBlock'
   - PropTypes

2. Helper function for similarity color:
```javascript
const getSimilarityColor = (score, isProductMode) => {
  const pct = (score || 0) * 100;
  if (pct >= 80) return isProductMode ? 'text-green-400' : 'text-green-600';
  if (pct >= 60) return isProductMode ? 'text-yellow-400' : 'text-yellow-600';
  return isProductMode ? 'text-gray-400' : 'text-gray-500';
};
```

3. Create SearchResultBlock component with props:
   - query (string)
   - codeResults (array)
   - docsResults (array)
   - isProductMode (boolean)

4. Component structure:
```jsx
export function SearchResultBlock({ query, codeResults = [], docsResults = [], isProductMode = false }) {
  const hasResults = codeResults.length > 0 || docsResults.length > 0;

  return (
    <div className={cn(
      "p-4",
      isProductMode ? "bg-gray-900" : "bg-white"
    )}>
      {/* Header */}
      <div className="flex items-center gap-2 mb-3">
        <Search className={cn(
          "h-4 w-4",
          isProductMode ? "text-purple-400" : "text-indigo-600"
        )} />
        <span className={cn(
          "text-sm font-medium",
          isProductMode ? "text-gray-300" : "text-gray-700"
        )}>
          Knowledge Search: "{query}"
        </span>
      </div>

      {!hasResults ? (
        <p className={cn(
          "text-sm",
          isProductMode ? "text-gray-500" : "text-gray-500"
        )}>
          No results found. Try a different search query.
        </p>
      ) : (
        <div className="space-y-4">
          {/* Code Results */}
          {codeResults.length > 0 && (
            <div>
              <div className="flex items-center gap-1.5 mb-2">
                <FileCode className={cn(
                  "h-3.5 w-3.5",
                  isProductMode ? "text-blue-400" : "text-blue-600"
                )} />
                <span className={cn(
                  "text-xs font-medium",
                  isProductMode ? "text-gray-400" : "text-gray-600"
                )}>
                  Code ({codeResults.length})
                </span>
              </div>
              <div className="space-y-2">
                {codeResults.map((result, idx) => (
                  <div key={idx} className="relative">
                    <ExpandableCodeBlock
                      code={result.code || result.content || ''}
                      language={result.language || 'plaintext'}
                      filePath={result.filePath || result.file_path || ''}
                      defaultOpen={idx === 0}
                      isProductMode={isProductMode}
                    />
                    {(result.similarity || result.score) && (
                      <span className={cn(
                        "absolute top-2 right-10 text-xs",
                        getSimilarityColor(result.similarity || result.score, isProductMode)
                      )}>
                        {Math.round((result.similarity || result.score) * 100)}%
                      </span>
                    )}
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Docs Results */}
          {docsResults.length > 0 && (
            <div>
              <div className="flex items-center gap-1.5 mb-2">
                <FileText className={cn(
                  "h-3.5 w-3.5",
                  isProductMode ? "text-green-400" : "text-green-600"
                )} />
                <span className={cn(
                  "text-xs font-medium",
                  isProductMode ? "text-gray-400" : "text-gray-600"
                )}>
                  Documentation ({docsResults.length})
                </span>
              </div>
              <div className="space-y-2">
                {docsResults.map((result, idx) => (
                  <div
                    key={idx}
                    className={cn(
                      "p-2 rounded-lg border text-sm",
                      isProductMode
                        ? "border-gray-700 bg-gray-800"
                        : "border-gray-200 bg-gray-50"
                    )}
                  >
                    <div className="flex items-center justify-between mb-1">
                      <span className={cn(
                        "font-medium truncate",
                        isProductMode ? "text-gray-200" : "text-gray-800"
                      )}>
                        {result.title || result.file_path || 'Document'}
                      </span>
                      {(result.similarity || result.score) && (
                        <span className={cn(
                          "text-xs shrink-0 ml-2",
                          getSimilarityColor(result.similarity || result.score, isProductMode)
                        )}>
                          {Math.round((result.similarity || result.score) * 100)}%
                        </span>
                      )}
                    </div>
                    <p className={cn(
                      "text-xs line-clamp-2",
                      isProductMode ? "text-gray-400" : "text-gray-600"
                    )}>
                      {result.excerpt || result.content || ''}
                    </p>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

5. Add PropTypes validation

6. Export as default and named export
  </action>
  <verify>
- File exists and ESLint passes: `npm run lint -- --quiet src/components/ai/SearchResultBlock.jsx`
- Component renders code and docs sections correctly
  </verify>
  <done>SearchResultBlock displays inline search results with code snippets and documentation cards</done>
</task>

<task type="auto">
  <name>Task 3: Update ChatMessage to render search results</name>
  <files>src/components/ai/ChatMessage.jsx</files>
  <action>
Modify ChatMessage.jsx to handle search_result message type:

1. Import SearchResultBlock:
   `import { SearchResultBlock } from './SearchResultBlock';`

2. Add early return for search_result type at start of component:
```jsx
// Handle special message types
if (message.type === 'search_result') {
  return (
    <SearchResultBlock
      query={message.query}
      codeResults={message.codeResults}
      docsResults={message.docsResults}
      isProductMode={isProductMode}
    />
  );
}
```

3. Handle command type messages (show with different styling):
```jsx
// Handle command messages (like /search query)
if (message.type === 'command') {
  return (
    <div className={cn(
      'flex gap-3 p-4',
      isProductMode ? 'bg-gray-800' : 'bg-gray-50'
    )}>
      <Avatar className={cn(
        'h-8 w-8 shrink-0',
        isProductMode ? 'bg-indigo-900' : 'bg-indigo-100'
      )}>
        <AvatarFallback className={isProductMode ? 'text-indigo-400' : 'text-indigo-700'}>
          <User className="h-4 w-4" />
        </AvatarFallback>
      </Avatar>
      <div className="flex-1 min-w-0">
        <p className="text-xs font-medium mb-1 text-gray-500">You</p>
        <code className={cn(
          "text-sm px-2 py-1 rounded",
          isProductMode
            ? "bg-gray-700 text-purple-400"
            : "bg-gray-100 text-indigo-600"
        )}>
          {message.content}
        </code>
      </div>
    </div>
  );
}
```

4. Rest of component unchanged (regular user/assistant messages)
  </action>
  <verify>
- ESLint passes: `npm run lint -- --quiet src/components/ai/ChatMessage.jsx`
- Chat panel renders search_result messages with SearchResultBlock
- Chat panel renders command messages with code styling
- Regular messages unchanged
  </verify>
  <done>ChatMessage renders search results inline and command messages with distinct styling</done>
</task>

</tasks>

<verification>
1. Start dev server: `npm run dev`
2. Open AI chat panel
3. Type "/search authentication" - should see:
   - Command message styled as code
   - Search results with expandable code blocks
   - Similarity scores in color (green/yellow/gray)
   - Documentation cards if any docs match
4. Click code block header to expand/collapse
5. Click copy button to copy code
6. Verify dark mode (product mode) styling works
</verification>

<success_criteria>
- Search results display inline in chat with proper formatting
- Code blocks are collapsible (first result expanded by default)
- Syntax highlighting works for all 8 registered languages
- Similarity scores color-coded (green >= 80%, yellow >= 60%, gray < 60%)
- Copy button works on code blocks
- Dark mode support matches existing chat components
- No ESLint errors
</success_criteria>

<output>
After completion, create `.planning/phases/21-ai-chat-integration/21-02-SUMMARY.md`
</output>
