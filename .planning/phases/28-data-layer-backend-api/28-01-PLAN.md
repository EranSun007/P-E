---
phase: 28-data-layer-backend-api
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/services/MenuConfigService.js
  - server/routes/menuConfig.js
  - server/index.js
autonomous: true

must_haves:
  truths:
    - "GET /api/menu-config returns user's stored configuration or defaults"
    - "PUT /api/menu-config saves updated configuration"
    - "Menu config is scoped to user_id (multi-tenancy)"
    - "People and Product modes have separate configurations"
  artifacts:
    - path: "server/services/MenuConfigService.js"
      provides: "Menu config CRUD operations"
      exports: ["getConfig", "setConfig", "getDefaults"]
    - path: "server/routes/menuConfig.js"
      provides: "REST API routes for menu config"
      exports: ["router"]
  key_links:
    - from: "server/routes/menuConfig.js"
      to: "server/services/MenuConfigService.js"
      via: "service method calls"
      pattern: "MenuConfigService\\.(get|set)Config"
    - from: "server/routes/menuConfig.js"
      to: "user_settings table"
      via: "UserSettingsService dependency"
      pattern: "UserSettingsService\\.(get|set)"
---

<objective>
Create backend service and REST API for menu configuration persistence.

Purpose: Enable user's menu folder configuration to persist across browser sessions via backend storage, with separate configs for People and Product modes.

Output: MenuConfigService.js service class + menuConfig.js REST routes mounted at /api/menu-config
</objective>

<execution_context>
@/Users/i306072/.claude/get-shit-done/workflows/execute-plan.md
@/Users/i306072/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/research/SUMMARY.md
@server/services/UserSettingsService.js
@server/routes/userSettings.js
@server/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MenuConfigService</name>
  <files>server/services/MenuConfigService.js</files>
  <action>
Create MenuConfigService.js that wraps UserSettingsService for menu configuration:

1. Import UserSettingsService from ./UserSettingsService.js

2. Define DEFAULT_CONFIG constants:
   - DEFAULT_PEOPLE_CONFIG: { folders: [], items: [] }
   - DEFAULT_PRODUCT_CONFIG: { folders: [], items: [] }

   Where folders is array of: { id: string, name: string, order: number }
   Where items is array of: { itemId: string, folderId: string|null, order: number }
   (itemId matches navigation item name like "Tasks", "Calendar", etc.)
   (folderId is null for root-level items)

3. Implement MenuConfigService class with methods:

   async getConfig(userId, mode):
   - mode is 'people' or 'product'
   - settingKey = `menu_config_${mode}`
   - Call UserSettingsService.get(userId, settingKey)
   - If null, return corresponding DEFAULT_*_CONFIG
   - If exists, JSON.parse the value and return
   - Wrap in try/catch, return default on parse error

   async setConfig(userId, mode, config):
   - mode is 'people' or 'product'
   - settingKey = `menu_config_${mode}`
   - JSON.stringify config
   - Call UserSettingsService.set(userId, settingKey, jsonString, false)
   - Return the saved config

   getDefaults(mode):
   - Synchronous method
   - Return DEFAULT_PEOPLE_CONFIG or DEFAULT_PRODUCT_CONFIG based on mode

4. Export singleton instance: export default new MenuConfigService()

Pattern follows: UserSettingsService for GitHub token but with JSON serialization.
  </action>
  <verify>
File exists at server/services/MenuConfigService.js with:
- getConfig, setConfig, getDefaults methods
- DEFAULT_PEOPLE_CONFIG, DEFAULT_PRODUCT_CONFIG constants
- Proper error handling with fallback to defaults
  </verify>
  <done>
MenuConfigService can get/set JSON menu configs per user per mode, with sensible defaults when no config exists.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create REST API routes and mount</name>
  <files>server/routes/menuConfig.js, server/index.js</files>
  <action>
Create menuConfig.js routes file:

1. Import express, MenuConfigService, authMiddleware
2. Create router with authMiddleware applied

3. GET /api/menu-config/:mode
   - mode param is 'people' or 'product'
   - Validate mode is one of allowed values, return 400 if not
   - Call MenuConfigService.getConfig(req.user.id, mode)
   - Return JSON: { mode, config }
   - Catch errors, return 500 with error message

4. PUT /api/menu-config/:mode
   - mode param is 'people' or 'product'
   - Validate mode is one of allowed values, return 400 if not
   - Extract config from req.body
   - Validate config has folders (array) and items (array), return 400 if missing
   - Call MenuConfigService.setConfig(req.user.id, mode, config)
   - Return JSON: { mode, config, updated: true }
   - Catch errors, return 500 with error message

5. GET /api/menu-config/:mode/defaults
   - Return default config for mode (useful for reset functionality)
   - Call MenuConfigService.getDefaults(mode)
   - Return JSON: { mode, config }

Mount in server/index.js:
- Import menuConfigRouter from './routes/menuConfig.js'
- Add app.use('/api/menu-config', menuConfigRouter) after other route mounts
- Follow existing pattern (see userSettings mount)

Route patterns follow userSettings.js structure.
  </action>
  <verify>
1. npm run dev:server starts without errors
2. curl -X GET http://localhost:3001/api/menu-config/people returns default config
3. curl -X PUT http://localhost:3001/api/menu-config/people -H "Content-Type: application/json" -d '{"folders":[],"items":[]}' returns success
4. Second GET returns the saved config (not defaults)
  </verify>
  <done>
REST API routes exist at /api/menu-config/:mode with GET/PUT operations, mounted in Express app.
  </done>
</task>

</tasks>

<verification>
1. Backend starts without errors: `npm run dev:server`
2. GET /api/menu-config/people returns config (default if none saved)
3. GET /api/menu-config/product returns config (default if none saved)
4. PUT /api/menu-config/people saves and persists config
5. PUT /api/menu-config/product saves and persists config
6. Saved configs persist across server restarts (stored in PostgreSQL user_settings)
7. Invalid mode returns 400 error
8. Multi-tenancy: config is scoped to authenticated user
</verification>

<success_criteria>
- MenuConfigService.js exists with getConfig, setConfig, getDefaults methods
- menuConfig.js routes mounted at /api/menu-config
- GET returns stored config or defaults
- PUT saves config to user_settings table
- People and Product modes have separate stored configs
- All endpoints require authentication (401 without token)
</success_criteria>

<output>
After completion, create `.planning/phases/28-data-layer-backend-api/28-01-SUMMARY.md`
</output>
