---
phase: 07-extension-core
plan: 03
type: execute
wave: 2
depends_on: [07-01]
files_modified:
  - extension/popup/popup.html
  - extension/popup/popup.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Extension badge shows count of captures pending review"
    - "User can trigger manual capture from popup"
    - "User can refresh capture rules from popup"
    - "Popup shows pending inbox count"
  artifacts:
    - path: "extension/popup/popup.html"
      provides: "Updated popup with capture controls"
      contains: "captureBtn"
    - path: "extension/popup/popup.js"
      provides: "Capture and refresh rule handlers"
      contains: "MANUAL_CAPTURE"
  key_links:
    - from: "extension/popup/popup.js"
      to: "extension/service-worker.js"
      via: "chrome.runtime.sendMessage MANUAL_CAPTURE"
      pattern: "type.*MANUAL_CAPTURE"
    - from: "extension/popup/popup.js"
      to: "extension/service-worker.js"
      via: "chrome.runtime.sendMessage REFRESH_RULES"
      pattern: "type.*REFRESH_RULES"
---

<objective>
Update the extension popup to show pending inbox count and add manual capture trigger.

Purpose: Users need visibility into captured items awaiting review and a way to manually trigger capture on the current page.

Output:
- Updated popup UI with pending count display and capture button
- Manual capture trigger sends message to content script
- Refresh rules button to fetch latest rules from backend
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-extension-core/07-RESEARCH.md
@.planning/phases/07-extension-core/07-01-SUMMARY.md

# Files to modify
@extension/popup/popup.html
@extension/popup/popup.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update popup HTML with capture controls</name>
  <files>extension/popup/popup.html</files>
  <action>
Update popup.html to include:

1. Change title from "P&E Jira Sync" to "P&E Web Capture"

2. Add a pending inbox count section above the status div:
```html
<div id="pendingSection" class="pending-section" style="display: none;">
  <span id="pendingCount">0</span> captures pending review
  <a href="#" id="viewInbox">View Inbox</a>
</div>
```

3. Add a "Capture Page" button after the Sync Now button:
```html
<button id="captureBtn">Capture This Page</button>
```

4. Add a "Refresh Rules" button after the Settings button:
```html
<button id="refreshRulesBtn" class="secondary">Refresh Rules</button>
```

5. Add CSS styles:
```css
.pending-section {
  background: #fff3cd;
  color: #856404;
  padding: 8px;
  border-radius: 4px;
  margin-bottom: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.pending-section a {
  color: #856404;
  font-size: 12px;
}
#pendingCount {
  font-weight: bold;
}
button.secondary {
  background: #f0f0f0;
  border: 1px solid #ccc;
  color: #333;
}
button.secondary:hover {
  background: #e0e0e0;
}
button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}
```

6. Update the h1 text:
```html
<h1>P&E Web Capture</h1>
```

The popup should now have:
- Title: "P&E Web Capture"
- Pending count section (hidden by default, shown when count > 0)
- Status display
- Test Connection button
- Sync Now button (keep for Jira sync backward compatibility)
- Capture This Page button (new)
- Settings button
- Refresh Rules button (new)
- Info area
  </action>
  <verify>
`grep -E "captureBtn|refreshRulesBtn|pendingSection|pendingCount" extension/popup/popup.html`
  </verify>
  <done>
- popup.html has title "P&E Web Capture"
- popup.html has pendingSection with pendingCount display
- popup.html has captureBtn button
- popup.html has refreshRulesBtn button
  </done>
</task>

<task type="auto">
  <name>Task 2: Add capture and rule refresh handlers to popup.js</name>
  <files>extension/popup/popup.js</files>
  <action>
Update popup.js to handle the new buttons and pending count:

1. Add element references at the top:
```javascript
const pendingSection = document.getElementById('pendingSection');
const pendingCountEl = document.getElementById('pendingCount');
const viewInboxLink = document.getElementById('viewInbox');
const captureBtn = document.getElementById('captureBtn');
const refreshRulesBtn = document.getElementById('refreshRulesBtn');
```

2. Update loadStatus() to also load pending count:
- Add to the existing loadStatus() function, after checking isConfigured:
```javascript
// Load pending count
try {
  const pendingResponse = await chrome.runtime.sendMessage({ type: 'GET_PENDING_COUNT' });
  if (pendingResponse.success && pendingResponse.count > 0) {
    pendingSection.style.display = 'flex';
    pendingCountEl.textContent = pendingResponse.count;
  } else {
    pendingSection.style.display = 'none';
  }
} catch (e) {
  // Ignore if service worker doesn't support this yet
  pendingSection.style.display = 'none';
}
```

3. Add captureBtn click handler:
```javascript
captureBtn.addEventListener('click', async () => {
  captureBtn.disabled = true;
  captureBtn.textContent = 'Capturing...';

  try {
    const response = await chrome.runtime.sendMessage({ type: 'MANUAL_CAPTURE' });

    if (response.success) {
      captureBtn.textContent = 'Captured!';
      // Refresh pending count
      await loadStatus();
    } else {
      captureBtn.textContent = 'Capture Failed';
      infoEl.textContent = response.error || 'Unknown error';
    }
  } catch (error) {
    captureBtn.textContent = 'Capture Failed';
    infoEl.textContent = error.message;
  }

  // Reset button after 2 seconds
  setTimeout(() => {
    captureBtn.textContent = 'Capture This Page';
    captureBtn.disabled = false;
  }, 2000);
});
```

4. Add refreshRulesBtn click handler:
```javascript
refreshRulesBtn.addEventListener('click', async () => {
  refreshRulesBtn.disabled = true;
  refreshRulesBtn.textContent = 'Refreshing...';

  try {
    const response = await chrome.runtime.sendMessage({ type: 'REFRESH_RULES' });

    if (response.success) {
      refreshRulesBtn.textContent = `${response.count} rules loaded`;
    } else {
      refreshRulesBtn.textContent = 'Refresh Failed';
      infoEl.textContent = response.error || 'Unknown error';
    }
  } catch (error) {
    refreshRulesBtn.textContent = 'Refresh Failed';
    infoEl.textContent = error.message;
  }

  // Reset button after 2 seconds
  setTimeout(() => {
    refreshRulesBtn.textContent = 'Refresh Rules';
    refreshRulesBtn.disabled = false;
  }, 2000);
});
```

5. Add viewInbox click handler:
```javascript
viewInboxLink.addEventListener('click', async (e) => {
  e.preventDefault();
  // Open P&E Manager capture inbox page
  const backendUrl = await chrome.storage.local.get('backendUrl');
  const baseUrl = backendUrl.backendUrl || 'https://pe-manager-frontend.cfapps.eu01-canary.hana.ondemand.com';
  // Remove -backend from URL if present and construct frontend inbox URL
  const frontendUrl = baseUrl.replace('-backend', '-frontend').replace('/api', '');
  chrome.tabs.create({ url: `${frontendUrl}/capture-inbox` });
});
```

6. Add storage change listener for pending count:
```javascript
// Existing listener already handles lastSync changes
// Add pendingInboxCount handling:
chrome.storage.onChanged.addListener((changes, namespace) => {
  if (namespace === 'local') {
    if (changes.lastSync) {
      const newStatus = changes.lastSync.newValue;
      updateStatusFromSync(newStatus);
    }
    if (changes.pendingInboxCount) {
      const count = changes.pendingInboxCount.newValue || 0;
      if (count > 0) {
        pendingSection.style.display = 'flex';
        pendingCountEl.textContent = count;
      } else {
        pendingSection.style.display = 'none';
      }
    }
  }
});
```

NOTE: The GET_PENDING_COUNT message handler needs to be added to service-worker.js. Add this as part of this task by updating service-worker.js:

In service-worker.js, add to MessageType:
```javascript
GET_PENDING_COUNT: 'GET_PENDING_COUNT',
```

And add handler in handleMessage:
```javascript
case MessageType.GET_PENDING_COUNT:
  const count = await Storage.getPendingCount();
  return { success: true, count };
```
  </action>
  <verify>
`grep -E "captureBtn|refreshRulesBtn|MANUAL_CAPTURE|REFRESH_RULES|GET_PENDING_COUNT" extension/popup/popup.js`
`grep "GET_PENDING_COUNT" extension/service-worker.js`
  </verify>
  <done>
- popup.js handles captureBtn click with MANUAL_CAPTURE message
- popup.js handles refreshRulesBtn click with REFRESH_RULES message
- popup.js loads and displays pending count
- popup.js updates pending count from storage changes
- service-worker.js handles GET_PENDING_COUNT message
  </done>
</task>

<task type="auto">
  <name>Task 3: Initialize badge on startup with pending count</name>
  <files>extension/service-worker.js</files>
  <action>
Update service-worker.js to initialize badge with pending count on startup:

1. In the onStartup handler, add a call to updatePendingBadge():
```javascript
chrome.runtime.onStartup.addListener(async () => {
  console.log('[PE-Capture] Service worker started');

  // Restore Jira sync badge state
  const lastSync = await Storage.getLastSync();
  // Only show Jira sync badge if there was an error (pending count takes priority otherwise)
  if (lastSync.status === 'error') {
    await updateBadge(lastSync.status);
  }

  // Load capture rules
  await loadRulesFromCache();
  await scheduleRuleRefresh();

  // Update pending capture badge (takes priority over sync status)
  await updatePendingBadge();
});
```

2. In the onInstalled handler, also initialize pending badge:
```javascript
chrome.runtime.onInstalled.addListener(async (details) => {
  console.log('[PE-Capture] Extension installed:', details.reason);

  if (details.reason === 'install') {
    await Storage.initDefaults();
    console.log('[PE-Capture] Default settings initialized');
  }

  // Load rules on install/update
  await loadRulesFromCache();
  await scheduleRuleRefresh();

  // Initialize pending badge
  await updatePendingBadge();
});
```

3. The updatePendingBadge function (already implemented in 07-02) should:
- Fetch pending count from API
- Show orange badge if count > 0
- Clear badge if count is 0
- Store count in storage for offline access

This ensures:
- Badge shows pending count on browser restart
- Badge shows pending count after extension install/update
- Pending count badge takes visual priority over Jira sync status
  </action>
  <verify>
`grep -E "updatePendingBadge|onStartup|onInstalled" extension/service-worker.js`
  </verify>
  <done>
- onStartup calls updatePendingBadge()
- onInstalled calls updatePendingBadge()
- Badge shows pending count on startup
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Reload extension in Chrome
2. Open popup - should show "P&E Web Capture" title
3. If there are pending inbox items, should show yellow "X captures pending review" section
4. Click "Capture This Page":
   - If on a page matching a rule: should capture and show "Captured!"
   - If on a page without matching rule: should show "No capture script on this page..."
5. Click "Refresh Rules": should show "X rules loaded" briefly
6. Click "View Inbox" link: should open P&E Manager capture inbox page
7. Badge should show pending count (orange) when items exist
</verification>

<success_criteria>
- [ ] popup.html has title "P&E Web Capture"
- [ ] popup.html has pending count display section
- [ ] popup.html has "Capture This Page" button
- [ ] popup.html has "Refresh Rules" button
- [ ] popup.js handles capture button click with MANUAL_CAPTURE message
- [ ] popup.js handles refresh rules button click with REFRESH_RULES message
- [ ] popup.js displays and updates pending count
- [ ] service-worker.js handles GET_PENDING_COUNT message
- [ ] service-worker.js initializes badge on startup
- [ ] Badge shows pending inbox count
</success_criteria>

<output>
After completion, create `.planning/phases/07-extension-core/07-03-SUMMARY.md`
</output>
