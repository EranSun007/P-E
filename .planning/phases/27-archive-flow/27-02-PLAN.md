---
phase: 27-archive-flow
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/contexts/SyncContext.jsx
autonomous: true

must_haves:
  truths:
    - "Setting status to 'done' automatically archives the sync item"
    - "Archived item disappears from Kanban board immediately"
    - "Archived count badge increments after auto-archive"
  artifacts:
    - path: "src/contexts/SyncContext.jsx"
      provides: "Auto-archive logic in updateItem"
      contains: "shouldAutoArchive"
  key_links:
    - from: "src/contexts/SyncContext.jsx updateItem"
      to: "archived state update"
      via: "status transition detection (sync_status === 'done' triggers archived: true)"
      pattern: "shouldAutoArchive"
---

<objective>
Implement auto-archive behavior when sync item status changes to "done".

Purpose: Fulfill UI-19 requirement - resolving an item automatically archives it, keeping the active Kanban board focused on in-progress work.
Output: Modified updateItem function in SyncContext that detects status="done" transitions and auto-archives.
</objective>

<execution_context>
@/Users/i306072/.claude/get-shit-done/workflows/execute-plan.md
@/Users/i306072/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-archive-flow/27-RESEARCH.md

Key context from research:
- UI-19 says "resolved" but codebase uses "done" status (see SYNC_STATUSES constant)
- SyncContext already has archiveItem(), restoreItem() functions
- updateItem() currently does optimistic updates without archive logic

Existing updateItem (lines 110-125):
@src/contexts/SyncContext.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add auto-archive logic to updateItem</name>
  <files>src/contexts/SyncContext.jsx</files>
  <action>
Modify the updateItem function to automatically archive items when status changes to "done".

Requirements:
1. Detect status transition: updates.sync_status === 'done' AND current item's sync_status !== 'done'
2. When auto-archiving:
   - Add archived: true to the updates object
   - Optimistically remove item from items array (not just update it)
   - Increment archivedCount by 1
3. On API error, refresh() will restore correct state (existing pattern)

Implementation:

Replace the existing updateItem callback (around lines 110-125) with:

```jsx
// Update a sync item (optimistic update with auto-archive detection)
const updateItem = useCallback(async (id, updates) => {
  // Find current item to check for status transition
  const currentItem = items.find(item => item.id === id);

  // Check if this is a status transition to "done" (auto-archive trigger)
  const shouldAutoArchive =
    updates.sync_status === 'done' &&
    currentItem?.sync_status !== 'done';

  // If auto-archiving, add archived flag to updates
  if (shouldAutoArchive) {
    updates = { ...updates, archived: true };
  }

  // Optimistic update
  if (shouldAutoArchive) {
    // Remove from active items (archiving)
    setItems(prev => prev.filter(item => item.id !== id));
    setArchivedCount(prev => prev + 1);
  } else {
    // Regular update (keep in list)
    setItems(prev =>
      prev.map(item => item.id === id ? { ...item, ...updates } : item)
    );
  }

  try {
    const updatedItem = await SyncItem.update(id, updates);
    return updatedItem;
  } catch (error) {
    console.error('Failed to update sync item:', error);
    // Refresh on failure to restore correct state
    await refresh();
    throw error;
  }
}, [items, refresh]);
```

Key behavior notes:
- Only auto-archives when transitioning TO "done", not when already "done"
- Combines archived:true with the user's updates in single API call
- Optimistic UI: item disappears immediately from Kanban board
- Badge count increments immediately
- On error, full refresh restores correct state
  </action>
  <verify>
ESLint passes. Build succeeds. Verify shouldAutoArchive pattern exists.
```bash
npm run lint -- --no-warn-ignored src/contexts/SyncContext.jsx
npm run build:client 2>&1 | head -20
grep "shouldAutoArchive" src/contexts/SyncContext.jsx
```

Manual integration test (auto-archive spans UI state, API call, and optimistic updates):
1. Start dev server: npm run dev
2. Navigate to TeamSync
3. Open an item with status != "done"
4. Change status to "Done" and save
5. Verify: Item disappears from Kanban board, Archive badge increments
6. Open Archive modal, verify item appears in archived list
  </verify>
  <done>Changing sync item status to "done" automatically archives it - item disappears from Kanban, badge increments</done>
</task>

</tasks>

<verification>
1. Open a sync item in TeamSync that has status "Not Started" or "In Progress"
2. Edit the item and change status to "Done"
3. Save the changes
4. Verify item is removed from Kanban board
5. Verify Archive button badge count increased by 1
6. Open Archive modal and verify the item appears in the list
7. Restore the item and verify it returns to Kanban board
</verification>

<success_criteria>
- SyncContext.jsx updateItem function includes shouldAutoArchive detection
- Status "done" transition triggers archived: true in updates
- Optimistic update removes item from items array when archiving
- Optimistic update increments archivedCount when archiving
- All ESLint rules pass
- Build completes without errors
</success_criteria>

<output>
After completion, create `.planning/phases/27-archive-flow/27-02-SUMMARY.md`
</output>
