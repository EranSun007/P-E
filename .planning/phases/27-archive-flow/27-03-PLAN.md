---
phase: 27-archive-flow
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - server/services/SyncItemService.js
  - server/db/migrate.js
  - server/db/024_archived_at.sql
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Setting status to 'done' triggers archived:true in database"
    - "Archived items display their archived timestamp (not 'Unknown date')"
    - "Auto-archive via update() stores archived_at timestamp"
  artifacts:
    - path: "server/services/SyncItemService.js"
      provides: "allowedFields includes 'archived', update/archive methods set archived_at"
      contains: "'archived'"
    - path: "server/db/024_archived_at.sql"
      provides: "Migration adding archived_at TIMESTAMP column"
      contains: "archived_at"
    - path: "server/db/migrate.js"
      provides: "Migration entry for 024_archived_at"
      contains: "024_archived_at"
  key_links:
    - from: "SyncItemService.update()"
      to: "archived column"
      via: "allowedFields whitelist"
      pattern: "'archived'"
    - from: "SyncItemService.archive()"
      to: "archived_at column"
      via: "SQL UPDATE SET archived_at"
      pattern: "archived_at = "
---

<objective>
Fix two verification gaps: auto-archive on status="done" and archived_at timestamp storage.

Purpose: Close gaps identified in 27-VERIFICATION.md that prevent auto-archive from working and archived dates from displaying.
Output: Backend service allows archived flag in updates, database stores archived_at timestamp, getArchived returns the timestamp.
</objective>

<execution_context>
@/Users/i306072/.claude/get-shit-done/workflows/execute-plan.md
@/Users/i306072/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-archive-flow/27-VERIFICATION.md

Existing code context:
@server/services/SyncItemService.js (lines 172-176 - allowedFields excludes 'archived')
@server/db/022_sync_items.sql (line 14 - only archived BOOLEAN, no timestamp)
@src/components/sync/ArchivedItemCard.jsx (lines 19-21 - uses item.archived_at)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add archived_at column via migration</name>
  <files>server/db/024_archived_at.sql, server/db/migrate.js</files>
  <action>
Create a new migration file to add the archived_at TIMESTAMP column to projects table.

1. Create server/db/024_archived_at.sql:
```sql
-- Migration: 024_archived_at
-- Add archived_at timestamp column for tracking when items were archived

-- Add archived_at column to projects table
ALTER TABLE projects ADD COLUMN IF NOT EXISTS archived_at TIMESTAMP;

-- Create index for date range filtering on archived items
CREATE INDEX IF NOT EXISTS idx_projects_archived_at ON projects(archived_at);

-- Backfill: Set archived_at to updated_date for existing archived items
UPDATE projects
SET archived_at = updated_date
WHERE archived = true AND archived_at IS NULL;
```

2. Update server/db/migrate.js - add new migration entry to MIGRATIONS array (after 023_team_summaries):
```javascript
{
  version: '024_archived_at',
  name: 'Add archived_at timestamp column to projects',
  file: '024_archived_at.sql'
}
```

Note: The backfill uses updated_date as a reasonable approximation for when existing items were archived.
  </action>
  <verify>
```bash
cat server/db/024_archived_at.sql
grep "024_archived_at" server/db/migrate.js
npm run migrate 2>&1 | tail -10
```
  </verify>
  <done>Migration file exists, registered in migrate.js, runs successfully adding archived_at column</done>
</task>

<task type="auto">
  <name>Task 2: Fix SyncItemService to handle archived flag and timestamp</name>
  <files>server/services/SyncItemService.js</files>
  <action>
Update SyncItemService to:
1. Add 'archived' to allowedFields in update() method
2. Set archived_at timestamp when archived:true in update()
3. Set archived_at timestamp in archive() method
4. Clear archived_at when restoring in restore() method
5. Return archived_at in getArchived() query

Specific changes:

**Line 172-176 - Add 'archived' to allowedFields:**
```javascript
const allowedFields = [
  'name', 'description', 'category', 'sync_status',
  'team_department', 'assigned_to_id', 'sprint_id',
  'week_start_date', 'display_order', 'archived'
];
```

**After the allowedFields loop (around line 188) - Add archived_at handling:**
```javascript
// If archived is being set to true, also set archived_at timestamp
if (updates.archived === true) {
  updateFields.push(`archived_at = $${paramIndex}`);
  values.push(new Date().toISOString());
  paramIndex++;
} else if (updates.archived === false) {
  // Clear archived_at when un-archiving via update
  updateFields.push(`archived_at = $${paramIndex}`);
  values.push(null);
  paramIndex++;
}
```

**In archive() method (around line 273-276) - Add archived_at to UPDATE:**
Replace the SQL from:
```javascript
const sql = `
  UPDATE projects
  SET archived = true, status_history = $1
  WHERE id = $2 AND user_id = $3 AND is_sync_item = true
  RETURNING *
`;
```
To:
```javascript
const sql = `
  UPDATE projects
  SET archived = true, archived_at = $1, status_history = $2
  WHERE id = $3 AND user_id = $4 AND is_sync_item = true
  RETURNING *
`;

const result = await query(sql, [new Date().toISOString(), JSON.stringify(status_history), syncItemId, userId]);
```

**In restore() method (around line 316-319) - Clear archived_at:**
Replace the SQL from:
```javascript
const sql = `
  UPDATE projects
  SET archived = false, status_history = $1
  WHERE id = $2 AND user_id = $3 AND is_sync_item = true
  RETURNING *
`;
```
To:
```javascript
const sql = `
  UPDATE projects
  SET archived = false, archived_at = NULL, status_history = $1
  WHERE id = $2 AND user_id = $3 AND is_sync_item = true
  RETURNING *
`;
```

**In getArchived() method (around line 345-350) - Filter by archived_at instead of created_date:**
Change the date filtering from created_date to archived_at for more accurate filtering:
```javascript
if (from_date) {
  conditions.push(`archived_at >= $${paramIndex}`);
  params.push(from_date);
  paramIndex++;
}

if (to_date) {
  conditions.push(`archived_at <= $${paramIndex}`);
  params.push(to_date);
  paramIndex++;
}
```

And update the ORDER BY to sort by archived_at:
```javascript
const sql = `
  SELECT * FROM projects
  WHERE ${conditions.join(' AND ')}
  ORDER BY archived_at DESC
`;
```
  </action>
  <verify>
```bash
# Check 'archived' is in allowedFields
grep -A 5 "const allowedFields" server/services/SyncItemService.js | grep archived

# Check archived_at is set in update
grep "archived_at" server/services/SyncItemService.js

# Lint check
npm run lint -- --no-warn-ignored server/services/SyncItemService.js 2>&1 | head -10
```
  </verify>
  <done>SyncItemService.update() allows 'archived' field, sets archived_at timestamp when archiving, clears it when restoring</done>
</task>

</tasks>

<verification>
1. Run migration: `npm run migrate` - should add archived_at column
2. Verify schema: Connect to database, check `\d projects` includes archived_at column
3. Test auto-archive: Change item status to "done" via UI - item should disappear from Kanban, appear in archive modal with correct date
4. Test archive modal: Open archive modal - items should show archived date (not "Unknown date")
5. Test restore: Restore an archived item - archived_at should be cleared

Integration test (manual):
```bash
# Start dev server
npm run dev

# In TeamSync:
# 1. Create a sync item with status "Not Started"
# 2. Edit the item, change status to "Done", save
# 3. Verify item disappears from Kanban board
# 4. Open Archive modal
# 5. Verify item appears with today's date (not "Unknown date")
# 6. Click Restore
# 7. Verify item returns to Kanban board
```
</verification>

<success_criteria>
- Migration 024_archived_at.sql exists and adds archived_at TIMESTAMP column
- migrate.js includes 024_archived_at migration entry
- SyncItemService.update() allowedFields includes 'archived'
- SyncItemService sets archived_at = NOW() when archived:true
- SyncItemService clears archived_at = NULL when archived:false or restoring
- getArchived() filters by archived_at (not created_date) and returns the field
- All ESLint rules pass
- Auto-archive works: status="done" archives item AND stores timestamp
- Archive modal displays correct archived date
</success_criteria>

<output>
After completion, create `.planning/phases/27-archive-flow/27-03-SUMMARY.md`
</output>
