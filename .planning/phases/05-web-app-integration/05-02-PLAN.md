---
phase: 05-web-app-integration
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/pages/JiraIssues.jsx
  - src/components/jira/WorkloadView.jsx
  - src/components/jira/AssigneeMappingDialog.jsx
autonomous: true

must_haves:
  truths:
    - "User can switch between Issues view and Workload view"
    - "Workload view groups issues by assignee with point totals"
    - "User can click 'Link Assignees' to open mapping dialog"
    - "Mapping dialog shows all Jira assignees with team member dropdown"
    - "Saving a mapping persists it via JiraMapping API"
    - "Mapped assignees show team member name in workload view"
  artifacts:
    - path: "src/pages/JiraIssues.jsx"
      provides: "Tabs for Issues/Workload views, Link Assignees button"
      contains: "Tabs"
    - path: "src/components/jira/WorkloadView.jsx"
      provides: "Workload grouping component"
      contains: "export default function WorkloadView"
    - path: "src/components/jira/AssigneeMappingDialog.jsx"
      provides: "Assignee mapping dialog component"
      contains: "export default function AssigneeMappingDialog"
  key_links:
    - from: "src/pages/JiraIssues.jsx"
      to: "src/components/jira/WorkloadView.jsx"
      via: "import WorkloadView"
      pattern: "import WorkloadView from.*jira/WorkloadView"
    - from: "src/pages/JiraIssues.jsx"
      to: "src/components/jira/AssigneeMappingDialog.jsx"
      via: "import AssigneeMappingDialog"
      pattern: "import AssigneeMappingDialog from.*jira/AssigneeMappingDialog"
    - from: "src/components/jira/AssigneeMappingDialog.jsx"
      to: "@/api/entities JiraMapping"
      via: "JiraMapping.create or JiraMapping.update"
      pattern: "JiraMapping\\.(create|update)"
---

<objective>
Add team workload view and assignee-to-team-member mapping to the Jira Issues page.

Purpose: Users can visualize team workload distribution and link Jira assignees to P&E Manager team members for better tracking.
Output: Tabbed interface (Issues/Workload), workload grouped by assignee with point totals, assignee mapping dialog.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-web-app-integration/05-RESEARCH.md
@.planning/phases/05-web-app-integration/05-01-SUMMARY.md

# Files to modify
@src/pages/JiraIssues.jsx

# Reference patterns
@src/pages/Team.jsx
@src/pages/GitHubRepos.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WorkloadView component</name>
  <files>src/components/jira/WorkloadView.jsx</files>
  <action>
Create directory `src/components/jira/` and file `WorkloadView.jsx`.

The component receives issues array and mappings, groups by assignee, calculates totals:

```javascript
import { useMemo } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Badge } from "@/components/ui/badge";
import { ExternalLink, User } from "lucide-react";

export default function WorkloadView({ issues, mappings = {}, teamMembers = [] }) {
  // Group issues by assignee
  const workloadByAssignee = useMemo(() => {
    const groups = {};

    issues.forEach(issue => {
      const assigneeId = issue.jira_assignee_id || 'unassigned';
      const assigneeName = issue.assignee_name || 'Unassigned';

      if (!groups[assigneeId]) {
        // Check if this assignee is mapped to a team member
        const mapping = mappings[assigneeId];
        const teamMember = mapping ? teamMembers.find(m => m.id === mapping.team_member_id) : null;

        groups[assigneeId] = {
          assigneeId,
          assigneeName,
          teamMember,
          issues: [],
          totalPoints: 0,
          byStatus: { todo: 0, inProgress: 0, done: 0 }
        };
      }

      groups[assigneeId].issues.push(issue);
      groups[assigneeId].totalPoints += parseFloat(issue.story_points) || 0;

      // Categorize by status
      const status = (issue.status || '').toLowerCase();
      if (status.includes('done') || status.includes('closed')) {
        groups[assigneeId].byStatus.done++;
      } else if (status.includes('progress') || status.includes('review')) {
        groups[assigneeId].byStatus.inProgress++;
      } else {
        groups[assigneeId].byStatus.todo++;
      }
    });

    // Sort by total points descending
    return Object.values(groups).sort((a, b) => b.totalPoints - a.totalPoints);
  }, [issues, mappings, teamMembers]);

  if (issues.length === 0) {
    return (
      <div className="text-center py-12 text-gray-500">
        <User className="h-12 w-12 mx-auto mb-2 opacity-50" />
        <p>No issues to display workload</p>
      </div>
    );
  }

  return (
    <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
      {workloadByAssignee.map(group => (
        <Card key={group.assigneeId}>
          <CardHeader className="pb-2">
            <CardTitle className="flex items-center justify-between text-base">
              <div className="flex items-center gap-2">
                <User className="h-4 w-4 text-gray-400" />
                <span>{group.teamMember?.name || group.assigneeName}</span>
              </div>
              <Badge variant="secondary" className="text-lg">
                {group.totalPoints} pts
              </Badge>
            </CardTitle>
            {group.teamMember && group.teamMember.name !== group.assigneeName && (
              <p className="text-xs text-gray-400">Jira: {group.assigneeName}</p>
            )}
          </CardHeader>
          <CardContent>
            {/* Status breakdown */}
            <div className="flex gap-2 mb-3 text-xs">
              <Badge variant="outline" className="bg-gray-100">
                {group.byStatus.todo} To Do
              </Badge>
              <Badge variant="outline" className="bg-blue-100 text-blue-800">
                {group.byStatus.inProgress} In Progress
              </Badge>
              <Badge variant="outline" className="bg-green-100 text-green-800">
                {group.byStatus.done} Done
              </Badge>
            </div>

            {/* Issue list (show first 5) */}
            <div className="space-y-1 max-h-48 overflow-y-auto">
              {group.issues.slice(0, 5).map(issue => (
                <div key={issue.id} className="flex items-center justify-between text-sm py-1 border-b last:border-0">
                  <div className="flex-1 min-w-0">
                    <a
                      href={issue.url}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-blue-600 hover:underline inline-flex items-center gap-1"
                    >
                      {issue.issue_key}
                      <ExternalLink className="h-3 w-3" />
                    </a>
                    <p className="text-gray-500 truncate text-xs">{issue.summary}</p>
                  </div>
                  <Badge variant="outline" className="ml-2 text-xs">
                    {issue.story_points || 0}
                  </Badge>
                </div>
              ))}
              {group.issues.length > 5 && (
                <p className="text-xs text-gray-400 pt-1">
                  +{group.issues.length - 5} more issues
                </p>
              )}
            </div>
          </CardContent>
        </Card>
      ))}
    </div>
  );
}
```

Props:
- `issues` - Array of Jira issues from API
- `mappings` - Object keyed by jira_assignee_id with team_member_id values
- `teamMembers` - Array of team members for name lookup
  </action>
  <verify>
File exists at src/components/jira/WorkloadView.jsx.
No syntax errors (dev server compiles without error).
  </verify>
  <done>WorkloadView component groups issues by assignee, shows point totals, status breakdown, and top 5 issues per assignee.</done>
</task>

<task type="auto">
  <name>Task 2: Create AssigneeMappingDialog component</name>
  <files>src/components/jira/AssigneeMappingDialog.jsx</files>
  <action>
Create `src/components/jira/AssigneeMappingDialog.jsx`.

The dialog allows users to map Jira assignees to P&E Manager team members:

```javascript
import { useState, useEffect } from "react";
import { JiraMapping, TeamMember } from "@/api/entities";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogTitle
} from "@/components/ui/dialog";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue
} from "@/components/ui/select";
import { Button } from "@/components/ui/button";
import { Loader2, Link2, User } from "lucide-react";
import { Alert, AlertDescription } from "@/components/ui/alert";

export default function AssigneeMappingDialog({
  open,
  onOpenChange,
  jiraAssignees = [],
  onMappingsUpdated
}) {
  const [teamMembers, setTeamMembers] = useState([]);
  const [mappings, setMappings] = useState({});
  const [loading, setLoading] = useState(true);
  const [saving, setSaving] = useState(false);
  const [error, setError] = useState(null);

  // Load team members and existing mappings when dialog opens
  useEffect(() => {
    if (open) {
      loadData();
    }
  }, [open]);

  const loadData = async () => {
    setLoading(true);
    setError(null);
    try {
      const [members, existingMappings] = await Promise.all([
        TeamMember.list(),
        JiraMapping.list()
      ]);

      setTeamMembers(members);

      // Convert mappings array to object keyed by jira_assignee_id
      const mappingsObj = {};
      existingMappings.forEach(m => {
        mappingsObj[m.jira_assignee_id] = m;
      });
      setMappings(mappingsObj);
    } catch (err) {
      console.error('Failed to load mapping data:', err);
      setError('Failed to load data');
    } finally {
      setLoading(false);
    }
  };

  const handleMappingChange = async (jiraAssigneeId, jiraAssigneeName, teamMemberId) => {
    setSaving(true);
    setError(null);

    try {
      const existingMapping = mappings[jiraAssigneeId];

      if (teamMemberId === 'none') {
        // Remove mapping
        if (existingMapping) {
          await JiraMapping.delete(existingMapping.id);
          const newMappings = { ...mappings };
          delete newMappings[jiraAssigneeId];
          setMappings(newMappings);
        }
      } else if (existingMapping) {
        // Update existing mapping
        const updated = await JiraMapping.update(existingMapping.id, {
          team_member_id: teamMemberId
        });
        setMappings(prev => ({
          ...prev,
          [jiraAssigneeId]: updated
        }));
      } else {
        // Create new mapping
        const created = await JiraMapping.create({
          jira_assignee_id: jiraAssigneeId,
          jira_assignee_name: jiraAssigneeName,
          team_member_id: teamMemberId
        });
        setMappings(prev => ({
          ...prev,
          [jiraAssigneeId]: created
        }));
      }
    } catch (err) {
      console.error('Failed to save mapping:', err);
      setError('Failed to save mapping');
    } finally {
      setSaving(false);
    }
  };

  const handleClose = () => {
    if (onMappingsUpdated) {
      onMappingsUpdated(mappings);
    }
    onOpenChange(false);
  };

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent className="sm:max-w-lg">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <Link2 className="h-5 w-5" />
            Link Jira Assignees to Team Members
          </DialogTitle>
          <DialogDescription>
            Map Jira users to your P&E Manager team members for better workload tracking.
          </DialogDescription>
        </DialogHeader>

        {error && (
          <Alert variant="destructive">
            <AlertDescription>{error}</AlertDescription>
          </Alert>
        )}

        {loading ? (
          <div className="flex items-center justify-center py-8">
            <Loader2 className="h-6 w-6 animate-spin text-gray-400" />
          </div>
        ) : (
          <div className="space-y-4 py-4 max-h-96 overflow-y-auto">
            {jiraAssignees.length === 0 ? (
              <p className="text-center text-gray-500 py-4">
                No Jira assignees found. Sync some issues first.
              </p>
            ) : (
              jiraAssignees.map(assignee => (
                <div
                  key={assignee.id}
                  className="flex items-center justify-between gap-4 py-2 border-b last:border-0"
                >
                  <div className="flex items-center gap-2 min-w-0">
                    <User className="h-4 w-4 text-gray-400 flex-shrink-0" />
                    <span className="text-sm font-medium truncate">
                      {assignee.name}
                    </span>
                  </div>
                  <Select
                    value={mappings[assignee.id]?.team_member_id || 'none'}
                    onValueChange={(value) => handleMappingChange(assignee.id, assignee.name, value)}
                    disabled={saving}
                  >
                    <SelectTrigger className="w-[180px]">
                      <SelectValue placeholder="Not linked" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="none">Not linked</SelectItem>
                      {teamMembers.map(member => (
                        <SelectItem key={member.id} value={member.id}>
                          {member.name}
                        </SelectItem>
                      ))}
                    </SelectContent>
                  </Select>
                </div>
              ))
            )}
          </div>
        )}

        <DialogFooter>
          <Button onClick={handleClose} disabled={saving}>
            {saving ? (
              <>
                <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                Saving...
              </>
            ) : (
              'Done'
            )}
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

Props:
- `open` - Boolean to control dialog visibility
- `onOpenChange` - Callback when dialog closes
- `jiraAssignees` - Array of { id, name } for unique Jira assignees
- `onMappingsUpdated` - Callback with updated mappings when dialog closes
  </action>
  <verify>
File exists at src/components/jira/AssigneeMappingDialog.jsx.
No syntax errors (dev server compiles without error).
  </verify>
  <done>AssigneeMappingDialog component shows all Jira assignees with team member dropdowns, saves mappings via JiraMapping API.</done>
</task>

<task type="auto">
  <name>Task 3: Add tabbed views and mapping button to JiraIssues page</name>
  <files>src/pages/JiraIssues.jsx</files>
  <action>
Modify JiraIssues.jsx to add:

1. **New imports:**
```javascript
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Users, LayoutList, BarChart3 } from "lucide-react";
import { JiraMapping, TeamMember } from "@/api/entities";
import WorkloadView from "@/components/jira/WorkloadView";
import AssigneeMappingDialog from "@/components/jira/AssigneeMappingDialog";
```

2. **New state variables (add to existing state):**
```javascript
const [showMappingDialog, setShowMappingDialog] = useState(false);
const [mappings, setMappings] = useState({});
const [teamMembers, setTeamMembers] = useState([]);
```

3. **Load mappings and team members (add to existing loadData or create new function):**
```javascript
const loadMappings = async () => {
  try {
    const [mappingsList, members] = await Promise.all([
      JiraMapping.list(),
      TeamMember.list()
    ]);
    // Convert to object keyed by jira_assignee_id
    const mappingsObj = {};
    mappingsList.forEach(m => {
      mappingsObj[m.jira_assignee_id] = m;
    });
    setMappings(mappingsObj);
    setTeamMembers(members);
  } catch (err) {
    console.error('Failed to load mappings:', err);
  }
};

// Call in useEffect alongside issue loading
useEffect(() => {
  loadIssues();
  loadMappings();
  // ... existing code
}, []);
```

4. **Extract unique assignees for mapping dialog:**
```javascript
const uniqueAssignees = useMemo(() => {
  const seen = new Map();
  issues.forEach(issue => {
    if (issue.jira_assignee_id && !seen.has(issue.jira_assignee_id)) {
      seen.set(issue.jira_assignee_id, {
        id: issue.jira_assignee_id,
        name: issue.assignee_name || 'Unknown'
      });
    }
  });
  return Array.from(seen.values());
}, [issues]);
```

5. **Add "Link Assignees" button in header (next to sync status):**
```javascript
<Button variant="outline" onClick={() => setShowMappingDialog(true)}>
  <Users className="h-4 w-4 mr-2" />
  Link Assignees
</Button>
```

6. **Wrap main content in Tabs:**
```javascript
<Tabs defaultValue="issues" className="w-full">
  <TabsList>
    <TabsTrigger value="issues" className="flex items-center gap-1">
      <LayoutList className="h-4 w-4" />
      Issues
    </TabsTrigger>
    <TabsTrigger value="workload" className="flex items-center gap-1">
      <BarChart3 className="h-4 w-4" />
      Workload
    </TabsTrigger>
  </TabsList>

  <TabsContent value="issues" className="mt-4">
    {/* Existing filter bar and issues table */}
  </TabsContent>

  <TabsContent value="workload" className="mt-4">
    <WorkloadView
      issues={filteredIssues}
      mappings={mappings}
      teamMembers={teamMembers}
    />
  </TabsContent>
</Tabs>
```

7. **Add AssigneeMappingDialog at bottom of component (before closing div):**
```javascript
<AssigneeMappingDialog
  open={showMappingDialog}
  onOpenChange={setShowMappingDialog}
  jiraAssignees={uniqueAssignees}
  onMappingsUpdated={(newMappings) => setMappings(newMappings)}
/>
```

8. **Handle mapping updates callback:**
When dialog closes, refresh mappings so workload view shows updated team member names.
  </action>
  <verify>
1. Start dev server: `npm run dev`
2. Navigate to http://localhost:5173/Jira
3. Tab bar should show "Issues" and "Workload" tabs
4. Click Workload tab - should show grouped cards by assignee
5. Click "Link Assignees" button - dialog should open
6. Select a team member for an assignee - should save
7. Close dialog - workload view should show team member name
  </verify>
  <done>JiraIssues page has Issues/Workload tabs, workload view shows grouped cards, Link Assignees button opens mapping dialog.</done>
</task>

</tasks>

<verification>
Phase 5 Plan 02 success criteria verified:

1. **Tabbed interface works:**
   - Click Issues tab, see table view
   - Click Workload tab, see grouped cards

2. **Workload view correct:**
   - Issues grouped by assignee
   - Point totals shown per assignee
   - Status breakdown (To Do, In Progress, Done)

3. **Link Assignees button works:**
   - Click button, dialog opens
   - Shows all unique Jira assignees

4. **Mapping persistence works:**
   - Select team member for an assignee
   - Close dialog, reopen - mapping persists

5. **Mapped names display:**
   - After mapping, workload view shows team member name

```bash
# Quick verification
npm run dev
# Navigate to /Jira
# Test tabs, test mapping dialog, test workload view
```
</verification>

<success_criteria>
- [ ] WorkloadView.jsx exists in src/components/jira/
- [ ] AssigneeMappingDialog.jsx exists in src/components/jira/
- [ ] JiraIssues page has Issues and Workload tabs
- [ ] Workload tab shows issues grouped by assignee
- [ ] Point totals calculated and displayed per assignee
- [ ] Link Assignees button visible in header
- [ ] Mapping dialog opens and shows all unique assignees
- [ ] Mapping changes persist via JiraMapping API
- [ ] Mapped team member names show in workload view
</success_criteria>

<output>
After completion, create `.planning/phases/05-web-app-integration/05-02-SUMMARY.md`
</output>
