---
phase: 17-core-bug-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/services/BugService.js
  - src/pages/BugDashboard.jsx
autonomous: true

must_haves:
  truths:
    - "Bugs with deploy-metering in labels are categorized as deploy-metering"
    - "Bugs with service-broker in summary are categorized as service-broker"
    - "Component filter dropdown shows actual components from uploaded data"
    - "All Components is default selection in component filter"
  artifacts:
    - path: "server/services/BugService.js"
      provides: "Multi-source component extraction logic"
      contains: "extractComponent"
    - path: "src/pages/BugDashboard.jsx"
      provides: "Dynamic component filter population"
      contains: "Object.keys(kpis.category_distribution)"
  key_links:
    - from: "server/services/BugService.js"
      to: "enrichBugs"
      via: "extractComponent method"
      pattern: "extractComponent\\(bug\\)"
    - from: "src/pages/BugDashboard.jsx"
      to: "kpis.category_distribution"
      via: "dynamic component extraction"
      pattern: "Object\\.keys\\(.*category_distribution\\)"
---

<objective>
Fix component extraction logic and filter dropdown population

Purpose: Bugs are incorrectly categorized (only using CSV column, ignoring labels/summary) and the component filter shows hardcoded values instead of actual data from uploads.

Output: Backend extracts components from labels/summary/CSV with priority fallback. Frontend populates filter dropdown dynamically from KPI data.
</objective>

<execution_context>
@/Users/i306072/.claude/get-shit-done/workflows/execute-plan.md
@/Users/i306072/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-core-bug-fixes/17-RESEARCH.md
@server/services/BugService.js
@src/pages/BugDashboard.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix component extraction with multi-source priority</name>
  <files>server/services/BugService.js</files>
  <action>
Update the `extractComponent(bug)` method in BugService.js to use a priority-based extraction:

1. Priority 1 - Labels: Check bug.labels array for component keywords (case-insensitive)
   - If labels contain 'deploy' AND 'metering' -> return 'deploy-metering'
   - If labels contain 'service' AND 'broker' -> return 'service-broker'
   - If labels contain 'foss' OR 'vulnerabilit' -> return 'foss-vulnerabilities'
   - If labels contain 'cm-metering' -> return 'cm-metering'
   - If labels contain 'sdm-metering' -> return 'sdm-metering'

2. Priority 2 - Summary: Check bug.summary text for component keywords (case-insensitive)
   - Same pattern matching as labels

3. Priority 3 - CSV: Fall back to existing logic using bug.csv_components

4. Default: Return 'other' if no match found

Implementation approach:
- Join labels array with space, convert to lowercase for pattern matching
- Use .includes() for substring matching
- Return early on first match (priority order matters)

Do NOT change:
- The method signature
- How the method is called from enrichBugs()
- Any other methods in BugService

Why this approach:
- Labels are most explicit (user-assigned)
- Summary provides context when labels missing
- CSV column is backup for legacy data
  </action>
  <verify>
Run the server and verify:
1. Server starts without errors: `cd /Users/i306072/Documents/GitHub/P-E && npm run dev:server`
2. No syntax errors in BugService.js
  </verify>
  <done>
extractComponent method:
- Checks labels first (case-insensitive, handles array)
- Falls back to summary text matching
- Falls back to CSV component column
- Returns 'other' as default
  </done>
</task>

<task type="auto">
  <name>Task 2: Remove hardcoded ALLOWED_COMPONENTS and use dynamic extraction</name>
  <files>src/pages/BugDashboard.jsx</files>
  <action>
Update BugDashboard.jsx to dynamically populate the component filter from actual KPI data:

1. Remove the ALLOWED_COMPONENTS constant (lines 177-183 approximately)

2. Update the components derivation (around line 188-190) to:
   ```javascript
   const components = useMemo(() => {
     if (!kpis?.category_distribution) return [];
     return Object.keys(kpis.category_distribution).sort();
   }, [kpis]);
   ```

   Note: Use useMemo for performance (already imported). The sort() ensures consistent ordering.

3. The rest of the component filter JSX can remain unchanged - it already iterates over the `components` array.

Do NOT change:
- The filter onChange handler (already resets to 'all' on week/sprint change)
- The useEffect dependencies for data loading
- The component filter JSX structure

Why this works:
- category_distribution is calculated by BugService during upload
- It already contains all unique components found in the data
- Object.keys() extracts just the component names
- sort() provides alphabetical ordering for UX
  </action>
  <verify>
1. Start dev environment: `cd /Users/i306072/Documents/GitHub/P-E && npm run dev`
2. Open browser to http://localhost:5173/bug-dashboard
3. Verify no console errors about ALLOWED_COMPONENTS
4. If data exists, verify component dropdown shows components from the data
  </verify>
  <done>
BugDashboard component:
- No hardcoded ALLOWED_COMPONENTS constant
- Component filter populated from kpis.category_distribution keys
- useMemo used for performance optimization
- Components sorted alphabetically
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Backend verification:
   - BugService.js loads without syntax errors
   - extractComponent method has priority-based logic

2. Frontend verification:
   - BugDashboard.jsx compiles without errors
   - No hardcoded component list
   - Component filter shows dynamic values

3. Integration test (if data available):
   - Upload a CSV with bugs
   - Verify component filter shows components from that CSV
   - Verify bugs are categorized based on labels/summary content
</verification>

<success_criteria>
- FIX-01 addressed: extractComponent uses labels > summary > CSV priority
- FIX-02 addressed: Component filter populated from actual uploaded data
- No regressions: Dashboard still loads and displays KPIs
</success_criteria>

<output>
After completion, create `.planning/phases/17-core-bug-fixes/17-01-SUMMARY.md`
</output>
