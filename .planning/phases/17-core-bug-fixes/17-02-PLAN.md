---
phase: 17-core-bug-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - server/services/BugService.js
autonomous: true

must_haves:
  truths:
    - "Bug inflow rate is calculated as average bugs per week over 4-week rolling window"
    - "Category distribution chart shows all components with correct counts"
    - "Selecting a component filter updates KPIs, charts, and table"
  artifacts:
    - path: "server/services/BugService.js"
      provides: "Rolling window calculation for bug inflow rate"
      contains: "calculateBugInflowRate"
  key_links:
    - from: "server/services/BugService.js"
      to: "calculateKPIs"
      via: "calculateBugInflowRate helper method"
      pattern: "calculateBugInflowRate\\(bugs\\)"
---

<objective>
Fix bug inflow rate calculation and verify filter propagation

Purpose: Bug inflow rate uses incorrect simplified formula (totalBugs/4). Filter propagation and category chart need verification after 17-01 fixes.

Output: Correct 4-week rolling window calculation. Verified filter updates all dashboard components simultaneously.
</objective>

<execution_context>
@/Users/i306072/.claude/get-shit-done/workflows/execute-plan.md
@/Users/i306072/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-core-bug-fixes/17-RESEARCH.md
@server/services/BugService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement correct 4-week rolling window calculation</name>
  <files>server/services/BugService.js</files>
  <action>
Add a new helper method `calculateBugInflowRate(bugs)` and update `calculateKPIs()` to use it:

1. Add new method before calculateKPIs():
```javascript
/**
 * Calculate bug inflow rate using 4-week rolling window
 * Groups bugs by ISO week of creation, then calculates average of recent 4 weeks
 * @param {Array} bugs - Array of bug objects with created_date
 * @returns {number} - Average bugs per week (4-week rolling average)
 */
calculateBugInflowRate(bugs) {
  // Group bugs by ISO week of creation
  const weeklyGroups = {};
  for (const bug of bugs) {
    if (!bug.created_date) continue;
    const weekKey = this.getWeekKey(new Date(bug.created_date));
    weeklyGroups[weekKey] = (weeklyGroups[weekKey] || 0) + 1;
  }

  // Sort weeks chronologically
  const weeks = Object.keys(weeklyGroups).sort();

  // Handle edge cases
  if (weeks.length === 0) return 0;

  // If less than 4 weeks of data, return average of available weeks
  if (weeks.length < 4) {
    const totalBugs = Object.values(weeklyGroups).reduce((a, b) => a + b, 0);
    return weeks.length > 0 ? totalBugs / weeks.length : 0;
  }

  // Calculate 4-week rolling window (most recent 4 weeks)
  const recentWeeks = weeks.slice(-4);
  const recentBugCount = recentWeeks.reduce(
    (sum, week) => sum + (weeklyGroups[week] || 0),
    0
  );

  return recentBugCount / 4;
}
```

2. Update calculateKPIs() method - replace line 299:
   - FROM: `const bugInflowRate = totalBugs / 4; // Assume 4-week dataset`
   - TO: `const bugInflowRate = this.calculateBugInflowRate(bugs);`

3. Remove the old comment about "simplified" calculation

Do NOT change:
- The return structure of calculateKPIs()
- Other KPI calculations (median_ttfr, sla_percent, etc.)
- The getWeekKey() method (already exists and works)

Why this approach:
- Uses existing getWeekKey() for consistency
- Handles edge cases (empty data, <4 weeks)
- Groups by actual creation date, not upload date
- Returns rolling average for accurate trending
  </action>
  <verify>
1. Server starts without errors: `cd /Users/i306072/Documents/GitHub/P-E && npm run dev:server`
2. No syntax errors in BugService.js
3. calculateBugInflowRate method exists and is called from calculateKPIs
  </verify>
  <done>
BugService.js contains:
- New calculateBugInflowRate(bugs) method
- Method groups bugs by ISO week using getWeekKey()
- Returns 4-week rolling average (or available weeks if <4)
- calculateKPIs() calls this.calculateBugInflowRate(bugs)
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify filter propagation and category chart (FIX-03, FIX-04)</name>
  <files>None (verification only)</files>
  <action>
This task verifies that existing filter propagation works correctly after 17-01 fixes.

Per the research document (17-RESEARCH.md), section "Pattern 3: useEffect Dependency Synchronization":
- The existing implementation already has correct useEffect dependencies
- selectedComponent triggers re-fetch of KPIs and bugs via Promise.all
- KPIGrid and charts receive updated data automatically

Verification steps (manual inspection):
1. Review BugDashboard.jsx useEffect at lines 110-172:
   - Confirms [selectedUploadId, selectedSprint, selectedComponent, sprintOptions] dependencies
   - Confirms componentFilter is derived from selectedComponent
   - Confirms both getKPIs and listBugs receive componentFilter

2. Review data flow:
   - KPIGrid receives kpis prop (updated on filter change)
   - BugCategoryChart receives kpis.category_distribution (updated on filter change)
   - AgingBugsTable receives bugs array (updated on filter change)

3. For FIX-04 (category distribution chart):
   - After 17-01 fixes, category_distribution will contain correct component categorization
   - BugCategoryChart already transforms Object to array format correctly
   - No code changes needed - chart will display correct data once extraction is fixed

Document findings in summary as "verified working as designed".
  </action>
  <verify>
1. Read src/pages/BugDashboard.jsx
2. Confirm useEffect dependencies include selectedComponent
3. Confirm KPIGrid, BugCategoryChart, AgingBugsTable receive refreshed data
  </verify>
  <done>
Filter propagation verified:
- FIX-03: useEffect with selectedComponent dependency triggers refetch
- FIX-04: BugCategoryChart displays category_distribution correctly (will show correct data after 17-01 component extraction fix)
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. Backend verification:
   - BugService.js has calculateBugInflowRate method
   - Method uses getWeekKey() for week grouping
   - Method handles edge cases (0 bugs, <4 weeks)
   - calculateKPIs() uses the new method

2. Frontend verification (via code review):
   - useEffect has correct dependencies for filter propagation
   - All components receive data from single state refresh

3. Integration (if data available):
   - Upload CSV with bugs across multiple weeks
   - Verify bug_inflow_rate KPI shows rolling average, not simple totalBugs/4
   - Change component filter and verify all cards/charts update
</verification>

<success_criteria>
- FIX-05 addressed: Bug inflow rate uses 4-week rolling window
- FIX-03 verified: Filter propagation already working via useEffect
- FIX-04 verified: Category chart will display correct data after 17-01 fixes
- No regressions: All 9 KPIs still calculated and displayed
</success_criteria>

<output>
After completion, create `.planning/phases/17-core-bug-fixes/17-02-SUMMARY.md`
</output>
