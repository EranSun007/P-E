---
phase: 22-team-status-page
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/services/MCPService.js
  - server/routes/knowledge.js
  - src/contexts/TeamStatusContext.jsx
  - src/pages/TeamStatus.jsx
  - src/pages/index.jsx
  - src/api/apiClient.js
autonomous: true

must_haves:
  truths:
    - "User can navigate to Team Status page from sidebar"
    - "Page loads and displays loading state while fetching data"
    - "API returns insights filtered by date range and team"
  artifacts:
    - path: "server/services/MCPService.js"
      provides: "getInsights method for retrieving stored insights"
      contains: "getInsights"
    - path: "server/routes/knowledge.js"
      provides: "GET /insights endpoint"
      contains: "router.get('/insights'"
    - path: "src/contexts/TeamStatusContext.jsx"
      provides: "State management for team status data"
      exports: ["TeamStatusProvider", "useTeamStatus"]
    - path: "src/pages/TeamStatus.jsx"
      provides: "Team Status page component"
      min_lines: 50
  key_links:
    - from: "src/pages/TeamStatus.jsx"
      to: "TeamStatusContext"
      via: "useTeamStatus hook"
      pattern: "useTeamStatus"
    - from: "src/contexts/TeamStatusContext.jsx"
      to: "/api/knowledge/insights"
      via: "fetch in refresh callback"
      pattern: "knowledge.*insights"
---

<objective>
Build the backend API for retrieving stored insights and create the foundation for Team Status page.

Purpose: Enable data retrieval from MCP knowledge base and establish the page scaffold so UI components can be added in Plan 02.
Output: Working API endpoint, React Context for state, routable Team Status page with loading states.
</objective>

<execution_context>
@/Users/i306072/.claude/get-shit-done/workflows/execute-plan.md
@/Users/i306072/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-team-status-page/22-CONTEXT.md
@.planning/phases/22-team-status-page/22-RESEARCH.md
@server/services/MCPService.js
@server/routes/knowledge.js
@src/contexts/SyncContext.jsx
@src/api/apiClient.js
@src/pages/index.jsx
@src/utils/releaseCycles.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Insights Retrieval API</name>
  <files>
    server/services/MCPService.js
    server/routes/knowledge.js
    src/api/apiClient.js
  </files>
  <action>
Add GET endpoint for retrieving stored insights from MCP knowledge base.

**MCPService.js - Add getInsights method:**
- Add `getInsights(options)` method that calls the MCP tool `get_stored_insights` (or semantic search with category filter)
- Options: `{ startDate, endDate, teamDepartment, category, limit }`
- If MCP server doesn't have a dedicated retrieval tool, fall back to storing insights locally in PostgreSQL (create simple `team_summaries` table)
- Handle graceful fallback: if MCP retrieval fails, return empty array with logged warning

**knowledge.js routes - Add GET /insights:**
```javascript
router.get('/insights', async (req, res) => {
  const { startDate, endDate, teamDepartment, category, limit } = req.query;
  // Validate dates if provided
  // Call MCPService.getInsights
  // Return array of summaries
});
```

**apiClient.js - Add searchInsights method:**
```javascript
knowledge: {
  // ... existing methods
  async searchInsights(options) {
    const params = new URLSearchParams();
    if (options.startDate) params.append('startDate', options.startDate);
    if (options.endDate) params.append('endDate', options.endDate);
    if (options.teamDepartment) params.append('teamDepartment', options.teamDepartment);
    if (options.category) params.append('category', options.category);
    if (options.limit) params.append('limit', options.limit);
    return fetchWithAuth(`${API_BASE_URL}/knowledge/insights?${params.toString()}`);
  },
}
```

**Important:** Since MCP server may not have a dedicated "get stored insights" tool:
1. First try to use MCP's semantic search with category='team_summary'
2. If that doesn't work, implement a simple PostgreSQL fallback table
3. Return mock data structure even if empty: `{ summaries: [], total: 0 }`
  </action>
  <verify>
```bash
# Test the endpoint
curl -H "Authorization: Bearer $(cat .dev-token 2>/dev/null || echo 'dev')" \
  "http://localhost:3001/api/knowledge/insights?startDate=2026-01-01&teamDepartment=metering"
# Should return { summaries: [], total: 0 } or actual data if available
```
  </verify>
  <done>
GET /api/knowledge/insights endpoint returns insights array (empty if no data), filtered by query params.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TeamStatusContext and Page Scaffold</name>
  <files>
    src/contexts/TeamStatusContext.jsx
    src/pages/TeamStatus.jsx
    src/pages/index.jsx
  </files>
  <action>
Create the React Context for state management and basic page scaffold.

**TeamStatusContext.jsx - Follow SyncContext pattern:**
```javascript
import { createContext, useContext, useState, useEffect, useCallback, useMemo } from 'react';
import { apiClient } from '@/api/apiClient';
import { useAuth } from '@/contexts/AuthContext';
import { getCurrentCycle, getSprintById, listSprints, getPreviousCycleId } from '@/utils/releaseCycles';

export const TEAM_DEPARTMENTS = [
  { id: 'all', label: 'All Teams' },
  { id: 'metering', label: 'Metering' },
];

const TeamStatusContext = createContext(null);

export function TeamStatusProvider({ children }) {
  const [summaries, setSummaries] = useState([]);
  const [currentTeam, setCurrentTeam] = useState('metering'); // Default to Metering
  const [currentWeek, setCurrentWeek] = useState(null); // Sprint ID like '2601a'
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const { isAuthenticated } = useAuth();

  // Initialize to current sprint
  useEffect(() => {
    if (!currentWeek) {
      const cycle = getCurrentCycle();
      setCurrentWeek(cycle.currentSprint.id);
    }
  }, [currentWeek]);

  // Get available sprints (4 weeks = 2 cycles)
  const availableSprints = useMemo(() => {
    const current = getCurrentCycle();
    const prevCycleId = getPreviousCycleId(current.id);
    return listSprints(prevCycleId, 2); // 2 cycles = 4 sprints
  }, []);

  // Fetch summaries for current team and week
  const refresh = useCallback(async () => {
    if (!isAuthenticated || !currentWeek) {
      setSummaries([]);
      setLoading(false);
      return;
    }

    try {
      setLoading(true);
      setError(null);
      const sprint = getSprintById(currentWeek);

      if (!sprint) {
        setSummaries([]);
        return;
      }

      const result = await apiClient.knowledge.searchInsights({
        teamDepartment: currentTeam === 'all' ? undefined : currentTeam,
        startDate: sprint.startDate.toISOString().split('T')[0],
        endDate: sprint.endDate.toISOString().split('T')[0],
        category: 'team_summary'
      });

      setSummaries(result.summaries || []);
    } catch (err) {
      console.error('Failed to fetch team summaries:', err);
      setError(err.message);
      setSummaries([]);
    } finally {
      setLoading(false);
    }
  }, [isAuthenticated, currentTeam, currentWeek]);

  useEffect(() => {
    refresh();
  }, [refresh]);

  const value = {
    summaries,
    currentTeam,
    setCurrentTeam,
    currentWeek,
    setCurrentWeek,
    availableSprints,
    loading,
    error,
    refresh
  };

  return (
    <TeamStatusContext.Provider value={value}>
      {children}
    </TeamStatusContext.Provider>
  );
}

export function useTeamStatus() {
  const context = useContext(TeamStatusContext);
  if (!context) {
    throw new Error('useTeamStatus must be used within a TeamStatusProvider');
  }
  return context;
}
```

**TeamStatus.jsx - Basic page scaffold:**
```javascript
import { TeamStatusProvider, useTeamStatus, TEAM_DEPARTMENTS } from '@/contexts/TeamStatusContext';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Tabs, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Users, Loader2 } from 'lucide-react';

function TeamStatusContent() {
  const { summaries, currentTeam, setCurrentTeam, currentWeek, loading, error } = useTeamStatus();

  return (
    <div className="space-y-6">
      {/* Page Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-bold">Team Status</h1>
          <p className="text-muted-foreground">Weekly health and progress summaries</p>
        </div>
      </div>

      {/* Team Tabs */}
      <Tabs value={currentTeam} onValueChange={setCurrentTeam}>
        <TabsList>
          {TEAM_DEPARTMENTS.map(dept => (
            <TabsTrigger key={dept.id} value={dept.id}>
              {dept.label}
            </TabsTrigger>
          ))}
        </TabsList>
      </Tabs>

      {/* Loading State */}
      {loading && (
        <Card>
          <CardContent className="py-12 text-center">
            <Loader2 className="h-8 w-8 mx-auto animate-spin text-muted-foreground" />
            <p className="mt-4 text-muted-foreground">Loading team summaries...</p>
          </CardContent>
        </Card>
      )}

      {/* Error State */}
      {error && !loading && (
        <Card className="border-destructive">
          <CardContent className="py-8 text-center">
            <p className="text-destructive">Failed to load summaries: {error}</p>
          </CardContent>
        </Card>
      )}

      {/* Empty State */}
      {!loading && !error && summaries.length === 0 && (
        <Card>
          <CardContent className="py-12 text-center">
            <Users className="h-12 w-12 mx-auto text-muted-foreground mb-4" />
            <p className="text-muted-foreground mb-2">No team summaries for this week</p>
            <p className="text-sm text-muted-foreground">
              Data will appear once daily summaries are stored via MCP
            </p>
          </CardContent>
        </Card>
      )}

      {/* Content placeholder for Plan 02 */}
      {!loading && !error && summaries.length > 0 && (
        <Card>
          <CardHeader>
            <CardTitle>Team Summaries</CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-muted-foreground">
              {summaries.length} summaries loaded - UI components coming in next plan
            </p>
          </CardContent>
        </Card>
      )}
    </div>
  );
}

export default function TeamStatus() {
  return (
    <TeamStatusProvider>
      <TeamStatusContent />
    </TeamStatusProvider>
  );
}
```

**index.jsx - Add routing:**
1. Add lazy import for TeamStatus
2. Add to PAGES object
3. Add Route for /teamstatus

```javascript
// Add with other lazy imports
const TeamStatus = lazy(() => retryImport(() => import(/* webpackChunkName: "pages-team-status" */ "./TeamStatus"), 3, 1000));

// Add to PAGES object
TeamStatus: TeamStatus,

// Add route (before catch-all if any)
<Route path="/teamstatus" element={<TeamStatus />} />
```
  </action>
  <verify>
```bash
# Start dev server and verify page loads
npm run dev &
sleep 5
curl -s http://localhost:5173/teamstatus | head -20
# Should return HTML with root div (React will render)

# Check that context file exists and exports correctly
grep -n "export function TeamStatusProvider" src/contexts/TeamStatusContext.jsx
grep -n "export function useTeamStatus" src/contexts/TeamStatusContext.jsx
```
  </verify>
  <done>
Team Status page accessible at /teamstatus, displays loading state, team tabs work for switching, empty state shows when no data.
  </done>
</task>

</tasks>

<verification>
1. GET /api/knowledge/insights returns valid JSON (even if empty array)
2. TeamStatus page renders without errors
3. Team tabs switch between teams
4. Loading and empty states display correctly
5. No console errors when navigating to page
</verification>

<success_criteria>
- API endpoint responds with insights array
- Page accessible via /teamstatus route
- Context provides state management
- Loading, error, and empty states all render correctly
- Team tab selection updates currentTeam in context
</success_criteria>

<output>
After completion, create `.planning/phases/22-team-status-page/22-01-SUMMARY.md`
</output>
