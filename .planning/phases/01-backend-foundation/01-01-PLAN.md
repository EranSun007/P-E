---
phase: 01-backend-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/db/017_jira_integration.sql
  - server/db/migrate.js
autonomous: true
user_setup: []

must_haves:
  truths:
    - "jira_issues table exists with all required columns"
    - "jira_team_mappings table exists with FK to team_members"
    - "Both tables have proper indexes on user_id and query fields"
    - "Migration runs idempotently (safe to run multiple times)"
  artifacts:
    - path: "server/db/017_jira_integration.sql"
      provides: "Database schema for Jira integration"
      contains: "CREATE TABLE IF NOT EXISTS jira_issues"
    - path: "server/db/migrate.js"
      provides: "Migration registration"
      contains: "017_jira_integration"
  key_links:
    - from: "server/db/migrate.js"
      to: "server/db/017_jira_integration.sql"
      via: "MIGRATIONS array file reference"
      pattern: "file: '017_jira_integration.sql'"
---

<objective>
Create database schema and migration for Jira integration tables.

Purpose: Establish the data foundation for storing Jira issues synced from the browser extension and team member mappings.
Output: Migration file 017_jira_integration.sql with jira_issues and jira_team_mappings tables, registered in migrate.js.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md

Reference patterns:
@server/db/016_github_integration.sql (existing integration migration pattern)
@server/db/migrate.js (migration registration pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create 017_jira_integration.sql migration file</name>
  <files>server/db/017_jira_integration.sql</files>
  <action>
Create migration file with two tables following the GitHub integration pattern:

**jira_issues table** (REQ: DB-01):
```sql
CREATE TABLE IF NOT EXISTS jira_issues (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id VARCHAR(100) NOT NULL,
  issue_key VARCHAR(50) NOT NULL,
  summary TEXT,
  status VARCHAR(100),
  assignee_name VARCHAR(255),
  assignee_id VARCHAR(100),
  story_points NUMERIC(5,1),
  priority VARCHAR(50),
  issue_type VARCHAR(50),
  sprint_name VARCHAR(255),
  epic_key VARCHAR(50),
  jira_url VARCHAR(1024),
  synced_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(user_id, issue_key)
);

CREATE INDEX IF NOT EXISTS idx_jira_issues_user_id ON jira_issues(user_id);
CREATE INDEX IF NOT EXISTS idx_jira_issues_status ON jira_issues(status);
CREATE INDEX IF NOT EXISTS idx_jira_issues_assignee_id ON jira_issues(assignee_id);
CREATE INDEX IF NOT EXISTS idx_jira_issues_sprint ON jira_issues(sprint_name);
```

**jira_team_mappings table** (REQ: DB-02):
```sql
CREATE TABLE IF NOT EXISTS jira_team_mappings (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id VARCHAR(100) NOT NULL,
  jira_assignee_id VARCHAR(100) NOT NULL,
  jira_assignee_name VARCHAR(255),
  team_member_id UUID REFERENCES team_members(id) ON DELETE CASCADE,
  created_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_date TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(user_id, jira_assignee_id)
);

CREATE INDEX IF NOT EXISTS idx_jira_mappings_user_id ON jira_team_mappings(user_id);
CREATE INDEX IF NOT EXISTS idx_jira_mappings_team_member ON jira_team_mappings(team_member_id);
```

**Add triggers for auto-updating updated_date:**
```sql
DROP TRIGGER IF EXISTS update_jira_issues_updated_date ON jira_issues;
CREATE TRIGGER update_jira_issues_updated_date BEFORE UPDATE ON jira_issues
  FOR EACH ROW EXECUTE FUNCTION update_updated_date_column();

DROP TRIGGER IF EXISTS update_jira_mappings_updated_date ON jira_team_mappings;
CREATE TRIGGER update_jira_mappings_updated_date BEFORE UPDATE ON jira_team_mappings
  FOR EACH ROW EXECUTE FUNCTION update_updated_date_column();
```

Include header comment: `-- Migration: 017_jira_integration`
  </action>
  <verify>File exists and contains both CREATE TABLE statements with proper structure</verify>
  <done>017_jira_integration.sql exists with jira_issues and jira_team_mappings tables, all indexes, and triggers</done>
</task>

<task type="auto">
  <name>Task 2: Register migration in migrate.js</name>
  <files>server/db/migrate.js</files>
  <action>
Add new migration entry to the MIGRATIONS array in server/db/migrate.js.

Insert after the last entry (016_github_integration):
```javascript
{
  version: '017_jira_integration',
  name: 'Create tables for Jira issue tracking and team mappings',
  file: '017_jira_integration.sql'
}
```

Position: Append as last item in MIGRATIONS array (around line 89).
  </action>
  <verify>grep -n "017_jira_integration" server/db/migrate.js shows the new entry</verify>
  <done>Migration registered in MIGRATIONS array with correct version, name, and file path</done>
</task>

<task type="auto">
  <name>Task 3: Run migration to create tables</name>
  <files>None (database operation)</files>
  <action>
Run the migration to create the new tables:
```bash
npm run migrate
```

Expected output:
- "Running migration: Create tables for Jira issue tracking..."
- Migration 017_jira_integration completed successfully

If migration fails, check:
1. Database connection (is PostgreSQL running?)
2. update_updated_date_column function exists (from schema.sql)
3. team_members table exists (for FK reference)
  </action>
  <verify>
Verify tables exist:
```bash
# Connect to database and check tables
psql -U postgres -d pe_manager -c "\dt jira*"
```
Or via curl to health endpoint then check migration status.
  </verify>
  <done>Both jira_issues and jira_team_mappings tables exist in database with all indexes</done>
</task>

</tasks>

<verification>
1. Migration file exists: `ls server/db/017_jira_integration.sql`
2. Migration registered: `grep "017_jira_integration" server/db/migrate.js`
3. Tables created: Query database for table existence
4. Indexes exist: `\di jira*` in psql shows all indexes
5. Idempotency: Running `npm run migrate` again shows "Skipping already executed migration"
</verification>

<success_criteria>
- [ ] 017_jira_integration.sql exists with correct schema
- [ ] jira_issues table has: id, user_id, issue_key (unique per user), summary, status, assignee_name, assignee_id, story_points, priority, issue_type, sprint_name, epic_key, jira_url, synced_at, timestamps
- [ ] jira_team_mappings table has: id, user_id, jira_assignee_id (unique per user), jira_assignee_name, team_member_id (FK), timestamps
- [ ] Indexes on user_id, status, assignee_id, sprint_name for jira_issues
- [ ] Indexes on user_id, team_member_id for jira_team_mappings
- [ ] Migration runs successfully (npm run migrate)
- [ ] Migration is idempotent (can run multiple times safely)

**Requirements covered:** DB-01, DB-02, DB-03
</success_criteria>

<output>
After completion, create `.planning/phases/01-backend-foundation/01-01-SUMMARY.md`
</output>
