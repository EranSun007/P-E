---
phase: 19-mcp-client-backend
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - server/routes/knowledge.js
  - server/index.js
autonomous: true

must_haves:
  truths:
    - "User can call POST /api/knowledge/search/code with query and receive search results"
    - "User can call POST /api/knowledge/search/docs with query and receive documentation results"
    - "User can call POST /api/knowledge/insights to store a learning"
    - "User can call GET /api/knowledge/stats to retrieve repository statistics"
    - "User can call GET /api/knowledge/health to check MCP server connectivity"
    - "All endpoints require authentication (401 without auth)"
  artifacts:
    - path: "server/routes/knowledge.js"
      provides: "REST API routes for MCP tools"
      exports: ["router"]
      min_lines: 80
    - path: "server/index.js"
      provides: "Route mounting"
      contains: "app.use('/api/knowledge'"
  key_links:
    - from: "server/routes/knowledge.js"
      to: "server/services/MCPService.js"
      via: "import and method calls"
      pattern: "MCPService\\.(searchCode|searchDocs|storeInsight|getStats)"
    - from: "server/index.js"
      to: "server/routes/knowledge.js"
      via: "router import and mount"
      pattern: "knowledgeRouter.*api/knowledge"
---

<objective>
Create REST API routes exposing MCP tools to the frontend at /api/knowledge/*.

Purpose: Frontend needs HTTP endpoints to access knowledge base search and insight storage. These routes delegate to MCPService and follow the established route patterns.

Output: Express router with 5 endpoints mounted at /api/knowledge.
</objective>

<execution_context>
@/Users/i306072/.claude/get-shit-done/workflows/execute-plan.md
@/Users/i306072/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-mcp-client-backend/19-01-SUMMARY.md

@server/routes/github.js (pattern reference - route structure with authMiddleware)
@server/index.js (route mounting pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create knowledge routes file</name>
  <files>server/routes/knowledge.js</files>
  <action>
Create server/routes/knowledge.js following the pattern from github.js routes.

**File structure:**
```javascript
import express from 'express';
import MCPService from '../services/MCPService.js';
import { authMiddleware } from '../middleware/auth.js';

const router = express.Router();
router.use(authMiddleware);

// Routes go here...

export default router;
```

**Endpoints:**

**POST /search/code** - Semantic code search
```javascript
router.post('/search/code', async (req, res) => {
  try {
    const { query, limit, threshold, repoName, language, artifactType, ownership } = req.body;

    if (!query) {
      return res.status(400).json({ error: 'Query is required' });
    }

    const results = await MCPService.searchCode({
      query,
      limit: limit || 10,
      threshold,
      repoName,
      language,
      artifactType,
      ownership
    });

    res.json(results);
  } catch (error) {
    console.error('POST /api/knowledge/search/code error:', error);
    res.status(500).json({ error: error.message });
  }
});
```

**POST /search/docs** - Documentation search
```javascript
router.post('/search/docs', async (req, res) => {
  try {
    const { query, limit, threshold, domain, category } = req.body;

    if (!query) {
      return res.status(400).json({ error: 'Query is required' });
    }

    const results = await MCPService.searchDocs({
      query,
      limit: limit || 10,
      threshold,
      domain,
      category
    });

    res.json(results);
  } catch (error) {
    console.error('POST /api/knowledge/search/docs error:', error);
    res.status(500).json({ error: error.message });
  }
});
```

**POST /insights** - Store a learning
```javascript
router.post('/insights', async (req, res) => {
  try {
    const { insight, category, tags, relatedFiles } = req.body;

    if (!insight) {
      return res.status(400).json({ error: 'Insight is required' });
    }

    const result = await MCPService.storeInsight({
      insight,
      category,
      tags,
      relatedFiles
    });

    res.status(201).json(result);
  } catch (error) {
    console.error('POST /api/knowledge/insights error:', error);
    res.status(500).json({ error: error.message });
  }
});
```

**GET /stats** - Repository statistics
```javascript
router.get('/stats', async (req, res) => {
  try {
    const { repoName, statsType } = req.query;

    const stats = await MCPService.getStats({
      repoName,
      statsType: statsType || 'overall'
    });

    res.json(stats);
  } catch (error) {
    console.error('GET /api/knowledge/stats error:', error);
    res.status(500).json({ error: error.message });
  }
});
```

**GET /health** - MCP server health check
```javascript
router.get('/health', async (req, res) => {
  try {
    const health = await MCPService.getHealth();
    res.json(health);
  } catch (error) {
    console.error('GET /api/knowledge/health error:', error);
    res.status(500).json({ error: error.message, healthy: false });
  }
});
```

**Error patterns:**
- 400 for missing required fields (query, insight)
- 500 for MCP service errors
- All errors include error.message for debugging
  </action>
  <verify>
```bash
# Syntax check
node --check /Users/i306072/Documents/GitHub/P-E/server/routes/knowledge.js
```
  </verify>
  <done>
- server/routes/knowledge.js created
- POST /search/code endpoint for semantic code search
- POST /search/docs endpoint for documentation search
- POST /insights endpoint for storing learnings
- GET /stats endpoint for repository statistics
- GET /health endpoint for MCP server health
- All routes protected by authMiddleware
  </done>
</task>

<task type="auto">
  <name>Task 2: Mount knowledge routes in server/index.js</name>
  <files>server/index.js</files>
  <action>
Add knowledge router to server/index.js following the existing pattern.

1. **Add import** near other route imports (around line 30):
```javascript
import knowledgeRouter from './routes/knowledge.js';
```

2. **Add route mounting** after existing routes (around line 147):
```javascript
app.use('/api/knowledge', knowledgeRouter);
```

Place the import alphabetically with other route imports (between `import jiraRouter` and `import metricsRouter` or similar based on actual order).

Place the mounting line in the same section as other route mounts.
  </action>
  <verify>
```bash
# Verify syntax of entire server
node --check /Users/i306072/Documents/GitHub/P-E/server/index.js

# Verify import is present
grep -n "knowledgeRouter" /Users/i306072/Documents/GitHub/P-E/server/index.js

# Verify route mount is present
grep -n "api/knowledge" /Users/i306072/Documents/GitHub/P-E/server/index.js
```
Expected: Both grep commands return lines showing import and route mount.
  </verify>
  <done>
- knowledgeRouter imported in server/index.js
- Route mounted at /api/knowledge
- Server syntax valid
  </done>
</task>

<task type="auto">
  <name>Task 3: Integration test with dev server</name>
  <files>None (verification only)</files>
  <action>
Start the dev server and test the knowledge endpoints.

1. Start the backend server:
```bash
cd /Users/i306072/Documents/GitHub/P-E && npm run dev:server &
sleep 3
```

2. Test health endpoint (no auth needed for health, but ours requires it):
```bash
# Get auth - the dev server uses AUTH_MODE=development which auto-authenticates
curl -s http://localhost:3001/api/knowledge/health \
  -H "Content-Type: application/json" | head -c 200
```

3. Test code search endpoint:
```bash
curl -s -X POST http://localhost:3001/api/knowledge/search/code \
  -H "Content-Type: application/json" \
  -d '{"query": "authentication"}' | head -c 500
```

4. Test docs search endpoint:
```bash
curl -s -X POST http://localhost:3001/api/knowledge/search/docs \
  -H "Content-Type: application/json" \
  -d '{"query": "getting started"}' | head -c 500
```

5. Test stats endpoint:
```bash
curl -s http://localhost:3001/api/knowledge/stats | head -c 500
```

6. Test insights endpoint:
```bash
curl -s -X POST http://localhost:3001/api/knowledge/insights \
  -H "Content-Type: application/json" \
  -d '{"insight": "Test insight from integration test", "category": "testing"}' | head -c 200
```

7. Stop the server when done.

**Note:** If MCP server is unavailable, tests will return 500 errors but routes themselves are working. The key verification is that routes are reachable and return proper error responses rather than 404.
  </action>
  <verify>
All curl commands should return:
- JSON response (not HTML error page)
- Either actual data from MCP server OR error JSON like `{"error": "..."}`
- NOT 404 (would mean route not mounted)
- NOT empty response (would mean server crashed)
  </verify>
  <done>
- Health endpoint accessible at GET /api/knowledge/health
- Code search accessible at POST /api/knowledge/search/code
- Docs search accessible at POST /api/knowledge/search/docs
- Stats accessible at GET /api/knowledge/stats
- Insights accessible at POST /api/knowledge/insights
- All routes respond with JSON (success or error)
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **File existence:**
```bash
ls -la /Users/i306072/Documents/GitHub/P-E/server/routes/knowledge.js
```

2. **Syntax validation:**
```bash
node --check /Users/i306072/Documents/GitHub/P-E/server/routes/knowledge.js
node --check /Users/i306072/Documents/GitHub/P-E/server/index.js
```

3. **Route structure:**
```bash
grep -E "(router\.(get|post)|app\.use.*knowledge)" /Users/i306072/Documents/GitHub/P-E/server/routes/knowledge.js /Users/i306072/Documents/GitHub/P-E/server/index.js
```

4. **Full server start test:**
```bash
cd /Users/i306072/Documents/GitHub/P-E && timeout 5 npm run dev:server 2>&1 | head -20
```
Should show server starting without errors.
</verification>

<success_criteria>
- server/routes/knowledge.js exists with 5 endpoints
- server/index.js imports and mounts knowledgeRouter at /api/knowledge
- All endpoints protected by authMiddleware
- POST /search/code validates query parameter
- POST /search/docs validates query parameter
- POST /insights validates insight parameter
- GET /stats accepts optional repoName and statsType
- GET /health returns MCP server connectivity status
- Server starts without errors
</success_criteria>

<output>
After completion, create `.planning/phases/19-mcp-client-backend/19-02-SUMMARY.md`
</output>
