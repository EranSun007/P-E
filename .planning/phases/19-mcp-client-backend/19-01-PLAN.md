---
phase: 19-mcp-client-backend
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/services/MCPService.js
autonomous: true

must_haves:
  truths:
    - "MCPService can initialize session with MCP server"
    - "MCPService can call consult_code_base tool and return parsed results"
    - "MCPService can call consult_documentation tool and return parsed results"
    - "MCPService can call store_insight tool and return confirmation"
    - "MCPService can call get_repository_stats tool and return statistics"
    - "Session automatically re-initializes when 404 received (expired session)"
  artifacts:
    - path: "server/services/MCPService.js"
      provides: "MCP client service with session management"
      exports: ["searchCode", "searchDocs", "storeInsight", "getStats"]
      min_lines: 150
  key_links:
    - from: "MCPService._callTool"
      to: "MCP server /mcp endpoint"
      via: "fetch with JSON-RPC 2.0"
      pattern: "fetch.*baseUrl.*mcp"
    - from: "MCPService._ensureSession"
      to: "MCPService._initialize"
      via: "lazy initialization"
      pattern: "_ensureSession.*_initialize"
---

<objective>
Create MCPService.js that manages MCP protocol communication with session lifecycle and tool calling.

Purpose: Backend needs a service to communicate with the external MCP knowledge base server using JSON-RPC 2.0 protocol. This service provides semantic code search, documentation search, insight storage, and repository statistics.

Output: Singleton MCPService class with session management and tool-specific methods following existing GitHubService pattern.
</objective>

<execution_context>
@/Users/i306072/.claude/get-shit-done/workflows/execute-plan.md
@/Users/i306072/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-mcp-client-backend/19-RESEARCH.md

@server/services/GitHubService.js (pattern reference - singleton service with external API calls)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MCPService with session management</name>
  <files>server/services/MCPService.js</files>
  <action>
Create MCPService.js following the singleton pattern used by GitHubService.js.

**Constructor:**
- `this.baseUrl` from `process.env.MCP_SERVER_URL` or default `https://knowledge-base-mcp-server.cfapps.eu01-canary.hana.ondemand.com`
- `this.session = null` - stores `{ sessionId, initializedAt }`
- `this.requestId = 0` - incrementing JSON-RPC request ID

**Session Management Methods:**

`async _ensureSession()`:
- If `this.session` is null, call `_initialize()`
- Return `this.session.sessionId`

`async _initialize()`:
- POST to `${this.baseUrl}/mcp`
- Headers: `Content-Type: application/json`, `Accept: application/json, text/event-stream`
- Body (JSON-RPC 2.0):
```javascript
{
  jsonrpc: '2.0',
  id: ++this.requestId,
  method: 'initialize',
  params: {
    protocolVersion: '2025-03-26',
    capabilities: {},
    clientInfo: { name: 'pe-manager', version: '1.5.0' }
  }
}
```
- Extract `Mcp-Session-Id` from response headers
- Parse JSON response and validate no error
- Send `notifications/initialized` notification (no `id` field - it's a notification):
```javascript
{
  jsonrpc: '2.0',
  method: 'notifications/initialized'
}
```
- Store session: `this.session = { sessionId, initializedAt: Date.now() }`
- Return sessionId

`async _callTool(toolName, args, retryOnSessionExpiry = true)`:
- Call `_ensureSession()` to get sessionId
- POST to `${this.baseUrl}/mcp`
- Headers: `Content-Type: application/json`, `Accept: application/json, text/event-stream`, `Mcp-Session-Id: {sessionId}`
- Body (JSON-RPC 2.0):
```javascript
{
  jsonrpc: '2.0',
  id: ++this.requestId,
  method: 'tools/call',
  params: { name: toolName, arguments: args }
}
```
- **Session expiry handling:** If response.status === 404 and retryOnSessionExpiry is true:
  - Log: `console.log('MCP session expired, re-initializing...')`
  - Set `this.session = null`
  - Recursively call `_callTool(toolName, args, false)` (retry once only)
- If response not ok (other errors), throw Error with status
- Parse JSON response
- If `result.error`, throw Error with `result.error.message`
- Return `result.result`

`_parseToolResult(result)`:
- Extract `content` and `isError` from result
- If `isError`, find text content and throw Error
- Find text content: `content.find(c => c.type === 'text')`
- If text content exists, try to `JSON.parse(textContent.text)`
- Return parsed result or raw content if parse fails

**Export:**
- `export default new MCPService();` (singleton pattern)
  </action>
  <verify>
Manual verification:
1. File exists at server/services/MCPService.js
2. File exports singleton instance
3. Contains _initialize, _ensureSession, _callTool, _parseToolResult methods
4. No syntax errors: `node --check server/services/MCPService.js`
  </verify>
  <done>
- MCPService.js created with session management
- Constructor initializes baseUrl from env or default
- _initialize sends JSON-RPC initialize + notifications/initialized
- _ensureSession provides lazy session initialization
- _callTool handles session expiry with 404 retry
  </done>
</task>

<task type="auto">
  <name>Task 2: Add public tool methods</name>
  <files>server/services/MCPService.js</files>
  <action>
Add public methods that wrap _callTool for each MCP tool. These are the methods routes will call.

**searchCode(options)**:
- Parameters: `{ query, limit, threshold, repoName, language, artifactType, ownership }`
- Calls `_callTool('consult_code_base', { ... })` with provided args
- `query` is required; others are optional
- Returns parsed result via `_parseToolResult`

**searchDocs(options)**:
- Parameters: `{ query, limit, threshold, domain, category }`
- Calls `_callTool('consult_documentation', { ... })` with provided args
- `query` is required; others are optional
- Returns parsed result via `_parseToolResult`

**storeInsight(options)**:
- Parameters: `{ insight, category, tags, relatedFiles }`
- Calls `_callTool('store_insight', { ... })` with provided args
- `insight` is required; others are optional
- Returns parsed result via `_parseToolResult`

**getStats(options = {})**:
- Parameters: `{ repoName, statsType }`
- Calls `_callTool('get_repository_stats', { repoName, statsType: statsType || 'overall' })`
- All parameters optional, default `statsType` to 'overall'
- Returns parsed result via `_parseToolResult`

**getHealth()**:
- GET request to `${this.baseUrl}/health`
- Returns `{ healthy: true, url: this.baseUrl }` on 200
- Returns `{ healthy: false, error: response.status }` on error
- Used for connection health monitoring

**Error handling in all methods:**
- Wrap in try/catch
- On error, throw new Error with meaningful message including tool name
  </action>
  <verify>
```bash
# Verify syntax
node --check /Users/i306072/Documents/GitHub/P-E/server/services/MCPService.js

# Verify exports by quick import test
node -e "import('./server/services/MCPService.js').then(m => console.log(Object.keys(m.default).filter(k => !k.startsWith('_'))))"
```
Expected output should include: searchCode, searchDocs, storeInsight, getStats, getHealth
  </verify>
  <done>
- searchCode method wraps consult_code_base tool
- searchDocs method wraps consult_documentation tool
- storeInsight method wraps store_insight tool
- getStats method wraps get_repository_stats tool
- getHealth method checks MCP server availability
- All methods use _callTool and _parseToolResult internally
  </done>
</task>

</tasks>

<verification>
After both tasks complete:

1. **Syntax validation:**
```bash
node --check server/services/MCPService.js
```

2. **Module structure:**
```bash
node -e "import('./server/services/MCPService.js').then(m => {
  const svc = m.default;
  console.log('Methods:', Object.getOwnPropertyNames(Object.getPrototypeOf(svc)).filter(m => !m.startsWith('_') && m !== 'constructor'));
  console.log('Has baseUrl:', !!svc.baseUrl);
})"
```
Expected: Methods include searchCode, searchDocs, storeInsight, getStats, getHealth

3. **Health check (if MCP server available):**
```bash
node -e "import('./server/services/MCPService.js').then(async m => {
  const result = await m.default.getHealth();
  console.log('Health:', result);
})"
```
</verification>

<success_criteria>
- MCPService.js exists and exports singleton instance
- Contains session management (_initialize, _ensureSession, _callTool)
- Contains 5 public methods (searchCode, searchDocs, storeInsight, getStats, getHealth)
- Session expiry (404) triggers automatic re-initialization
- JSON-RPC 2.0 protocol correctly implemented
- No syntax errors
</success_criteria>

<output>
After completion, create `.planning/phases/19-mcp-client-backend/19-01-SUMMARY.md`
</output>
