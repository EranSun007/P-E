---
phase: 11-csv-upload
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - package-lock.json
  - src/api/apiClient.js
  - src/components/bugs/CSVUploadDialog.jsx
  - src/pages/BugDashboard.jsx
  - src/pages/index.jsx
autonomous: true

must_haves:
  truths:
    - "User can drag-and-drop or click to select a CSV file"
    - "User must specify week-ending date (Saturday only)"
    - "System displays clear error messages for invalid CSV format"
    - "Duplicate upload detection prompts user to replace or cancel"
    - "Upload progress bar shows percentage during upload"
    - "Success summary shows total bugs and components detected"
  artifacts:
    - path: "src/components/bugs/CSVUploadDialog.jsx"
      provides: "Complete upload dialog with dropzone, date picker, progress, errors"
      min_lines: 200
    - path: "src/api/apiClient.js"
      provides: "Bug upload API client methods"
      contains: "bugs:"
    - path: "src/pages/BugDashboard.jsx"
      provides: "Dashboard page with upload trigger"
      min_lines: 30
  key_links:
    - from: "src/components/bugs/CSVUploadDialog.jsx"
      to: "/api/bugs/upload"
      via: "XMLHttpRequest POST with FormData"
      pattern: "xhr\\.open.*POST.*bugs/upload"
    - from: "src/components/bugs/CSVUploadDialog.jsx"
      to: "/api/bugs/uploads/check"
      via: "fetch for duplicate detection"
      pattern: "bugs/uploads/check"
    - from: "src/pages/BugDashboard.jsx"
      to: "CSVUploadDialog"
      via: "import and render"
      pattern: "import.*CSVUploadDialog"
---

<objective>
Implement CSV upload UI for bug KPI dashboard with drag-and-drop file selection, Saturday-only week-ending date picker, upload progress feedback, duplicate detection confirmation, and clear error/success messaging.

Purpose: Enable users to upload weekly JIRA CSV exports as the data source for bug metrics tracking, with a polished UX that prevents common errors.

Output:
- CSVUploadDialog component with react-dropzone, progress bar, error/success states
- Bug API client methods in apiClient.js
- BugDashboard page placeholder with upload trigger button
- Navigation link in sidebar
</objective>

<execution_context>
@/Users/i306072/.claude/get-shit-done/workflows/execute-plan.md
@/Users/i306072/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-csv-upload/11-RESEARCH.md

# Backend API (complete from Phase 10)
@server/routes/bugs.js
@server/services/BugService.js

# Existing patterns
@src/api/apiClient.js
@src/components/ui/dialog.jsx
@src/components/ui/alert-dialog.jsx
@src/components/ui/progress.jsx
@src/components/ui/alert.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-dropzone and add bugs API client</name>
  <files>
    - package.json
    - package-lock.json
    - src/api/apiClient.js
  </files>
  <action>
1. Install react-dropzone:
   ```bash
   npm install react-dropzone
   ```

2. Add bugs API section to apiClient.js (after the github section, before the closing brace):
   ```javascript
   // Bug Dashboard API (v1.2)
   bugs: {
     // Check for duplicate upload before submitting
     async checkDuplicate(weekEnding) {
       return fetchWithAuth(`${API_BASE_URL}/bugs/uploads/check?weekEnding=${weekEnding}`);
     },

     // List all uploads for current user
     async listUploads() {
       return fetchWithAuth(`${API_BASE_URL}/bugs/uploads`);
     },

     // Get a single upload by ID
     async getUpload(id) {
       return fetchWithAuth(`${API_BASE_URL}/bugs/uploads/${id}`);
     },

     // Delete an upload (cascades to bugs and KPIs)
     async deleteUpload(id) {
       await fetchWithAuth(`${API_BASE_URL}/bugs/uploads/${id}`, {
         method: 'DELETE',
       });
       return true;
     },

     // Get KPIs for an upload
     async getKPIs(uploadId, component = null) {
       let url = `${API_BASE_URL}/bugs/kpis?uploadId=${uploadId}`;
       if (component) url += `&component=${encodeURIComponent(component)}`;
       return fetchWithAuth(url);
     },

     // List bugs with filtering and pagination
     async listBugs(uploadId, filters = {}) {
       const params = new URLSearchParams();
       params.append('uploadId', uploadId);
       if (filters.component) params.append('component', filters.component);
       if (filters.status) params.append('status', filters.status);
       if (filters.priority) params.append('priority', filters.priority);
       if (filters.limit) params.append('limit', filters.limit);
       if (filters.offset) params.append('offset', filters.offset);
       return fetchWithAuth(`${API_BASE_URL}/bugs/list?${params.toString()}`);
     },

     // Note: Upload uses XMLHttpRequest for progress tracking, not fetchWithAuth
     // See CSVUploadDialog for upload implementation
   },
   ```
  </action>
  <verify>
    - `npm ls react-dropzone` shows version ^14.x installed
    - `grep -n "bugs:" src/api/apiClient.js` shows the new bugs section
    - No lint errors: `npm run lint -- --quiet`
  </verify>
  <done>
    - react-dropzone ^14.x installed
    - apiClient.bugs has checkDuplicate, listUploads, getUpload, deleteUpload, getKPIs, listBugs methods
  </done>
</task>

<task type="auto">
  <name>Task 2: Create CSVUploadDialog component</name>
  <files>
    - src/components/bugs/CSVUploadDialog.jsx
  </files>
  <action>
Create `src/components/bugs/` directory and CSVUploadDialog.jsx following the pattern from 11-RESEARCH.md.

Key implementation details:
1. **Dropzone**: Use react-dropzone with:
   - Accept: `'text/csv': ['.csv'], 'application/vnd.ms-excel': ['.csv']`
   - maxFiles: 1
   - maxSize: 10MB (matches backend multer config)
   - Disabled during upload

2. **Week-ending date picker**:
   - Default to most recent Saturday using `previousSaturday()` from date-fns
   - Snap any selected date to nearest Saturday (using `isSaturday`, `previousSaturday`)
   - Use native `<input type="date">` for simplicity
   - Parse with 'T12:00:00' suffix to avoid timezone issues

3. **Upload with progress**:
   - Use XMLHttpRequest (NOT fetch) for upload progress events
   - Track progress percentage in state
   - Show Progress component during upload
   - Get auth token from AuthService for Authorization header

4. **Duplicate detection**:
   - Before upload, call `/api/bugs/uploads/check?weekEnding=`
   - If exists, show AlertDialog with:
     - Previous upload date and bug count
     - Replace or Cancel options
   - On Replace confirm, proceed with upload (backend handles upsert)

5. **Error handling**:
   - File rejections (wrong type, too large): Show Alert with clear message
   - Network errors: Show Alert
   - Backend validation errors (missing columns): Show Alert with error.message
   - Clear error on new file selection

6. **Success display**:
   - Show checkmark icon with green Alert
   - Display bugCount and components array from response
   - Change Cancel button to "Close"
   - Hide Upload button after success

7. **Reset on close**:
   - Clear all state (file, weekEnding, progress, error, result) when dialog closes

Component props:
- `open: boolean` - Control dialog visibility
- `onOpenChange: (open: boolean) => void` - Handle close
- `onUploadComplete: (result) => void` - Callback after successful upload
  </action>
  <verify>
    - File exists: `ls src/components/bugs/CSVUploadDialog.jsx`
    - Component exports: `grep -n "export default CSVUploadDialog" src/components/bugs/CSVUploadDialog.jsx`
    - Uses react-dropzone: `grep -n "useDropzone" src/components/bugs/CSVUploadDialog.jsx`
    - Uses XHR for progress: `grep -n "XMLHttpRequest" src/components/bugs/CSVUploadDialog.jsx`
    - No lint errors: `npm run lint src/components/bugs/CSVUploadDialog.jsx`
  </verify>
  <done>
    - CSVUploadDialog.jsx created with 200+ lines
    - Implements drag-and-drop via react-dropzone
    - Saturday-only date selection with snap-to-Saturday logic
    - XMLHttpRequest upload with progress tracking
    - Duplicate detection with AlertDialog confirmation
    - Clear error messages for validation failures
    - Success summary showing bug count and components
  </done>
</task>

<task type="auto">
  <name>Task 3: Create BugDashboard page and add navigation</name>
  <files>
    - src/pages/BugDashboard.jsx
    - src/pages/index.jsx
  </files>
  <action>
1. Create `src/pages/BugDashboard.jsx` as a placeholder page:
   ```jsx
   import { useState } from 'react';
   import { Button } from '@/components/ui/button';
   import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
   import { Upload, Bug } from 'lucide-react';
   import CSVUploadDialog from '@/components/bugs/CSVUploadDialog';

   const BugDashboard = () => {
     const [uploadDialogOpen, setUploadDialogOpen] = useState(false);
     const [lastUpload, setLastUpload] = useState(null);

     const handleUploadComplete = (result) => {
       setLastUpload(result);
       // Dashboard will refresh in Phase 12
     };

     return (
       <div className="space-y-6">
         <div className="flex items-center justify-between">
           <div>
             <h1 className="text-3xl font-bold tracking-tight">Bug Dashboard</h1>
             <p className="text-muted-foreground">
               Track and analyze DevOps bug metrics from weekly JIRA exports
             </p>
           </div>
           <Button onClick={() => setUploadDialogOpen(true)}>
             <Upload className="h-4 w-4 mr-2" />
             Upload CSV
           </Button>
         </div>

         {/* Placeholder card - KPI dashboard coming in Phase 12 */}
         <Card>
           <CardHeader>
             <CardTitle className="flex items-center gap-2">
               <Bug className="h-5 w-5" />
               Coming Soon: KPI Dashboard
             </CardTitle>
             <CardDescription>
               Phase 12 will add KPI cards, charts, and aging bug analysis.
               For now, you can upload JIRA CSV exports to populate the database.
             </CardDescription>
           </CardHeader>
           <CardContent>
             {lastUpload ? (
               <div className="text-sm text-muted-foreground">
                 <p>Last upload: {lastUpload.bugCount} bugs</p>
                 <p>Components: {lastUpload.components?.join(', ') || 'None detected'}</p>
               </div>
             ) : (
               <p className="text-sm text-muted-foreground">
                 No uploads yet. Click "Upload CSV" to get started.
               </p>
             )}
           </CardContent>
         </Card>

         <CSVUploadDialog
           open={uploadDialogOpen}
           onOpenChange={setUploadDialogOpen}
           onUploadComplete={handleUploadComplete}
         />
       </div>
     );
   };

   export default BugDashboard;
   ```

2. Add route to `src/pages/index.jsx`:
   - Add import: `import BugDashboard from './BugDashboard';`
   - Add route in the routes array: `{ path: 'bugs', element: <BugDashboard />, label: 'Bug Dashboard' }`
   - Position it appropriately in the routes array (after Duties or similar)

3. Add navigation link in sidebar (if not auto-generated from routes):
   - Look at how other pages are added to navigation
   - Add Bug icon from lucide-react to the nav item
  </action>
  <verify>
    - File exists: `ls src/pages/BugDashboard.jsx`
    - Route added: `grep -n "bugs" src/pages/index.jsx`
    - Dev server runs without errors: `npm run dev:client` (start and check console)
    - Navigate to `/bugs` in browser shows the page with Upload button
  </verify>
  <done>
    - BugDashboard.jsx page created with Upload CSV button
    - Route /bugs added to router configuration
    - CSVUploadDialog integrated and functional
    - Navigation accessible (sidebar or header link)
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Dependency check:**
   ```bash
   npm ls react-dropzone
   ```
   Expected: react-dropzone@14.x.x

2. **Lint check:**
   ```bash
   npm run lint -- --quiet
   ```
   Expected: No errors

3. **Manual testing (dev server):**
   - Start dev server: `npm run dev`
   - Navigate to `/bugs`
   - Click "Upload CSV" - dialog opens
   - Week-ending date defaults to most recent Saturday
   - Change date to non-Saturday - snaps to nearest Saturday
   - Drag a non-CSV file - shows "Invalid file type" error
   - Drag a CSV file - shows filename and size
   - Click Upload without file - shows error
   - Upload valid CSV - progress bar animates, success summary shows
   - Upload same week again - duplicate dialog appears
   - Click Replace - upload succeeds
   - Click Cancel - dialog closes, no upload
</verification>

<success_criteria>
- [ ] react-dropzone installed and in package.json
- [ ] apiClient.bugs section has 6 methods
- [ ] CSVUploadDialog component is 200+ lines with all features
- [ ] BugDashboard page exists at /bugs route
- [ ] Upload flow works end-to-end: file select -> date select -> upload -> success
- [ ] Invalid files show clear error messages
- [ ] Duplicate uploads trigger confirmation dialog
- [ ] Upload progress bar shows percentage during upload
- [ ] Success summary displays bug count and components
</success_criteria>

<output>
After completion, create `.planning/phases/11-csv-upload/11-01-SUMMARY.md`
</output>
