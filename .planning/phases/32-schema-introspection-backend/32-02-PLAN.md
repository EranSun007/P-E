---
phase: 32-schema-introspection-backend
plan: 02
type: execute
wave: 2
depends_on: ["32-01"]
files_modified:
  - server/routes/schema.js
  - server/index.js
autonomous: true

must_haves:
  truths:
    - "GET /api/schema/tables returns all tables with nested metadata"
    - "Each table in response includes columns, indexes, constraints, foreignKeys"
    - "System tables are excluded from response"
    - "GET /api/schema/tables/:schema/:table returns specific table details"
    - "Invalid table returns 404 error"
  artifacts:
    - path: "server/routes/schema.js"
      provides: "REST API routes for schema introspection"
      exports: ["router"]
    - path: "server/index.js"
      provides: "Schema route mounting"
      contains: "/api/schema"
  key_links:
    - from: "server/routes/schema.js"
      to: "server/services/SchemaService.js"
      via: "service import"
      pattern: "import SchemaService from.*SchemaService"
    - from: "server/index.js"
      to: "server/routes/schema.js"
      via: "router mounting"
      pattern: "app.use.*api/schema.*schemaRouter"
---

<objective>
Create REST API routes exposing schema introspection to frontend.

Purpose: Enable Entity Model Viewer to fetch database schema via HTTP.
Output: /api/schema/tables endpoint returning complete schema metadata.
</objective>

<execution_context>
@/Users/i306072/.claude/get-shit-done/workflows/execute-plan.md
@/Users/i306072/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-schema-introspection-backend/32-RESEARCH.md
@.planning/phases/32-schema-introspection-backend/32-01-SUMMARY.md
@server/routes/menuConfig.js
@server/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create schema routes file</name>
  <files>server/routes/schema.js</files>
  <action>
Create server/routes/schema.js following existing route patterns (menuConfig.js, tasks.js).

1. **Import dependencies:**
   ```javascript
   import express from 'express';
   import SchemaService from '../services/SchemaService.js';
   ```

2. **Create router:**
   ```javascript
   const router = express.Router();
   ```

3. **GET /api/schema/tables - Get complete schema:**
   - No authentication required (schema metadata is not user-specific)
   - Call SchemaService.getCompleteSchema()
   - Return JSON response with tables array
   - Handle errors with 500 status and error message

4. **GET /api/schema/tables/:schema/:table - Get specific table:**
   - Extract schema and table from params
   - Call SchemaService methods to get table-specific data
   - Filter results to match requested table
   - Return 404 if table not found (no columns returned)
   - Return JSON with table schema, name, columns, foreignKeys, indexes, constraints

5. **Export router:**
   ```javascript
   export default router;
   ```

Note: Schema introspection does NOT require auth middleware because:
- Schema metadata is global (not user-specific)
- It's read-only (no data modification)
- Frontend Entity Model Viewer needs to fetch schema on page load
  </action>
  <verify>
File exists and exports Express router.
Check syntax: `node --check server/routes/schema.js`
  </verify>
  <done>
server/routes/schema.js exists with GET /tables and GET /tables/:schema/:table routes.
  </done>
</task>

<task type="auto">
  <name>Task 2: Mount schema routes in server/index.js</name>
  <files>server/index.js</files>
  <action>
Add schema routes to server/index.js:

1. **Add import at top with other route imports:**
   ```javascript
   import schemaRouter from './routes/schema.js';
   ```

2. **Mount router with other API routes:**
   ```javascript
   app.use('/api/schema', schemaRouter);
   ```
   Add after existing route mountings (e.g., after menuConfigRouter).

3. **Verify import is in correct location** (with other router imports around lines 8-42)
4. **Verify mount is in correct location** (with other app.use statements around lines 121-155)
  </action>
  <verify>
Start server and test endpoints:
```bash
npm run dev:server &
sleep 3
curl -s http://localhost:3001/api/schema/tables | head -c 500
curl -s http://localhost:3001/api/schema/tables/public/tasks | head -c 500
```
Verify: Both endpoints return JSON with table data.
  </verify>
  <done>
Schema routes mounted at /api/schema. GET /api/schema/tables returns all tables. GET /api/schema/tables/public/tasks returns specific table.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify endpoint functionality</name>
  <files>server/routes/schema.js</files>
  <action>
Test the complete flow:

1. **Test GET /api/schema/tables:**
   - Should return { tables: [...] } with all database tables
   - Each table should have schema, name, type, columns, indexes, constraints, foreignKeys
   - Should NOT include system tables (pg_catalog, information_schema)
   - Should NOT include 'migrations' table (it's in public schema but could be excluded via table name if desired - actually keep it, it's user data)

2. **Test GET /api/schema/tables/public/tasks:**
   - Should return single table with all metadata
   - Verify columns array is populated
   - Verify foreignKeys shows relationships

3. **Test 404 response:**
   - GET /api/schema/tables/public/nonexistent should return 404

4. **Check response format matches frontend needs:**
   - camelCase keys (columnName, not column_name)
   - Arrays for columns, indexes, constraints, foreignKeys
  </action>
  <verify>
```bash
# Test complete schema
curl -s http://localhost:3001/api/schema/tables | jq '.tables | length'

# Test specific table
curl -s http://localhost:3001/api/schema/tables/public/tasks | jq '.columns | length'

# Test 404
curl -s -o /dev/null -w "%{http_code}" http://localhost:3001/api/schema/tables/public/nonexistent
```
Expected: Tables count > 0, columns count > 0, 404 status code.
  </verify>
  <done>
All three endpoints work correctly: /api/schema/tables returns complete schema, /api/schema/tables/:schema/:table returns specific table, invalid table returns 404.
  </done>
</task>

</tasks>

<verification>
1. server/routes/schema.js exists with correct imports and routes
2. server/index.js imports and mounts schemaRouter at /api/schema
3. GET /api/schema/tables returns JSON with tables array
4. Each table includes columns, indexes, constraints, foreignKeys arrays
5. GET /api/schema/tables/public/tasks returns specific table data
6. GET /api/schema/tables/public/nonexistent returns 404
7. No system tables (pg_*, information_schema) in response
</verification>

<success_criteria>
- /api/schema/tables endpoint accessible without authentication
- Response includes all user tables with nested metadata
- Specific table endpoint works with :schema/:table params
- Invalid table returns 404 (not 500)
- Response structure ready for frontend consumption
</success_criteria>

<output>
After completion, create `.planning/phases/32-schema-introspection-backend/32-02-SUMMARY.md`
</output>
