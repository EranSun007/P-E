---
phase: 16-email-notifications
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - src/components/settings/EmailPreferences.jsx
  - src/pages/Settings.jsx
  - src/api/apiClient.js
autonomous: false

must_haves:
  truths:
    - "User can view email preferences for all KPIs in Settings"
    - "User can enable/disable email notifications per KPI"
    - "User can set email address for notifications"
    - "Changes persist after page refresh"
  artifacts:
    - path: "src/components/settings/EmailPreferences.jsx"
      provides: "Email preferences configuration UI"
      min_lines: 80
    - path: "src/api/apiClient.js"
      provides: "EmailPreferences API client methods"
      contains: "EmailPreferences"
  key_links:
    - from: "src/components/settings/EmailPreferences.jsx"
      to: "/api/email-preferences"
      via: "Fetch calls to API client"
      pattern: "EmailPreferences\\.(list|update)"
    - from: "src/pages/Settings.jsx"
      to: "src/components/settings/EmailPreferences.jsx"
      via: "Component import and tab rendering"
      pattern: "import.*EmailPreferences"
---

<objective>
Create EmailPreferences component for Settings page that allows users to configure email notifications per KPI with toggle switches and email input.

Purpose: Give users control over which KPI alerts they receive via email and where those alerts are sent.
Output: Working UI for email notification preferences integrated into Settings page.
</objective>

<execution_context>
@/Users/i306072/.claude/get-shit-done/workflows/execute-plan.md
@/Users/i306072/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-email-notifications/16-01-SUMMARY.md
@src/pages/Settings.jsx
@src/api/apiClient.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add EmailPreferences API client and create component</name>
  <files>
    src/api/apiClient.js
    src/components/settings/EmailPreferences.jsx
  </files>
  <action>
    1. Add EmailPreferences to src/api/apiClient.js:
       ```javascript
       export const EmailPreferences = {
         list: () => fetchAPI('/email-preferences'),
         get: (kpiKey) => fetchAPI(`/email-preferences/${kpiKey}`),
         update: (kpiKey, data) => fetchAPI(`/email-preferences/${kpiKey}`, {
           method: 'PUT',
           body: JSON.stringify(data)
         }),
         delete: (kpiKey) => fetchAPI(`/email-preferences/${kpiKey}`, {
           method: 'DELETE'
         })
       };
       ```

    2. Create src/components/settings/EmailPreferences.jsx:
       - Import React hooks (useState, useEffect)
       - Import UI components: Card, CardContent, CardDescription, CardHeader, CardTitle, Switch, Input, Label, Button, Alert
       - Import EmailPreferences from api/apiClient
       - Import Bell, Mail, Loader2, CheckCircle, AlertCircle icons from lucide-react

       Define KPI_CONFIG array (matches ThresholdService):
       ```javascript
       const KPI_CONFIG = [
         { key: 'bug_inflow_rate', label: 'Bug Inflow Rate', description: 'Weekly bug creation rate' },
         { key: 'median_ttfr_hours', label: 'Time to First Response', description: 'Median hours to first response' },
         { key: 'sla_vh_percent', label: 'SLA Compliance (VH)', description: 'Very High priority SLA compliance' },
         { key: 'sla_high_percent', label: 'SLA Compliance (High)', description: 'High priority SLA compliance' },
         { key: 'backlog_health_score', label: 'Backlog Health Score', description: 'Overall backlog health metric' },
       ];
       ```

       Component state:
       - preferences: object keyed by kpi_key, values { enabled, email }
       - loading: boolean
       - saving: string | null (kpi_key being saved)
       - error: string | null
       - globalEmail: string (shared email for all KPIs)

       On mount (useEffect):
       - Fetch EmailPreferences.list()
       - Build preferences object from response
       - Extract globalEmail from first preference with email set

       handleToggle(kpiKey, enabled):
       - Set saving state to kpiKey
       - Call EmailPreferences.update(kpiKey, { enabled, email: globalEmail })
       - Update local preferences state on success
       - Clear saving state

       handleEmailChange(email):
       - Update globalEmail state
       - (Don't save immediately - use blur or explicit save)

       handleEmailSave():
       - For each enabled preference, update with new email
       - Show success message

       Render:
       - Card with header: "Email Notifications" + Bell icon
       - Description: "Receive email alerts when KPIs cross into red zone"

       - Global email input section:
         - Label: "Notification Email"
         - Input with placeholder "you@example.com"
         - Save button (only enabled if email changed)
         - Helper text: "All KPI alerts will be sent to this email"

       - Divider

       - KPI list (map over KPI_CONFIG):
         - For each KPI: row with label, description, and Switch
         - Switch checked state from preferences[kpi.key]?.enabled
         - Switch disabled while saving that KPI
         - Show loader spinner when saving

       - Error alert if error state set
  </action>
  <verify>
    - File exists: src/components/settings/EmailPreferences.jsx
    - File contains KPI_CONFIG array with 5 KPIs
    - EmailPreferences export added to apiClient.js
    - Component exports default function EmailPreferences
  </verify>
  <done>
    EmailPreferences component created with KPI toggle list and global email input. API client methods added.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate EmailPreferences into Settings page</name>
  <files>
    src/pages/Settings.jsx
  </files>
  <action>
    1. Import EmailPreferences component:
       ```javascript
       import EmailPreferences from "@/components/settings/EmailPreferences";
       ```

    2. Import Bell icon from lucide-react (add to existing import)

    3. Add "notifications" tab to tabConfigs array (before "data" tab):
       ```javascript
       { id: "notifications", label: "Notifications", icon: Bell },
       ```

    4. Add TabsContent for notifications tab in the render section.
       Find the pattern where other tabs are rendered conditionally.
       Add case for notifications:
       ```jsx
       tab.id === 'notifications' ? (
         <EmailPreferences />
       ) : tab.id === 'data' ? (
         // existing data tab content
       )
       ```

    5. Ensure the tab appears in logical order:
       Current: priorities, taskTypes, statuses, tags, account, [users], github, data
       New: priorities, taskTypes, statuses, tags, account, [users], github, notifications, data

       Move notifications before data in tabConfigs array.
  </action>
  <verify>
    - npm run dev:client starts without errors
    - Navigate to Settings page
    - "Notifications" tab visible in tab bar
    - Clicking "Notifications" shows EmailPreferences component
    - Component displays 5 KPI toggles
  </verify>
  <done>
    Settings page updated with Notifications tab displaying EmailPreferences component.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Email notification preferences UI integrated into Settings page:
    1. New "Notifications" tab in Settings
    2. Global email input for all KPI alerts
    3. Per-KPI toggle switches for 5 KPIs
    4. Preferences persist to backend via API
  </what-built>
  <how-to-verify>
    1. Start the app: `npm run dev`
    2. Navigate to Settings page (gear icon in sidebar)
    3. Click "Notifications" tab
    4. Verify you see:
       - Email input field at top
       - 5 KPI toggles (Bug Inflow Rate, Time to First Response, SLA VH, SLA High, Backlog Health)
    5. Enter an email address and click Save
    6. Toggle on "Bug Inflow Rate"
    7. Refresh the page
    8. Verify:
       - Email address persisted
       - Bug Inflow Rate toggle still on
       - Other toggles still off
    9. (Optional) Upload a CSV with red zone KPI to test email trigger
  </how-to-verify>
  <resume-signal>Type "approved" if preferences UI works correctly, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. Start full stack: `npm run dev`
2. Navigate to Settings > Notifications tab
3. Enter email address and save
4. Enable at least one KPI toggle
5. Refresh page - settings should persist
6. Check browser console for any errors
7. Check API calls in Network tab - should see /api/email-preferences requests
</verification>

<success_criteria>
- Notifications tab visible in Settings page
- EmailPreferences component renders 5 KPI toggles
- Global email input saves successfully
- Per-KPI toggles update preferences via API
- Preferences persist across page refresh
- No console errors in browser
- Human verification confirms UI works as expected
</success_criteria>

<output>
After completion, create `.planning/phases/16-email-notifications/16-02-SUMMARY.md`
</output>
