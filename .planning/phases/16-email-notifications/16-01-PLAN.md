---
phase: 16-email-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/services/EmailService.js
  - server/db/021_email_notifications.sql
  - server/db/migrate.js
  - server/services/ThresholdService.js
  - server/routes/emailPreferences.js
  - server/index.js
autonomous: true
user_setup:
  - service: smtp
    why: "Email delivery requires SMTP server credentials"
    env_vars:
      - name: SMTP_HOST
        source: "Your email provider (e.g., smtp.gmail.com, smtp.ethereal.email for testing)"
      - name: SMTP_PORT
        source: "Usually 587 (TLS) or 465 (SSL)"
      - name: SMTP_USER
        source: "SMTP username/email"
      - name: SMTP_PASS
        source: "SMTP password or app-specific password"
      - name: SMTP_FROM
        source: "Sender email address (e.g., noreply@yourapp.com)"
    dashboard_config:
      - task: "For Gmail: Enable 2FA and create App Password"
        location: "Google Account > Security > App passwords"

must_haves:
  truths:
    - "Email is sent when KPI hits red zone during CSV upload"
    - "Email delivery retries up to 3 times on transient failure"
    - "Failed email deliveries are logged to email_queue table"
    - "User preferences can be read/written via API"
  artifacts:
    - path: "server/services/EmailService.js"
      provides: "Email orchestration with nodemailer and p-retry"
      exports: ["sendKPIAlert"]
    - path: "server/db/021_email_notifications.sql"
      provides: "email_queue table for failure logging"
      contains: "CREATE TABLE IF NOT EXISTS email_queue"
    - path: "server/routes/emailPreferences.js"
      provides: "REST API for email preferences CRUD"
      exports: ["router"]
  key_links:
    - from: "server/services/ThresholdService.js"
      to: "server/services/EmailService.js"
      via: "Fire-and-forget call in createNotificationIfNotDuplicate"
      pattern: "EmailService\\.sendKPIAlert.*\\.catch"
    - from: "server/services/EmailService.js"
      to: "UserSettingsService"
      via: "Check email preference before sending"
      pattern: "UserSettingsService\\.(get|listForUser)"
---

<objective>
Create EmailService with nodemailer SMTP delivery, p-retry for resilience, and integrate with ThresholdService to send email alerts when KPIs breach red zone. Add REST API for email preferences management.

Purpose: Enable proactive email notifications so users learn about critical KPI breaches even when not actively using the app.
Output: Backend infrastructure for email delivery with retry logic and preference storage.
</objective>

<execution_context>
@/Users/i306072/.claude/get-shit-done/workflows/execute-plan.md
@/Users/i306072/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-email-notifications/16-RESEARCH.md
@server/services/ThresholdService.js
@server/services/UserSettingsService.js
@server/routes/userSettings.js
@server/db/020_notification_types.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create EmailService with retry</name>
  <files>
    package.json
    server/services/EmailService.js
    server/db/021_email_notifications.sql
    server/db/migrate.js
  </files>
  <action>
    1. Install dependencies:
       ```bash
       npm install nodemailer p-retry
       ```

    2. Create server/db/021_email_notifications.sql migration:
       - email_queue table with columns: id (UUID), user_id, recipient_email, subject, template_type, template_data (JSONB), status (pending/sent/failed), attempts, last_error, created_date, sent_date, updated_date
       - Indexes on user_id, status, created_date
       - updated_date trigger using existing update_updated_date_column function

    3. Add migration to server/db/migrate.js MIGRATIONS array:
       ```javascript
       {
         version: '021_email_notifications',
         name: 'Email notification queue for failure logging',
         file: '021_email_notifications.sql'
       }
       ```

    4. Create server/services/EmailService.js:
       - Import nodemailer and pRetry from p-retry
       - Create transporter using environment variables (SMTP_HOST, SMTP_PORT, SMTP_USER, SMTP_PASS, SMTP_FROM)
       - Implement logEmailAttempt(userId, email, subject, templateType, templateData, status, attempts, error) to insert/update email_queue
       - Implement sendWithRetry(mailOptions) using pRetry with:
         - retries: 3
         - minTimeout: 1000 (1 second)
         - factor: 2 (exponential backoff: 1s, 2s, 4s)
         - onFailedAttempt: log attempt number and retries left
         - AbortError for permanent failures (responseCode 550, 553, EAUTH)
       - Implement buildKPIAlertEmail(kpiKey, value, threshold, weekEnding, dashboardUrl) returning { subject, text, html }
         - Use KPI_LABELS from ThresholdService for display names
         - HTML template with alert styling (red zone indicator, KPI value, threshold, dashboard link button)
         - Plain text fallback
       - Implement sendKPIAlert(userId, kpiKey, value, weekEnding) that:
         - Gets user email preference from UserSettingsService (key: email_pref_{kpiKey})
         - Returns early if preference disabled or no email configured
         - Builds email using buildKPIAlertEmail
         - Calls sendWithRetry
         - Logs success/failure to email_queue
       - Export class instance

    Configuration fallbacks:
    - SMTP_HOST: default 'smtp.ethereal.email' for dev testing
    - SMTP_PORT: default '587'
    - SMTP_SECURE: 'false' for port 587, 'true' for 465
    - DASHBOARD_URL: process.env.FRONTEND_URL || 'http://localhost:5173'
  </action>
  <verify>
    - npm install completes without error
    - npm run migrate runs without error
    - File server/services/EmailService.js exists with sendKPIAlert export
    - File server/db/021_email_notifications.sql exists
  </verify>
  <done>
    EmailService created with nodemailer transport, p-retry wrapper, KPI alert template, and email_queue logging. Migration adds email_queue table.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate EmailService with ThresholdService and create preferences API</name>
  <files>
    server/services/ThresholdService.js
    server/routes/emailPreferences.js
    server/index.js
  </files>
  <action>
    1. Modify server/services/ThresholdService.js:
       - Import EmailService at top
       - In createNotificationIfNotDuplicate, after successfully creating notification (line ~133), add fire-and-forget email trigger:
         ```javascript
         // Fire-and-forget email - don't await, don't block
         EmailService.sendKPIAlert(userId, kpiKey, value, weekEnding)
           .catch(err => console.error('ThresholdService: Email failed for', kpiKey, err.message));
         ```
       - Pass weekEnding from metadata to sendKPIAlert

    2. Create server/routes/emailPreferences.js:
       - Import express, UserSettingsService, authMiddleware
       - Apply authMiddleware to all routes

       GET /api/email-preferences
       - List all email preferences for current user
       - Filter settings where key starts with 'email_pref_'
       - Parse JSON values and return array of { kpi_key, enabled, email }

       GET /api/email-preferences/:kpiKey
       - Get single preference by KPI key
       - Return { kpi_key, enabled, email } or default { enabled: false }

       PUT /api/email-preferences/:kpiKey
       - Accept { enabled, email } in body
       - Validate email format if enabled is true and email provided
       - Store JSON { enabled, email } to UserSettingsService
       - Return { success: true }

       DELETE /api/email-preferences/:kpiKey
       - Delete preference for KPI
       - Return 204 No Content

    3. Mount route in server/index.js:
       - Import emailPreferencesRouter
       - Add app.use('/api/email-preferences', emailPreferencesRouter)
       - Place near other API routes

    KPI keys to support (from ThresholdService):
    - bug_inflow_rate
    - median_ttfr_hours
    - sla_vh_percent
    - sla_high_percent
    - backlog_health_score
  </action>
  <verify>
    - Server starts without error: npm run dev:server
    - curl http://localhost:3001/api/email-preferences returns [] (empty array initially)
    - curl -X PUT http://localhost:3001/api/email-preferences/bug_inflow_rate -H "Content-Type: application/json" -d '{"enabled":true,"email":"test@example.com"}' returns success
    - curl http://localhost:3001/api/email-preferences returns preference array with bug_inflow_rate entry
  </verify>
  <done>
    ThresholdService triggers email on red zone breach. Email preferences API operational with GET/PUT/DELETE endpoints.
  </done>
</task>

</tasks>

<verification>
1. Run migration: `npm run migrate` - should complete without error
2. Start server: `npm run dev:server` - should start on port 3001
3. Test preferences API:
   ```bash
   # Get all preferences (empty initially)
   curl http://localhost:3001/api/email-preferences

   # Set a preference
   curl -X PUT http://localhost:3001/api/email-preferences/bug_inflow_rate \
     -H "Content-Type: application/json" \
     -d '{"enabled":true,"email":"test@example.com"}'

   # Verify preference saved
   curl http://localhost:3001/api/email-preferences/bug_inflow_rate
   ```
4. Check email_queue table exists: `SELECT * FROM email_queue LIMIT 1;` (should return empty, not error)
</verification>

<success_criteria>
- nodemailer and p-retry installed in package.json
- email_queue table created by migration
- EmailService.sendKPIAlert function exists and checks user preferences
- ThresholdService calls EmailService after creating in-app notification
- /api/email-preferences endpoints functional
- Server starts without errors
</success_criteria>

<output>
After completion, create `.planning/phases/16-email-notifications/16-01-SUMMARY.md`
</output>
