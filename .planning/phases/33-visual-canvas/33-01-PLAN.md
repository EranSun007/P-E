---
phase: 33-visual-canvas
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/pages/EntityModel.jsx
  - src/pages/index.jsx
  - src/components/schema/EntityNode.jsx
  - src/components/schema/schemaTransform.js
autonomous: true

must_haves:
  truths:
    - "Entity Model page is accessible from sidebar navigation in Product mode"
    - "Page loads schema data from API and displays loading state"
    - "Each database table displays as a visual node with table name header"
    - "Node shows field list with column names and data types"
    - "Primary key columns are visually distinguished"
  artifacts:
    - path: "src/pages/EntityModel.jsx"
      provides: "Main page with ReactFlow canvas"
      min_lines: 80
    - path: "src/components/schema/EntityNode.jsx"
      provides: "Custom node component for table display"
      exports: ["default"]
    - path: "src/components/schema/schemaTransform.js"
      provides: "API to ReactFlow data transformation"
      exports: ["transformSchemaToGraph"]
  key_links:
    - from: "src/pages/EntityModel.jsx"
      to: "/api/schema/tables"
      via: "fetch in useEffect"
      pattern: "fetch.*api/schema/tables"
    - from: "src/pages/EntityModel.jsx"
      to: "EntityNode"
      via: "nodeTypes object"
      pattern: "nodeTypes.*entity.*EntityNode"
---

<objective>
Create Entity Model page with @xyflow/react canvas displaying database tables as interactive nodes.

Purpose: Foundation for v1.8 Entity Model Viewer - user can visually see database schema as a node graph
Output: EntityModel.jsx page with custom EntityNode component, schema data transformation, and basic ReactFlow canvas
</objective>

<execution_context>
@/Users/i306072/.claude/get-shit-done/workflows/execute-plan.md
@/Users/i306072/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-visual-canvas/33-RESEARCH.md

Prior work:
@.planning/phases/32-schema-introspection-backend/32-02-SUMMARY.md (Schema API at /api/schema/tables)

Codebase patterns:
@src/pages/index.jsx (lazy loading and routing pattern)
@src/pages/Layout.jsx (navigation arrays - peopleNavigation and productNavigation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @xyflow/react and create schema transform utility</name>
  <files>
    - package.json
    - src/components/schema/schemaTransform.js
  </files>
  <action>
    1. Install @xyflow/react:
       npm install @xyflow/react

    2. Create src/components/schema/ directory

    3. Create schemaTransform.js with transformSchemaToGraph function:
       - Input: tables array from /api/schema/tables API
       - Output: { nodes, edges } object for ReactFlow
       - Node structure:
         - id: table.tableName
         - type: 'entity' (custom node type)
         - data: { tableName, columns, foreignKeys, constraints }
         - position: { x: index * 280, y: (index % 4) * 200 } (grid layout)
       - Edge structure (from foreignKeys):
         - id: `${tableName}-${fk.constraintName}`
         - source: tableName (table with FK)
         - target: fk.referencedTable
         - type: 'smoothstep'
         - label: fk.columns.join(', ')
       - Helper function: enrichColumnsWithConstraints(columns, constraints)
         - Mark isPrimaryKey based on constraints.primaryKey.columns
         - Keep existing isNullable and dataType
  </action>
  <verify>
    - npm list @xyflow/react shows installed version
    - File exists: src/components/schema/schemaTransform.js
    - Function exports: transformSchemaToGraph
  </verify>
  <done>
    @xyflow/react installed, schemaTransform.js creates nodes/edges from API response
  </done>
</task>

<task type="auto">
  <name>Task 2: Create EntityNode custom component</name>
  <files>
    - src/components/schema/EntityNode.jsx
  </files>
  <action>
    Create EntityNode.jsx - a memoized React component for displaying a database table:

    1. Import Handle, Position from @xyflow/react
    2. Import memo from react
    3. Use Tailwind classes matching project style

    Component structure:
    - Wrapper div: bg-white border-2 border-gray-300 rounded-lg shadow-md min-w-[200px]
    - Header div: bg-blue-600 text-white px-3 py-2 font-semibold rounded-t-md
      - Display data.tableName
    - Body div: p-2 max-h-[250px] overflow-y-auto
      - Map over data.columns
      - Each column row: flex items-center text-sm py-1 px-2 hover:bg-gray-50
        - Column name (bold if isPrimaryKey, add key icon if PK)
        - Data type on right side (text-gray-500 text-xs ml-auto)
    - Handles:
      - Left handle: Handle type="target" position={Position.Left}
      - Right handle: Handle type="source" position={Position.Right}

    Wrap entire component in memo() for performance.

    Import lucide-react Key icon for primary key indicator.
  </action>
  <verify>
    - File exists: src/components/schema/EntityNode.jsx
    - Component is wrapped in memo()
    - Has Handle components for connections
  </verify>
  <done>
    EntityNode displays table name, columns with types, and PK indicators
  </done>
</task>

<task type="auto">
  <name>Task 3: Create EntityModel page with routing and navigation</name>
  <files>
    - src/pages/EntityModel.jsx
    - src/pages/index.jsx
    - src/pages/Layout.jsx
  </files>
  <action>
    1. Create EntityModel.jsx:

    Imports:
    - useState, useEffect from react
    - ReactFlow, Controls, Background, useNodesState, useEdgesState from @xyflow/react
    - '@xyflow/react/dist/style.css' (CRITICAL - required for styling)
    - EntityNode from @/components/schema/EntityNode
    - transformSchemaToGraph from @/components/schema/schemaTransform
    - LoadingSpinner from @/components/ui/LoadingSpinner

    Component structure:
    - State: loading (true), error (null)
    - useNodesState([]) for nodes
    - useEdgesState([]) for edges
    - nodeTypes = { entity: EntityNode }

    useEffect on mount:
    - fetch('/api/schema/tables')
    - Transform response with transformSchemaToGraph
    - setNodes, setEdges
    - Handle errors with setError
    - finally setLoading(false)

    Render:
    - Loading state: center spinner
    - Error state: error message with retry button
    - Main: div with explicit height (h-[calc(100vh-120px)])
      - ReactFlow with nodes, edges, nodeTypes, onNodesChange, onEdgesChange
      - Props: fitView, minZoom={0.3}, maxZoom={2}
      - Children: Controls, Background (variant="dots")

    2. Update src/pages/index.jsx:

    Add lazy import:
    const EntityModel = lazy(() => retryImport(() => import(/* webpackChunkName: "pages-entity-model" */ "./EntityModel"), 3, 1000));

    Add to PAGES object:
    EntityModel: EntityModel,

    Add route (in Product Mode Pages section):
    <Route path="/entitymodel" element={<EntityModel />} />

    3. Update src/pages/Layout.jsx:

    Add Database icon to imports from lucide-react

    Add to productNavigation array (after "Releases"):
    {
      name: "Entity Model",
      icon: Database,
      href: createPageUrl("EntityModel"),
      current: currentPageName === "EntityModel"
    }
  </action>
  <verify>
    - npm run dev starts without errors
    - Navigate to /entitymodel shows loading then graph
    - Entity Model appears in Product mode sidebar
    - curl http://localhost:3001/api/schema/tables returns data
  </verify>
  <done>
    EntityModel page loads schema, displays nodes, accessible via Product navigation
  </done>
</task>

</tasks>

<verification>
1. npm run dev - builds without errors
2. Switch to Product mode, Entity Model appears in sidebar
3. Click Entity Model - page loads, shows loading spinner briefly
4. After load: nodes visible for all database tables
5. Each node shows table name in blue header
6. Each node shows columns with data types
7. Primary key columns show key icon
8. ReactFlow controls (zoom +/-) visible in corner
</verification>

<success_criteria>
- Entity Model page accessible from Product mode sidebar navigation
- Page fetches schema from /api/schema/tables on mount
- All 36 tables display as EntityNode components
- Each node shows table name, columns with types
- Primary keys visually distinguished
- Pan and zoom work via ReactFlow Controls
- No console errors
</success_criteria>

<output>
After completion, create `.planning/phases/33-visual-canvas/33-01-SUMMARY.md`
</output>
