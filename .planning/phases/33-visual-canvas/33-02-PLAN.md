---
phase: 33-visual-canvas
plan: 02
type: execute
wave: 2
depends_on: [33-01]
files_modified:
  - src/pages/EntityModel.jsx
  - src/components/schema/EntityDetailsPanel.jsx
autonomous: true

must_haves:
  truths:
    - "Foreign key relationships display as connecting edges between nodes"
    - "Edge labels show the FK column names"
    - "User can click a node to see full details in side panel"
    - "Details panel shows all columns, types, constraints, indexes"
    - "User can close the details panel"
  artifacts:
    - path: "src/components/schema/EntityDetailsPanel.jsx"
      provides: "Click-to-view details sidebar"
      min_lines: 60
  key_links:
    - from: "src/pages/EntityModel.jsx"
      to: "EntityDetailsPanel"
      via: "selectedNode state and conditional render"
      pattern: "selectedNode.*EntityDetailsPanel"
    - from: "src/pages/EntityModel.jsx"
      to: "onNodeClick handler"
      via: "ReactFlow prop"
      pattern: "onNodeClick.*setSelectedNode"
---

<objective>
Add relationship edges visualization and click-to-view details panel to Entity Model page.

Purpose: Complete v1.8 Entity Model Viewer - user can see relationships between tables and inspect table details
Output: Visible FK edges connecting related tables, EntityDetailsPanel showing full schema details on node click
</objective>

<execution_context>
@/Users/i306072/.claude/get-shit-done/workflows/execute-plan.md
@/Users/i306072/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/33-visual-canvas/33-RESEARCH.md
@.planning/phases/33-visual-canvas/33-01-SUMMARY.md (EntityModel page with basic canvas)

Codebase patterns:
@src/components/ui/card.jsx (Card, CardHeader, CardContent pattern)
@src/components/ui/scroll-area.jsx (ScrollArea for long lists)
@src/components/ui/badge.jsx (Badge for type indicators)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EntityDetailsPanel component</name>
  <files>
    - src/components/schema/EntityDetailsPanel.jsx
  </files>
  <action>
    Create EntityDetailsPanel.jsx - sidebar showing full table details when a node is clicked:

    Props:
    - node: the selected node object (node.data contains table info)
    - onClose: callback to close panel

    Import:
    - Card, CardHeader, CardTitle, CardContent from @/components/ui/card
    - ScrollArea from @/components/ui/scroll-area
    - Badge from @/components/ui/badge
    - X, Key, Link2, Database, List from lucide-react

    Component structure:
    - Fixed width sidebar: w-96 bg-white border-l shadow-lg h-full overflow-hidden flex flex-col
    - Header section:
      - Flex with title and close button (X icon)
      - Table name as title with Database icon
      - Badge showing column count
    - ScrollArea for content (flex-1)
    - Content sections using Cards:

      Section 1: Columns
      - Card with "Columns" header
      - Table/list of all columns:
        - Column name (bold if PK, show Key icon)
        - Data type badge
        - "nullable" indicator if isNullable
        - Default value if exists

      Section 2: Primary Key
      - Show if constraints.primaryKey exists
      - List PK columns

      Section 3: Foreign Keys
      - Card if foreignKeys array has items
      - For each FK:
        - Constraint name
        - Columns -> referencedTable.referencedColumns
        - Show with Link2 icon

      Section 4: Indexes
      - Card if indexes array has items
      - For each index:
        - Index name
        - Columns (joined)
        - isUnique badge if unique

      Section 5: Check Constraints
      - Show if constraints.check array has items
      - List constraint names and definitions

    Use Tailwind for spacing: space-y-4 for card separation
    Each section only renders if data exists (conditional rendering)
  </action>
  <verify>
    - File exists: src/components/schema/EntityDetailsPanel.jsx
    - Component accepts node and onClose props
    - Renders all 5 sections when data present
  </verify>
  <done>
    EntityDetailsPanel shows complete table schema with columns, PKs, FKs, indexes, constraints
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate details panel and enhance edge styling</name>
  <files>
    - src/pages/EntityModel.jsx
  </files>
  <action>
    Update EntityModel.jsx to add click-to-view details and improve edge visualization:

    1. Add imports:
       - EntityDetailsPanel from @/components/schema/EntityDetailsPanel

    2. Add state:
       - const [selectedNode, setSelectedNode] = useState(null);

    3. Add node click handler:
       const handleNodeClick = useCallback((event, node) => {
         setSelectedNode(node);
       }, []);

    4. Add close handler:
       const handleClosePanel = useCallback(() => {
         setSelectedNode(null);
       }, []);

    5. Update ReactFlow props:
       - Add: onNodeClick={handleNodeClick}

    6. Modify edge defaults in schemaTransform.js for better visibility:
       - style: { strokeWidth: 2, stroke: '#64748b' }
       - markerEnd: { type: MarkerType.ArrowClosed, color: '#64748b' }
       - labelStyle: { fontSize: 10, fill: '#64748b' }
       - labelBgStyle: { fill: '#f8fafc', fillOpacity: 0.9 }

       Import MarkerType from @xyflow/react in schemaTransform.js

    7. Update layout structure:
       - Wrap ReactFlow and panel in flex container
       - ReactFlow div: flex-1 (takes remaining space)
       - Conditional panel: {selectedNode && <EntityDetailsPanel ... />}

    Layout:
    <div className="h-[calc(100vh-120px)] flex">
      <div className="flex-1 relative">
        <ReactFlow ...>
          <Controls />
          <Background />
        </ReactFlow>
      </div>
      {selectedNode && (
        <EntityDetailsPanel
          node={selectedNode}
          onClose={handleClosePanel}
        />
      )}
    </div>

    8. Add click-away behavior:
       - Add onPaneClick to ReactFlow that calls handleClosePanel
       - User can click empty canvas area to close panel
  </action>
  <verify>
    - Click a node - details panel opens on right
    - Panel shows all table details
    - Click X button - panel closes
    - Click empty canvas - panel closes
    - Edges visible with arrows pointing to referenced tables
  </verify>
  <done>
    Clicking nodes shows details panel, edges have arrows, panel closes on click-away or X
  </done>
</task>

<task type="auto">
  <name>Task 3: Final verification and polish</name>
  <files>
    - src/pages/EntityModel.jsx
    - src/components/schema/schemaTransform.js
  </files>
  <action>
    Final verification and minor polish:

    1. Verify all success criteria:
       - [ ] Entity Model page accessible from sidebar navigation (Product mode)
       - [ ] Page loads and displays schema graph on mount
       - [ ] Each table displays as a node with field list visible
       - [ ] Foreign key relationships display as connecting edges
       - [ ] User can pan and zoom the canvas
       - [ ] User can click entity node to view full details

    2. Add empty state handling:
       - If no tables returned, show friendly message
       - "No tables found in database schema"

    3. Node selection visual feedback:
       - Add selected prop to EntityNode based on selectedNode
       - When selected, add ring-2 ring-blue-500 class to node wrapper

    4. Update schemaTransform.js:
       - Add selected property to node data
       - In EntityModel, pass selected state to determine styling

    Alternative simpler approach for selection:
       - Use ReactFlow's built-in selection
       - Just change node border when selected using CSS

    5. Ensure fitView works well:
       - Add padding prop: fitView={{ padding: 0.2 }}
       - This prevents nodes from touching edges of canvas

    6. Test with actual data:
       - Start dev server: npm run dev
       - Navigate to Product mode > Entity Model
       - Verify all 36 tables visible
       - Click tasks table - verify columns, PK, FKs, indexes shown
       - Verify FK edges connect to referenced tables
  </action>
  <verify>
    - All 6 success criteria pass
    - Clicking node selects it visually
    - Empty state handled (though unlikely with 36 tables)
    - No console errors or warnings
    - Performance acceptable (no lag on pan/zoom)
  </verify>
  <done>
    v1.8 Entity Model Viewer complete - interactive schema visualization with pan, zoom, click-to-view
  </done>
</task>

</tasks>

<verification>
1. npm run dev - no build errors
2. Navigate to Product mode sidebar - "Entity Model" link visible
3. Click Entity Model - schema loads, nodes display
4. Visible edges connecting related tables (FK relationships)
5. Edge arrows point from FK table to referenced table
6. Click any node - details panel slides in from right
7. Details panel shows: Columns, Primary Key, Foreign Keys, Indexes, Constraints
8. Click X or empty canvas - panel closes
9. Pan canvas by dragging empty space
10. Zoom with mouse wheel or +/- controls
11. No console errors
</verification>

<success_criteria>
All Phase 33 requirements satisfied:
- NAV-01: Entity Model page accessible from sidebar navigation (Product mode)
- NAV-02: Page loads and displays schema graph on mount
- CANVAS-01: Entities display as nodes with field lists visible
- CANVAS-02: Foreign key relationships display as connecting edges
- CANVAS-03: User can pan and zoom the canvas
- CANVAS-04: User can click entity node to view details (fields, types, constraints)
</success_criteria>

<output>
After completion, create `.planning/phases/33-visual-canvas/33-02-SUMMARY.md`
</output>
