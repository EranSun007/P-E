---
phase: 20-knowledge-search-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/api/apiClient.js
  - src/pages/KnowledgeSearch.jsx
  - src/components/knowledge/CodeResultCard.jsx
  - src/components/knowledge/DocsResultCard.jsx
  - src/components/knowledge/LanguageDetector.js
  - src/pages/index.jsx
autonomous: true

must_haves:
  truths:
    - "User can enter a search query and see results"
    - "Code results appear in the left panel with syntax highlighting"
    - "Documentation results appear in the right panel"
    - "User can resize panels by dragging the handle"
    - "Page is accessible from main navigation"
  artifacts:
    - path: "src/api/apiClient.js"
      provides: "knowledge.searchCode, knowledge.searchDocs, knowledge.getStats methods"
      contains: "knowledge:"
    - path: "src/pages/KnowledgeSearch.jsx"
      provides: "Knowledge search page with dual-pane layout"
      min_lines: 150
    - path: "src/components/knowledge/CodeResultCard.jsx"
      provides: "Code result display with syntax highlighting"
      min_lines: 50
    - path: "src/components/knowledge/DocsResultCard.jsx"
      provides: "Documentation result display"
      min_lines: 30
  key_links:
    - from: "src/pages/KnowledgeSearch.jsx"
      to: "/api/knowledge/search/code"
      via: "apiClient.knowledge.searchCode"
      pattern: "apiClient\\.knowledge\\.searchCode"
    - from: "src/components/knowledge/CodeResultCard.jsx"
      to: "react-syntax-highlighter"
      via: "SyntaxHighlighter import"
      pattern: "from.*react-syntax-highlighter"
---

<objective>
Create the Knowledge Search page with dual-pane results display and syntax highlighting for code

Purpose: Enable users to search the MCP knowledge base for code and documentation, displaying results in a professional split-pane interface with proper code highlighting.
Output: Working search page accessible from navigation, API client integration, code highlighting for search results
</objective>

<execution_context>
@/Users/i306072/.claude/get-shit-done/workflows/execute-plan.md
@/Users/i306072/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-knowledge-search-ui/20-RESEARCH.md
@.planning/phases/19-mcp-client-backend/19-02-SUMMARY.md

# Existing patterns to follow
@src/pages/BugDashboard.jsx
@src/components/ui/resizable.jsx
@src/api/apiClient.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install react-syntax-highlighter and add knowledge API client methods</name>
  <files>
    src/api/apiClient.js
    package.json
  </files>
  <action>
1. Install react-syntax-highlighter:
   ```bash
   npm install react-syntax-highlighter --save
   npm install @types/react-syntax-highlighter --save-dev
   ```

2. Add knowledge client methods to apiClient.js. Add a new `knowledge` section following the `bugs` and `github` patterns:

```javascript
// Knowledge Base API (v1.5 - MCP integration)
knowledge: {
  // Semantic code search
  async searchCode(options) {
    return fetchWithAuth(`${API_BASE_URL}/knowledge/search/code`, {
      method: 'POST',
      body: JSON.stringify({
        query: options.query,
        limit: options.limit || 20,
        threshold: options.threshold,
        repoName: options.repoName,
        language: options.language,
        artifactType: options.artifactType,
        ownership: options.ownership,
      }),
    });
  },

  // Documentation search
  async searchDocs(options) {
    return fetchWithAuth(`${API_BASE_URL}/knowledge/search/docs`, {
      method: 'POST',
      body: JSON.stringify({
        query: options.query,
        limit: options.limit || 20,
        threshold: options.threshold,
        domain: options.domain,
        category: options.category,
      }),
    });
  },

  // Get repository statistics
  async getStats(options = {}) {
    const params = new URLSearchParams();
    if (options.repoName) params.append('repoName', options.repoName);
    if (options.statsType) params.append('statsType', options.statsType);
    const queryString = params.toString();
    return fetchWithAuth(`${API_BASE_URL}/knowledge/stats${queryString ? '?' + queryString : ''}`);
  },

  // Health check
  async getHealth() {
    return fetchWithAuth(`${API_BASE_URL}/knowledge/health`);
  },
},
```

Place this after the `emailPreferences` section and before the closing brace of apiClient export.
  </action>
  <verify>
1. Run `npm ls react-syntax-highlighter` - should show installed version
2. Check apiClient.js has `knowledge:` section with searchCode, searchDocs, getStats, getHealth methods
3. Run `npm run lint` - no errors
  </verify>
  <done>
- react-syntax-highlighter installed
- apiClient.knowledge.searchCode, searchDocs, getStats, getHealth methods added
- Linting passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Create KnowledgeSearch page with dual-pane layout and result cards</name>
  <files>
    src/pages/KnowledgeSearch.jsx
    src/components/knowledge/CodeResultCard.jsx
    src/components/knowledge/DocsResultCard.jsx
    src/components/knowledge/LanguageDetector.js
  </files>
  <action>
1. Create src/components/knowledge/ directory

2. Create LanguageDetector.js utility:
```javascript
// src/components/knowledge/LanguageDetector.js

/**
 * Detect programming language from MCP server response or file path
 * Priority: server language > file extension > plaintext fallback
 */
export function detectLanguage(serverLanguage, filePath) {
  // Trust server-provided language first
  if (serverLanguage && typeof serverLanguage === 'string') {
    return normalizeLanguageName(serverLanguage.toLowerCase());
  }

  // Fallback to file extension
  const extension = filePath?.split('.').pop()?.toLowerCase();
  if (extension) {
    return extensionToLanguage(extension);
  }

  return 'plaintext';
}

function normalizeLanguageName(lang) {
  const aliases = {
    'js': 'javascript',
    'ts': 'typescript',
    'py': 'python',
  };
  return aliases[lang] || lang;
}

function extensionToLanguage(ext) {
  const mapping = {
    'js': 'javascript',
    'jsx': 'javascript',
    'mjs': 'javascript',
    'ts': 'typescript',
    'tsx': 'typescript',
    'py': 'python',
    'java': 'java',
    'go': 'go',
    'rs': 'rust',
    'rb': 'ruby',
    'html': 'html',
    'css': 'css',
    'scss': 'scss',
    'json': 'json',
    'yaml': 'yaml',
    'yml': 'yaml',
    'xml': 'xml',
    'sql': 'sql',
    'md': 'markdown',
    'sh': 'bash',
    'bash': 'bash',
  };
  return mapping[ext] || 'plaintext';
}

export const SUPPORTED_LANGUAGES = [
  'javascript', 'typescript', 'python', 'java', 'go',
  'rust', 'html', 'css', 'json', 'yaml', 'markdown', 'bash'
];
```

3. Create CodeResultCard.jsx with syntax highlighting:
```jsx
// src/components/knowledge/CodeResultCard.jsx
import { Light as SyntaxHighlighter } from 'react-syntax-highlighter';
import { docco } from 'react-syntax-highlighter/dist/esm/styles/hljs';
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { Code, FileCode } from 'lucide-react';
import { detectLanguage } from './LanguageDetector';

// Register only needed languages (bundle optimization)
import javascript from 'react-syntax-highlighter/dist/esm/languages/hljs/javascript';
import typescript from 'react-syntax-highlighter/dist/esm/languages/hljs/typescript';
import python from 'react-syntax-highlighter/dist/esm/languages/hljs/python';
import java from 'react-syntax-highlighter/dist/esm/languages/hljs/java';
import go from 'react-syntax-highlighter/dist/esm/languages/hljs/go';
import json from 'react-syntax-highlighter/dist/esm/languages/hljs/json';
import yaml from 'react-syntax-highlighter/dist/esm/languages/hljs/yaml';
import bash from 'react-syntax-highlighter/dist/esm/languages/hljs/bash';

SyntaxHighlighter.registerLanguage('javascript', javascript);
SyntaxHighlighter.registerLanguage('typescript', typescript);
SyntaxHighlighter.registerLanguage('python', python);
SyntaxHighlighter.registerLanguage('java', java);
SyntaxHighlighter.registerLanguage('go', go);
SyntaxHighlighter.registerLanguage('json', json);
SyntaxHighlighter.registerLanguage('yaml', yaml);
SyntaxHighlighter.registerLanguage('bash', bash);

export function CodeResultCard({ result }) {
  const language = detectLanguage(result.language, result.filePath || result.file_path);
  const filePath = result.filePath || result.file_path || 'unknown';
  const code = result.code || result.content || '';
  const repoName = result.repoName || result.repo_name || '';

  return (
    <Card className="mb-4">
      <CardHeader className="py-3 px-4">
        <div className="flex items-center justify-between gap-2">
          <div className="flex items-center gap-2 min-w-0">
            <FileCode className="h-4 w-4 flex-shrink-0 text-muted-foreground" />
            <code className="text-sm truncate">{filePath}</code>
          </div>
          <div className="flex items-center gap-2 flex-shrink-0">
            {repoName && (
              <Badge variant="outline" className="text-xs">
                {repoName}
              </Badge>
            )}
            <Badge variant="secondary" className="text-xs">
              {language}
            </Badge>
          </div>
        </div>
      </CardHeader>
      <CardContent className="pt-0 px-4 pb-4">
        <SyntaxHighlighter
          language={language}
          style={docco}
          showLineNumbers={true}
          wrapLines={true}
          customStyle={{
            margin: 0,
            borderRadius: '0.5rem',
            fontSize: '0.75rem',
            maxHeight: '300px',
            overflow: 'auto',
          }}
        >
          {code}
        </SyntaxHighlighter>
      </CardContent>
    </Card>
  );
}
```

4. Create DocsResultCard.jsx:
```jsx
// src/components/knowledge/DocsResultCard.jsx
import { Card, CardContent, CardHeader } from '@/components/ui/card';
import { Badge } from '@/components/ui/badge';
import { FileText, ExternalLink } from 'lucide-react';

export function DocsResultCard({ result }) {
  const title = result.title || result.name || 'Untitled';
  const content = result.content || result.summary || '';
  const domain = result.domain || '';
  const category = result.category || '';
  const url = result.url || result.source_url || '';

  return (
    <Card className="mb-4">
      <CardHeader className="py-3 px-4">
        <div className="flex items-center justify-between gap-2">
          <div className="flex items-center gap-2 min-w-0">
            <FileText className="h-4 w-4 flex-shrink-0 text-muted-foreground" />
            <span className="font-medium truncate">{title}</span>
          </div>
          <div className="flex items-center gap-2 flex-shrink-0">
            {domain && (
              <Badge variant="outline" className="text-xs">
                {domain}
              </Badge>
            )}
            {category && (
              <Badge variant="secondary" className="text-xs">
                {category}
              </Badge>
            )}
          </div>
        </div>
      </CardHeader>
      <CardContent className="pt-0 px-4 pb-4">
        <p className="text-sm text-muted-foreground line-clamp-4">
          {content}
        </p>
        {url && (
          <a
            href={url}
            target="_blank"
            rel="noopener noreferrer"
            className="inline-flex items-center gap-1 mt-2 text-xs text-primary hover:underline"
          >
            <ExternalLink className="h-3 w-3" />
            View source
          </a>
        )}
      </CardContent>
    </Card>
  );
}
```

5. Create KnowledgeSearch.jsx page:
```jsx
// src/pages/KnowledgeSearch.jsx
import { useState, useCallback } from 'react';
import { Input } from '@/components/ui/input';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { ScrollArea } from '@/components/ui/scroll-area';
import {
  ResizablePanelGroup,
  ResizablePanel,
  ResizableHandle,
} from '@/components/ui/resizable';
import { Search, Code, FileText, Loader2, AlertCircle } from 'lucide-react';
import { apiClient } from '@/api/apiClient';
import { CodeResultCard } from '@/components/knowledge/CodeResultCard';
import { DocsResultCard } from '@/components/knowledge/DocsResultCard';

const KnowledgeSearch = () => {
  // Search state
  const [query, setQuery] = useState('');
  const [codeResults, setCodeResults] = useState([]);
  const [docsResults, setDocsResults] = useState([]);

  // UI state
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [hasSearched, setHasSearched] = useState(false);

  const handleSearch = useCallback(async () => {
    if (!query.trim()) return;

    setLoading(true);
    setError(null);
    setHasSearched(true);

    try {
      // Search code and docs in parallel
      const [codeResponse, docsResponse] = await Promise.all([
        apiClient.knowledge.searchCode({ query: query.trim(), limit: 20 }),
        apiClient.knowledge.searchDocs({ query: query.trim(), limit: 20 }),
      ]);

      setCodeResults(codeResponse.results || codeResponse || []);
      setDocsResults(docsResponse.results || docsResponse || []);
    } catch (err) {
      console.error('Search failed:', err);
      setError(err.message || 'Search failed. Please try again.');
    } finally {
      setLoading(false);
    }
  }, [query]);

  const handleKeyDown = (e) => {
    if (e.key === 'Enter') {
      handleSearch();
    }
  };

  return (
    <div className="h-full flex flex-col">
      {/* Header with search bar */}
      <div className="p-4 border-b bg-background">
        <div className="flex items-center gap-4 max-w-4xl mx-auto">
          <div className="relative flex-1">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground" />
            <Input
              type="text"
              placeholder="Search code and documentation..."
              value={query}
              onChange={(e) => setQuery(e.target.value)}
              onKeyDown={handleKeyDown}
              className="pl-10"
            />
          </div>
          <Button onClick={handleSearch} disabled={loading || !query.trim()}>
            {loading ? (
              <Loader2 className="h-4 w-4 animate-spin" />
            ) : (
              <>
                <Search className="h-4 w-4 mr-2" />
                Search
              </>
            )}
          </Button>
        </div>
      </div>

      {/* Error display */}
      {error && (
        <div className="p-4 bg-destructive/10 border-b border-destructive/20">
          <div className="flex items-center gap-2 text-destructive max-w-4xl mx-auto">
            <AlertCircle className="h-4 w-4" />
            <span className="text-sm">{error}</span>
          </div>
        </div>
      )}

      {/* Results area */}
      <div className="flex-1 min-h-0">
        {!hasSearched ? (
          <div className="h-full flex items-center justify-center text-muted-foreground">
            <div className="text-center">
              <Search className="h-12 w-12 mx-auto mb-4 opacity-50" />
              <p>Enter a query to search code and documentation</p>
            </div>
          </div>
        ) : loading ? (
          <div className="h-full flex items-center justify-center">
            <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
          </div>
        ) : (
          <ResizablePanelGroup direction="horizontal" className="h-full">
            {/* Code Results Panel */}
            <ResizablePanel defaultSize={50} minSize={25}>
              <div className="h-full flex flex-col">
                <div className="p-4 border-b bg-muted/30">
                  <div className="flex items-center gap-2">
                    <Code className="h-4 w-4" />
                    <h2 className="font-semibold">Code Results</h2>
                    <span className="text-sm text-muted-foreground">
                      ({codeResults.length})
                    </span>
                  </div>
                </div>
                <ScrollArea className="flex-1 p-4">
                  {codeResults.length === 0 ? (
                    <div className="text-center text-muted-foreground py-8">
                      <Code className="h-8 w-8 mx-auto mb-2 opacity-50" />
                      <p className="text-sm">No code results found</p>
                    </div>
                  ) : (
                    codeResults.map((result, index) => (
                      <CodeResultCard key={result.id || index} result={result} />
                    ))
                  )}
                </ScrollArea>
              </div>
            </ResizablePanel>

            <ResizableHandle withHandle />

            {/* Documentation Results Panel */}
            <ResizablePanel defaultSize={50} minSize={25}>
              <div className="h-full flex flex-col">
                <div className="p-4 border-b bg-muted/30">
                  <div className="flex items-center gap-2">
                    <FileText className="h-4 w-4" />
                    <h2 className="font-semibold">Documentation</h2>
                    <span className="text-sm text-muted-foreground">
                      ({docsResults.length})
                    </span>
                  </div>
                </div>
                <ScrollArea className="flex-1 p-4">
                  {docsResults.length === 0 ? (
                    <div className="text-center text-muted-foreground py-8">
                      <FileText className="h-8 w-8 mx-auto mb-2 opacity-50" />
                      <p className="text-sm">No documentation found</p>
                    </div>
                  ) : (
                    docsResults.map((result, index) => (
                      <DocsResultCard key={result.id || index} result={result} />
                    ))
                  )}
                </ScrollArea>
              </div>
            </ResizablePanel>
          </ResizablePanelGroup>
        )}
      </div>
    </div>
  );
};

export default KnowledgeSearch;
```

Key patterns followed:
- Uses existing Resizable components from shadcn/ui
- Light build of react-syntax-highlighter with selective language registration
- Error and loading states like BugDashboard
- Parallel API calls for code and docs search
- Empty state handling for both panels
  </action>
  <verify>
1. Files exist:
   - src/pages/KnowledgeSearch.jsx
   - src/components/knowledge/CodeResultCard.jsx
   - src/components/knowledge/DocsResultCard.jsx
   - src/components/knowledge/LanguageDetector.js
2. Run `npm run lint` - no errors
3. Run `npm run build:client` - builds without errors
  </verify>
  <done>
- KnowledgeSearch page created with dual-pane layout
- CodeResultCard displays code with syntax highlighting
- DocsResultCard displays documentation results
- LanguageDetector utility maps languages correctly
- Empty states handled for both panels
  </done>
</task>

<task type="auto">
  <name>Task 3: Add routing and navigation entry</name>
  <files>
    src/pages/index.jsx
  </files>
  <action>
1. Open src/pages/index.jsx and find the dynamic route imports

2. Add KnowledgeSearch to the routes. The file uses dynamic imports - add the entry following the existing pattern:

Look for the routes array or dynamic import structure and add:
```javascript
// In the pages object or routes configuration
KnowledgeSearch: () => import('./KnowledgeSearch'),
```

Or if using a different pattern, follow the existing structure to add:
- Route path: '/knowledge-search' or '/knowledge'
- Component: KnowledgeSearch (lazy loaded)

3. Add navigation entry. Look for where nav items are defined (likely in a Sidebar or Layout component) and add:
```javascript
{
  name: 'Knowledge Search',
  path: '/knowledge-search',
  icon: Search, // or BookOpen from lucide-react
}
```

The exact location and format will depend on how navigation is structured. Follow the pattern used for other pages like 'BugDashboard' or 'GitHubRepos'.
  </action>
  <verify>
1. Run `npm run dev` and navigate to /knowledge-search - page loads
2. Check navigation sidebar - Knowledge Search entry appears
3. Run `npm run build:client` - builds without errors
  </verify>
  <done>
- KnowledgeSearch route added at /knowledge-search
- Navigation entry added to sidebar
- Page accessible from navigation menu
  </done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `npm run lint` passes
2. `npm run build:client` succeeds
3. Navigate to /knowledge-search - page loads with search input
4. Enter a search query and click Search - API calls made to /api/knowledge/search/code and /api/knowledge/search/docs
5. Results display in dual-pane layout (code left, docs right)
6. Code results have syntax highlighting with language badge
7. Panels can be resized by dragging the handle
8. Empty states display when no results
</verification>

<success_criteria>
- User can access Knowledge Search page from navigation
- User can enter search query and trigger search
- Code and documentation results display in separate panels
- Code results have syntax highlighting
- Panels are resizable
- Loading and error states work correctly
- Requirements SEARCH-01, SEARCH-02, SEARCH-03 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/20-knowledge-search-ui/20-01-SUMMARY.md`
</output>
