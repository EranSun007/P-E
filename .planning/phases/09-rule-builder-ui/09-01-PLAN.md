---
phase: 09-rule-builder-ui
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/api/apiClient.js
  - src/api/entities.js
  - src/pages/CaptureRules.jsx
  - src/components/capture/RuleBuilderDialog.jsx
  - src/pages/index.jsx
  - src/pages/Layout.jsx
autonomous: true

must_haves:
  truths:
    - "User can see list of existing capture rules"
    - "User can create a new rule with URL pattern"
    - "User can define CSS selectors with field names and types"
    - "User can enable/disable rules without deleting them"
    - "User can edit and delete existing rules"
  artifacts:
    - path: "src/api/apiClient.js"
      provides: "CaptureRule API client with standard CRUD"
      contains: "createEntityClient('/capture-rules')"
    - path: "src/api/entities.js"
      provides: "CaptureRule export for components"
      exports: ["CaptureRule"]
    - path: "src/pages/CaptureRules.jsx"
      provides: "Rule list page with table, enable toggle, CRUD actions"
      min_lines: 150
    - path: "src/components/capture/RuleBuilderDialog.jsx"
      provides: "Dialog form for create/edit rule with dynamic selector array"
      min_lines: 200
  key_links:
    - from: "src/pages/CaptureRules.jsx"
      to: "@/api/entities"
      via: "import { CaptureRule }"
      pattern: "import.*CaptureRule.*from.*entities"
    - from: "src/pages/CaptureRules.jsx"
      to: "RuleBuilderDialog"
      via: "import and render"
      pattern: "RuleBuilderDialog"
    - from: "src/pages/Layout.jsx"
      to: "CaptureRules"
      via: "navigation entry"
      pattern: "CaptureRules"
---

<objective>
Create the Capture Rules management page with Dialog-based CRUD for rule creation and editing

Purpose: Enable users to create, view, edit, and delete capture rules through a web interface (RULE-01, RULE-02, RULE-03, RULE-04)
Output: CaptureRules page with rule list, RuleBuilderDialog component, API client, routing, and navigation
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-rule-builder-ui/09-RESEARCH.md

# Key patterns to follow
@src/pages/Settings.jsx (Dialog CRUD pattern lines 55-265, 620-745)
@src/pages/CaptureInbox.jsx (capture page structure, table, filtering)
@src/api/apiClient.js (createEntityClient pattern)
@src/api/entities.js (entity export pattern)
@extension/content/generic-extractor.js (selector types: text, html, attribute, href, src)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add CaptureRule API client and entity export</name>
  <files>
    src/api/apiClient.js
    src/api/entities.js
  </files>
  <action>
    1. In apiClient.js, add CaptureRule to the entities object using createEntityClient:
       ```javascript
       CaptureRule: createEntityClient('/capture-rules'),
       ```
       Add this after the CaptureInbox entry (around line 388).

    2. In entities.js, add CaptureRule export following the CaptureInbox pattern:
       ```javascript
       export const CaptureRule = USE_API ? apiClient.entities.CaptureRule : {
         list: async () => { throw new Error('Capture rules not available in local mode'); },
         get: async () => { throw new Error('Capture rules not available in local mode'); },
         create: async () => { throw new Error('Capture rules not available in local mode'); },
         update: async () => { throw new Error('Capture rules not available in local mode'); },
         delete: async () => { throw new Error('Capture rules not available in local mode'); },
       };
       ```
       Add this after the CaptureInbox export block.
  </action>
  <verify>
    Run `grep -n "CaptureRule" src/api/apiClient.js src/api/entities.js` - should show entries in both files
  </verify>
  <done>
    CaptureRule API client exists and is exported from entities.js
  </done>
</task>

<task type="auto">
  <name>Task 2: Create RuleBuilderDialog component with dynamic selector array</name>
  <files>
    src/components/capture/RuleBuilderDialog.jsx
  </files>
  <action>
    Create the RuleBuilderDialog component following Settings.jsx dialog pattern and TaskCreationForm subtasks pattern for dynamic arrays.

    Component structure:
    ```jsx
    import { useState, useEffect } from "react";
    import { Plus, Trash2, Save, Loader2 } from "lucide-react";
    import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from "@/components/ui/dialog";
    import { Button } from "@/components/ui/button";
    import { Input } from "@/components/ui/input";
    import { Label } from "@/components/ui/label";
    import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select";
    import { Switch } from "@/components/ui/switch";
    import { Alert, AlertDescription } from "@/components/ui/alert";

    // Selector types from generic-extractor.js
    const SELECTOR_TYPES = [
      { value: 'text', label: 'Text Content' },
      { value: 'html', label: 'HTML' },
      { value: 'attribute', label: 'Attribute' },
      { value: 'href', label: 'Link (href)' },
      { value: 'src', label: 'Source (src)' },
    ];

    export default function RuleBuilderDialog({ open, onOpenChange, rule, onSave }) {
      // Form state
      const [formData, setFormData] = useState({...});
      const [selectors, setSelectors] = useState([]);
      const [newSelector, setNewSelector] = useState({...});
      const [saving, setSaving] = useState(false);
      const [error, setError] = useState(null);

      // Reset form when rule changes or dialog opens
      useEffect(() => {...}, [rule, open]);

      // Selector management functions
      const addSelector = () => {...};
      const removeSelector = (index) => {...};
      const updateSelector = (index, field, value) => {...};

      // Form handlers
      const handleInputChange = (field, value) => {...};
      const handleSubmit = async () => {...};

      return (
        <Dialog open={open} onOpenChange={onOpenChange}>
          <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
            {/* Header */}
            {/* Rule name and URL pattern inputs */}
            {/* Enabled toggle */}
            {/* Selectors section with dynamic array */}
            {/* Add new selector form */}
            {/* Footer with Cancel/Save buttons */}
          </DialogContent>
        </Dialog>
      );
    }
    ```

    Key implementation details:

    1. Form state initialization:
       - name: string (rule name)
       - url_pattern: string (glob pattern like *.grafana.sap/*)
       - enabled: boolean (default true)
       - selectors: array of {field_name, selector, type, attribute?, required?}

    2. Selectors array management (follow TaskCreationForm subtasks pattern):
       - addSelector: validate new selector has field_name and selector, then add to array
       - removeSelector: filter by index
       - updateSelector: map and update specific field at index

    3. New selector form with:
       - field_name input (e.g., "build_status")
       - CSS selector input (e.g., ".build-row .status")
       - type dropdown (text/html/attribute/href/src)
       - attribute input (shown only when type="attribute")
       - required checkbox
       - Add button

    4. Existing selectors displayed as rows with:
       - field_name, selector, type badge
       - attribute (if type=attribute)
       - required indicator
       - Remove button

    5. Validation before save:
       - name required
       - url_pattern required
       - at least one selector required

    6. onSave callback receives full rule data: { name, url_pattern, enabled, selectors }
  </action>
  <verify>
    File exists at src/components/capture/RuleBuilderDialog.jsx with correct imports and exports
  </verify>
  <done>
    RuleBuilderDialog renders form with name, URL pattern, enabled toggle, and dynamic selector array
  </done>
</task>

<task type="auto">
  <name>Task 3: Create CaptureRules page with list and CRUD operations</name>
  <files>
    src/pages/CaptureRules.jsx
    src/pages/index.jsx
    src/pages/Layout.jsx
  </files>
  <action>
    1. Create CaptureRules.jsx following CaptureInbox.jsx and Settings.jsx patterns:

    ```jsx
    import { useState, useEffect } from "react";
    import { CaptureRule } from "@/api/entities";
    import { format } from "date-fns";
    import { FileCode, Plus, RefreshCw, Search, Loader2, AlertTriangle, Globe, Power, PowerOff, Pencil, Trash2 } from "lucide-react";
    import { Card, CardContent, CardHeader, CardTitle, CardDescription } from "@/components/ui/card";
    import { Input } from "@/components/ui/input";
    import { Button } from "@/components/ui/button";
    import { Badge } from "@/components/ui/badge";
    import { Alert, AlertDescription } from "@/components/ui/alert";
    import { Switch } from "@/components/ui/switch";
    import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from "@/components/ui/table";
    import { Dialog, DialogContent, DialogDescription, DialogFooter, DialogHeader, DialogTitle } from "@/components/ui/dialog";
    import { EmptyState } from "@/components/ui/EmptyState";
    import RuleBuilderDialog from "@/components/capture/RuleBuilderDialog";

    export default function CaptureRulesPage() {
      // State: rules, loading, error, showDialog, editingRule, confirmDelete, search
      // Load rules on mount
      // Handlers: loadRules, handleCreate, handleEdit, handleSave, handleToggleEnabled, confirmDelete, handleDelete
      // Render: header with Add Rule button, search, rules table with actions
    }
    ```

    Page structure:
    - Header: Title "Capture Rules", description, Refresh and "Add Rule" buttons
    - Search bar
    - Rules table with columns: Name, URL Pattern, Selectors count, Status (Enabled/Disabled), Created, Actions
    - Actions per row: Enable/Disable toggle, Edit, Delete
    - RuleBuilderDialog for create/edit
    - Delete confirmation dialog

    Enable/disable toggle:
    ```jsx
    const handleToggleEnabled = async (rule) => {
      try {
        const updated = await CaptureRule.update(rule.id, { enabled: !rule.enabled });
        setRules(rules.map(r => r.id === rule.id ? updated : r));
      } catch (err) {
        setError("Failed to update rule");
      }
    };

    // In table row:
    <Switch
      checked={rule.enabled}
      onCheckedChange={() => handleToggleEnabled(rule)}
    />
    ```

    2. In src/pages/index.jsx, add CaptureRules to the pages object:
    ```javascript
    CaptureRules: () => import("./CaptureRules.jsx"),
    ```
    Add this after CaptureInbox entry.

    3. In src/pages/Layout.jsx, add navigation entry in peopleNavigation array (after Capture Inbox):
    ```javascript
    {
      name: "Capture Rules",
      icon: FileCode,
      href: createPageUrl("CaptureRules"),
      current: currentPageName === "CaptureRules"
    }
    ```
    Also add FileCode to the lucide-react imports at the top.
  </action>
  <verify>
    1. `npm run dev` starts without errors
    2. Navigate to /CaptureRules in browser - page renders
    3. "Capture Rules" appears in sidebar navigation
  </verify>
  <done>
    CaptureRules page shows rule list, enable/disable toggle works, create/edit/delete operations functional
  </done>
</task>

</tasks>

<verification>
1. Start dev server: `npm run dev`
2. Navigate to /CaptureRules
3. Click "Add Rule" - dialog opens
4. Fill form: name="Test Rule", url_pattern="*test*", add selector (field_name="title", selector="h1", type="text")
5. Click Save - rule appears in list
6. Toggle enable/disable - status changes
7. Click Edit - dialog opens with existing data
8. Click Delete - confirmation dialog, delete works
9. Search filters rules by name
</verification>

<success_criteria>
- CaptureRule API client works (list, create, update, delete)
- CaptureRules page renders with rule table
- RuleBuilderDialog allows creating rules with URL pattern and selectors
- Selectors array supports add/remove with field_name, selector, type
- Attribute field shows when type="attribute"
- Required checkbox available for selectors
- Enable/disable toggle updates rule.enabled
- Edit populates form with existing rule data
- Delete with confirmation works
- Navigation entry in sidebar
</success_criteria>

<output>
After completion, create `.planning/phases/09-rule-builder-ui/09-01-SUMMARY.md`
</output>
