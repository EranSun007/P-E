---
phase: 03-content-script
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - extension/manifest.json
  - extension/service-worker.js
  - extension/content/content.js
  - extension/content/observer.js
  - extension/content/utils.js
autonomous: true

must_haves:
  truths:
    - "Content script loads on jira.tools.sap pages"
    - "Page type (board/backlog/detail) is correctly detected from URL"
    - "SPA navigation triggers re-initialization of content script"
    - "MutationObserver watches for dynamic DOM changes"
    - "Sync throttle prevents excessive backend calls"
  artifacts:
    - path: "extension/manifest.json"
      provides: "content_scripts declaration and webNavigation permission"
      contains: "content_scripts"
    - path: "extension/content/content.js"
      provides: "Main content script entry point"
      exports: []
      min_lines: 80
    - path: "extension/content/observer.js"
      provides: "MutationObserver wrapper class"
      exports: ["ContentObserver"]
      min_lines: 40
    - path: "extension/content/utils.js"
      provides: "Page detection and utility functions"
      exports: ["PageType", "detectPageType", "debounce", "waitForElement"]
      min_lines: 50
  key_links:
    - from: "extension/manifest.json"
      to: "extension/content/content.js"
      via: "content_scripts declaration"
      pattern: "content/content\\.js"
    - from: "extension/service-worker.js"
      to: "extension/content/content.js"
      via: "webNavigation.onHistoryStateUpdated listener"
      pattern: "chrome\\.webNavigation\\.onHistoryStateUpdated"
    - from: "extension/content/content.js"
      to: "extension/service-worker.js"
      via: "chrome.runtime.sendMessage SYNC_ISSUES"
      pattern: "SYNC_ISSUES"
---

<objective>
Create content script foundation with page detection, MutationObserver pattern, and service worker integration for SPA navigation.

Purpose: Establish the infrastructure that content script extractors will use in Plan 02 to capture Jira issue data.
Output: Content script loads on Jira pages, detects page type, observes DOM changes, and communicates with service worker.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-content-script/03-RESEARCH.md

# Existing extension files (Phase 2 outputs)
@extension/manifest.json
@extension/service-worker.js
@extension/lib/storage.js
@extension/lib/api.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update manifest and create content script scaffold</name>
  <files>
    extension/manifest.json
    extension/content/content.js
    extension/content/utils.js
    extension/content/observer.js
  </files>
  <action>
Update extension/manifest.json to add:
1. `content_scripts` array with:
   - `matches`: ["https://jira.tools.sap/*"]
   - `js`: ["content/content.js"]
   - `run_at`: "document_idle"
   - `all_frames`: false
2. Add `webNavigation` to permissions array (after "storage", "activeTab")

Create extension/content/utils.js with:
1. PageType enum: { BOARD: 'board', BACKLOG: 'backlog', DETAIL: 'detail', UNKNOWN: 'unknown' }
2. `detectPageType(url)` function:
   - BOARD: path contains 'RapidBoard.jspa' AND has 'rapidView' param AND no 'view' param
   - BACKLOG: path contains 'RapidBoard.jspa' AND view=planning
   - DETAIL: path contains '/browse/' AND matches /[A-Z]+-\d+/
   - UNKNOWN: default
3. `debounce(fn, delay)` - standard debounce utility with clearTimeout
4. `waitForElement(selector, timeout=10000)` - polls every 100ms, returns element or null on timeout

Create extension/content/observer.js with ContentObserver class:
- Constructor accepts `onContentReady` callback
- `observe(targetSelector)` method:
  - Finds element by selector, returns false if not found
  - Creates MutationObserver watching {childList: true, subtree: true, attributes: false}
  - Debounces callback at 500ms
- `disconnect()` method - cleans up observer and clears timers
- Export as named export

Create extension/content/content.js scaffold:
- Import { PageType, detectPageType, waitForElement } from './utils.js'
- Import { ContentObserver } from './observer.js'
- State variables: currentPageType, observer, lastSyncTime, SYNC_THROTTLE_MS = 30000
- Placeholder extractors object: { board: null, backlog: null, detail: null }
- `shouldSync()` function checking 30s throttle
- `extractAndSync()` async function:
  - Gets extractor for currentPageType from extractors object
  - If no extractor, log and return (extractors added in Plan 02)
  - If extractor exists, call it to get issues array
  - If issues.length > 0 AND shouldSync(), send SYNC_ISSUES message
  - Update lastSyncTime on success
- `init()` async function:
  - Detect page type from window.location.href
  - If UNKNOWN, log and return
  - Set currentPageType
  - Log detected page type
  - Placeholder: will wait for content and set up observer once extractors exist
- Message listener for URL_CHANGED:
  - Disconnect existing observer if any
  - Call init()
- Message listener for REFRESH_DATA:
  - Reset lastSyncTime to 0 to bypass throttle
  - Call extractAndSync()
- Call init() on load
- Add console.log at top: '[PE-Jira] Content script loaded'

Note: Content script does NOT use ES modules (Chrome limitation). Use IIFE pattern to scope code. Do NOT use import/export - inline all dependencies or concatenate files.
  </action>
  <verify>
1. Check manifest.json has content_scripts and webNavigation permission
2. Verify content/utils.js exists with PageType and detectPageType
3. Verify content/observer.js exists with ContentObserver class
4. Verify content/content.js exists with init() and message handlers
5. Syntax check: Load extension in Chrome (chrome://extensions, Developer mode, Load unpacked)
  </verify>
  <done>
Content script files exist and extension loads without errors in Chrome.
Page type detection works for board, backlog, and detail URL patterns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add webNavigation SPA detection to service worker</name>
  <files>extension/service-worker.js</files>
  <action>
Add to extension/service-worker.js (after existing imports, before MessageType definition):

1. Add webNavigation listener for SPA navigation detection:
```javascript
// SPA navigation detection for Jira
// Notifies content script when URL changes via pushState/replaceState
chrome.webNavigation.onHistoryStateUpdated.addListener(
  (details) => {
    // Only care about main frame, not iframes
    if (details.frameId !== 0) return;

    console.log('[PE-Jira] SPA navigation detected:', details.url);

    // Notify content script to re-extract
    chrome.tabs.sendMessage(details.tabId, {
      type: 'URL_CHANGED',
      url: details.url
    }).catch(err => {
      // Content script may not be loaded yet, ignore
      console.log('[PE-Jira] Could not notify tab:', err.message);
    });
  },
  { url: [{ hostSuffix: 'jira.tools.sap' }] }
);
```

2. Add URL_CHANGED to MessageType enum (for documentation, not used in switch):
```javascript
URL_CHANGED: 'URL_CHANGED',  // Sent TO content script
```

This listener fires when Jira SPA navigates between views (board to backlog, sprint to sprint) without a full page reload. The content script receives URL_CHANGED and re-initializes extraction for the new page.
  </action>
  <verify>
1. service-worker.js includes webNavigation.onHistoryStateUpdated listener
2. Listener filters for jira.tools.sap host
3. Listener sends URL_CHANGED message to content script tab
4. Extension reloads without errors
  </verify>
  <done>
Service worker listens for SPA navigation and notifies content script.
URL_CHANGED messages sent when user navigates within Jira SPA.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integration test with live Jira</name>
  <files>None (verification only)</files>
  <action>
Create a manual test checklist and verify:

1. Load extension in Chrome:
   - Navigate to chrome://extensions
   - Enable Developer mode
   - Click "Load unpacked" and select extension/ directory
   - Verify extension loads without errors

2. Navigate to jira.tools.sap (any board):
   - Open Chrome DevTools (F12) on the Jira page
   - Check console for "[PE-Jira] Content script loaded"
   - Check console for "[PE-Jira] Page type: board" (or backlog/detail)

3. Test SPA navigation:
   - From board view, click to view backlog (view=planning)
   - Check console for "[PE-Jira] SPA navigation detected" from service worker
   - Check console for "[PE-Jira] URL changed" and new page type in content script

4. Test page type detection accuracy:
   - Board URL: /secure/RapidBoard.jspa?rapidView=12345 -> should detect 'board'
   - Backlog URL: /secure/RapidBoard.jspa?rapidView=12345&view=planning -> should detect 'backlog'
   - Issue URL: /browse/PROJ-123 -> should detect 'detail'

5. Check service worker background page:
   - In chrome://extensions, click "service worker" link for the extension
   - Verify SPA navigation logs appear when navigating Jira

Document any selector issues or unexpected behavior for Plan 02.
  </action>
  <verify>
All manual test steps pass:
- Content script loads on Jira pages
- Page type correctly detected for board, backlog, detail
- SPA navigation triggers re-initialization
- No console errors from extension
  </verify>
  <done>
Content script foundation verified working on live Jira instance.
Page detection and SPA navigation handling confirmed functional.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Extension loads in Chrome without manifest errors
2. Content script injects on jira.tools.sap/* pages
3. Console shows page type detection on load
4. SPA navigation (pushState) triggers URL_CHANGED message flow
5. Observer infrastructure ready for extractors in Plan 02
</verification>

<success_criteria>
- Content script activates on jira.tools.sap pages (REQ EXT-02 partial)
- Page type (board/backlog/detail) correctly detected from URL
- SPA navigation triggers content script re-initialization
- MutationObserver pattern established for dynamic content
- Sync throttle (30s) prevents excessive backend calls
- Service worker handles URL_CHANGED for SPA navigation
</success_criteria>

<output>
After completion, create `.planning/phases/03-content-script/03-01-SUMMARY.md`
</output>
