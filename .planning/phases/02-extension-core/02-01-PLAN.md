# Plan 02-01: Extension Manifest and Service Worker Scaffold

## Objective
Create the Chrome extension structure with Manifest V3 and a functional service worker that can receive and respond to messages.

## Requirements Covered
- EXT-01: Manifest V3 structure

## Success Criteria
- [ ] Extension loads in Chrome without errors
- [ ] Service worker activates on extension install
- [ ] Service worker responds to test messages
- [ ] Extension icon visible in Chrome toolbar

## Wave
1 (must complete before 02-02)

## Tasks

### Task 1: Create Extension Directory Structure
Create `extension/` directory at project root with proper folder structure.

**Files to create:**
```
extension/
├── manifest.json
├── service-worker.js
├── popup/
│   ├── popup.html
│   └── popup.js
├── options/
│   ├── options.html
│   └── options.js
└── icons/
    └── (placeholder for icons)
```

### Task 2: Create manifest.json
Manifest V3 configuration for Chrome extension.

**File:** `extension/manifest.json`

```json
{
  "manifest_version": 3,
  "name": "P&E Manager Jira Sync",
  "version": "1.0.0",
  "description": "Sync Jira board data to P&E Manager",

  "permissions": [
    "storage",
    "activeTab"
  ],

  "host_permissions": [
    "https://jira.tools.sap/*",
    "https://pe-manager-backend.cfapps.eu01-canary.hana.ondemand.com/*",
    "http://localhost:3001/*"
  ],

  "background": {
    "service_worker": "service-worker.js",
    "type": "module"
  },

  "action": {
    "default_popup": "popup/popup.html",
    "default_title": "P&E Jira Sync"
  },

  "options_page": "options/options.html",

  "icons": {
    "16": "icons/icon16.png",
    "48": "icons/icon48.png",
    "128": "icons/icon128.png"
  }
}
```

**Key decisions:**
- `type: "module"` enables ES modules in service worker
- `host_permissions` for Jira (Phase 3) and backend
- `storage` permission for chrome.storage.local
- No `content_scripts` yet (added in Phase 3)

### Task 3: Create Service Worker
Basic service worker with message handling and lifecycle logging.

**File:** `extension/service-worker.js`

```javascript
/**
 * P&E Manager Jira Sync - Service Worker
 *
 * Handles:
 * - Message routing from popup and content scripts
 * - Backend API communication
 * - Sync state management
 */

// Message types
const MessageType = {
  SYNC_ISSUES: 'SYNC_ISSUES',
  GET_STATUS: 'GET_STATUS',
  MANUAL_SYNC: 'MANUAL_SYNC',
  TEST_CONNECTION: 'TEST_CONNECTION'
};

// Service worker lifecycle
chrome.runtime.onInstalled.addListener((details) => {
  console.log('[PE-Jira] Extension installed:', details.reason);

  // Initialize default storage on fresh install
  if (details.reason === 'install') {
    chrome.storage.local.set({
      backendUrl: 'https://pe-manager-backend.cfapps.eu01-canary.hana.ondemand.com',
      authToken: '',
      lastSync: {
        timestamp: null,
        status: 'never',
        issueCount: 0,
        error: null
      },
      pendingIssues: []
    });
  }
});

// Message handler
chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
  console.log('[PE-Jira] Received message:', message.type, 'from:', sender.id ? 'extension' : sender.tab?.url);

  // Must return true for async response
  handleMessage(message, sender)
    .then(response => sendResponse(response))
    .catch(error => sendResponse({ success: false, error: error.message }));

  return true; // Keep channel open for async response
});

/**
 * Route messages to appropriate handlers
 */
async function handleMessage(message, sender) {
  switch (message.type) {
    case MessageType.GET_STATUS:
      return await getStatus();

    case MessageType.TEST_CONNECTION:
      return await testConnection();

    case MessageType.SYNC_ISSUES:
      return await syncIssues(message.payload);

    case MessageType.MANUAL_SYNC:
      return await manualSync();

    default:
      return { success: false, error: `Unknown message type: ${message.type}` };
  }
}

/**
 * Get current sync status from storage
 */
async function getStatus() {
  const data = await chrome.storage.local.get(['lastSync', 'authToken', 'backendUrl']);
  return {
    success: true,
    data: {
      lastSync: data.lastSync,
      isConfigured: Boolean(data.authToken && data.backendUrl)
    }
  };
}

/**
 * Test connection to backend
 */
async function testConnection() {
  const { backendUrl, authToken } = await chrome.storage.local.get(['backendUrl', 'authToken']);

  if (!backendUrl || !authToken) {
    return { success: false, error: 'Backend URL or auth token not configured' };
  }

  try {
    const response = await fetch(`${backendUrl}/api/health`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${authToken}`
      }
    });

    if (response.ok) {
      return { success: true, data: await response.json() };
    } else {
      return { success: false, error: `Backend returned ${response.status}` };
    }
  } catch (error) {
    return { success: false, error: error.message };
  }
}

/**
 * Sync issues to backend (placeholder - full implementation in 02-02)
 */
async function syncIssues(issues) {
  console.log('[PE-Jira] syncIssues called with', issues?.length || 0, 'issues');
  return { success: true, message: 'Sync not yet implemented' };
}

/**
 * Manual sync trigger (placeholder - full implementation in 02-02)
 */
async function manualSync() {
  console.log('[PE-Jira] manualSync called');
  return { success: true, message: 'Manual sync not yet implemented' };
}

console.log('[PE-Jira] Service worker loaded');
```

### Task 4: Create Minimal Popup
Basic popup UI to verify extension works.

**File:** `extension/popup/popup.html`

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    body {
      width: 300px;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-size: 14px;
    }
    h1 {
      font-size: 16px;
      margin: 0 0 12px 0;
    }
    .status {
      padding: 8px;
      border-radius: 4px;
      margin-bottom: 12px;
    }
    .status.loading { background: #f0f0f0; }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.warning { background: #fff3cd; color: #856404; }
    button {
      width: 100%;
      padding: 8px 16px;
      margin-top: 8px;
      cursor: pointer;
    }
    .info {
      font-size: 12px;
      color: #666;
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <h1>P&E Jira Sync</h1>

  <div id="status" class="status loading">Loading...</div>

  <button id="testBtn">Test Connection</button>
  <button id="optionsBtn">Settings</button>

  <div class="info" id="info"></div>

  <script src="popup.js"></script>
</body>
</html>
```

**File:** `extension/popup/popup.js`

```javascript
/**
 * Popup script - communicates with service worker
 */

const statusEl = document.getElementById('status');
const infoEl = document.getElementById('info');
const testBtn = document.getElementById('testBtn');
const optionsBtn = document.getElementById('optionsBtn');

// Load status on popup open
document.addEventListener('DOMContentLoaded', async () => {
  await loadStatus();
});

async function loadStatus() {
  try {
    const response = await chrome.runtime.sendMessage({ type: 'GET_STATUS' });

    if (response.success) {
      const { lastSync, isConfigured } = response.data;

      if (!isConfigured) {
        statusEl.className = 'status warning';
        statusEl.textContent = 'Not configured';
        infoEl.textContent = 'Click Settings to configure backend URL and auth token';
      } else if (lastSync.status === 'never') {
        statusEl.className = 'status warning';
        statusEl.textContent = 'Never synced';
        infoEl.textContent = 'Browse to a Jira board to start syncing';
      } else if (lastSync.status === 'success') {
        statusEl.className = 'status success';
        statusEl.textContent = `Last sync: ${formatTime(lastSync.timestamp)}`;
        infoEl.textContent = `${lastSync.issueCount} issues synced`;
      } else if (lastSync.status === 'error') {
        statusEl.className = 'status error';
        statusEl.textContent = 'Sync failed';
        infoEl.textContent = lastSync.error || 'Unknown error';
      }
    } else {
      showError(response.error);
    }
  } catch (error) {
    showError(error.message);
  }
}

testBtn.addEventListener('click', async () => {
  statusEl.className = 'status loading';
  statusEl.textContent = 'Testing...';

  try {
    const response = await chrome.runtime.sendMessage({ type: 'TEST_CONNECTION' });

    if (response.success) {
      statusEl.className = 'status success';
      statusEl.textContent = 'Connection successful!';
      infoEl.textContent = `Backend: ${response.data?.environment || 'connected'}`;
    } else {
      statusEl.className = 'status error';
      statusEl.textContent = 'Connection failed';
      infoEl.textContent = response.error;
    }
  } catch (error) {
    showError(error.message);
  }
});

optionsBtn.addEventListener('click', () => {
  chrome.runtime.openOptionsPage();
});

function showError(message) {
  statusEl.className = 'status error';
  statusEl.textContent = 'Error';
  infoEl.textContent = message;
}

function formatTime(timestamp) {
  if (!timestamp) return 'Never';
  const date = new Date(timestamp);
  return date.toLocaleTimeString();
}
```

### Task 5: Create Minimal Options Page
Basic options page for configuration.

**File:** `extension/options/options.html`

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style>
    body {
      max-width: 600px;
      margin: 40px auto;
      padding: 20px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    h1 { margin-bottom: 24px; }
    .field {
      margin-bottom: 16px;
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 14px;
      box-sizing: border-box;
    }
    textarea {
      height: 60px;
      font-family: monospace;
    }
    .help {
      font-size: 12px;
      color: #666;
      margin-top: 4px;
    }
    button {
      padding: 10px 20px;
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover { background: #0055aa; }
    .message {
      margin-top: 16px;
      padding: 12px;
      border-radius: 4px;
    }
    .message.success { background: #d4edda; color: #155724; }
    .message.error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <h1>P&E Jira Sync Settings</h1>

  <div class="field">
    <label for="backendUrl">Backend URL</label>
    <input type="url" id="backendUrl" placeholder="https://pe-manager-backend.cfapps.eu01-canary.hana.ondemand.com">
    <div class="help">The P&E Manager backend server URL</div>
  </div>

  <div class="field">
    <label for="authToken">Auth Token</label>
    <textarea id="authToken" placeholder="Paste your JWT token here"></textarea>
    <div class="help">Get this from P&E Manager Settings page (future feature)</div>
  </div>

  <button id="saveBtn">Save Settings</button>

  <div id="message" class="message" style="display: none;"></div>

  <script src="options.js"></script>
</body>
</html>
```

**File:** `extension/options/options.js`

```javascript
/**
 * Options page script - manages extension settings
 */

const backendUrlInput = document.getElementById('backendUrl');
const authTokenInput = document.getElementById('authToken');
const saveBtn = document.getElementById('saveBtn');
const messageEl = document.getElementById('message');

// Load saved settings on page load
document.addEventListener('DOMContentLoaded', async () => {
  const data = await chrome.storage.local.get(['backendUrl', 'authToken']);
  backendUrlInput.value = data.backendUrl || '';
  authTokenInput.value = data.authToken || '';
});

// Save settings
saveBtn.addEventListener('click', async () => {
  const backendUrl = backendUrlInput.value.trim();
  const authToken = authTokenInput.value.trim();

  // Basic validation
  if (!backendUrl) {
    showMessage('Backend URL is required', 'error');
    return;
  }

  try {
    new URL(backendUrl); // Validate URL format
  } catch {
    showMessage('Invalid Backend URL format', 'error');
    return;
  }

  // Save to storage
  await chrome.storage.local.set({ backendUrl, authToken });
  showMessage('Settings saved!', 'success');
});

function showMessage(text, type) {
  messageEl.textContent = text;
  messageEl.className = `message ${type}`;
  messageEl.style.display = 'block';

  setTimeout(() => {
    messageEl.style.display = 'none';
  }, 3000);
}
```

### Task 6: Create Placeholder Icons
Create simple placeholder icons (colored squares) so extension can load.

**Files:**
- `extension/icons/icon16.png` (16x16 placeholder)
- `extension/icons/icon48.png` (48x48 placeholder)
- `extension/icons/icon128.png` (128x128 placeholder)

For MVP, use solid color PNG files. Can be replaced with proper icons later.

## Verification Steps

1. Load extension in Chrome:
   - Go to `chrome://extensions`
   - Enable "Developer mode"
   - Click "Load unpacked"
   - Select the `extension/` directory

2. Verify no errors in extension card

3. Click extension icon → popup should open

4. Check service worker console (click "service worker" link on extension card)
   - Should see "[PE-Jira] Service worker loaded"

5. Click "Test Connection" in popup
   - Should show "Connection failed" (no auth configured yet)

6. Open Settings, enter a URL, save
   - Should show "Settings saved!"

## Files Changed

| File | Action |
|------|--------|
| extension/manifest.json | Create |
| extension/service-worker.js | Create |
| extension/popup/popup.html | Create |
| extension/popup/popup.js | Create |
| extension/options/options.html | Create |
| extension/options/options.js | Create |
| extension/icons/icon16.png | Create |
| extension/icons/icon48.png | Create |
| extension/icons/icon128.png | Create |

## Estimated Duration
3-5 minutes
